<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Getting Started With Lapis - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Mar  8 20:35:45 2024" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.16.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Getting Started With Lapis</h2>
            <ul><li><a href="#basic-setup">Basic Setup</a></li>
<li><a href="#creating-an-application">Creating An Application</a></li>
<ul><li><a href="#creating-an-application/lapis-command-line-tool"><code>lapis</code> Command Line Tool</a></li>
<li><a href="#creating-an-application/nginx-configuration">Nginx Configuration</a></li></ul>
<li><a href="#starting-the-server">Starting The Server</a></li>
<li><a href="#creating-an-application">Creating An Application</a></li></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Getting Started With Lapis</h1>

<p><a href="http://leafo.net/lapis/">Lapis</a> is a web framework written for Lua and
MoonScript. Lapis is designed with performance in mind so by default it runs
configured for the Nginx distribution OpenResty. Your web application is run
directly inside of Nginx. Nginx&rsquo;s event loop lets you make asynchronous HTTP
requests, database queries and other requests using the modules provided with
OpenResty. Lua&rsquo;s coroutines allow you to write synchronous looking code that is
event driven behind the scenes.</p>

<p>The web framework comes with a environment based configuration, URL routing,
HTML templating, CSRF and session support, a relational database object
relational mapper for working with models and a handful of other useful
functions needed for developing websites and more</p>

<p>This introduction guide functions as both a tutorial and a reference.</p>

<h2><a name="basic-setup" href="#basic-setup">Basic Setup</a></h2>

<p>Lapis is easiest to use within a system with <a href="https://luarocks.org">LuaRocks</a>
installed. LuaRocks is the most common package manager for Lua.</p>

<p>The first step is to install Lapis via LuaRocks:</p>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">luarocks</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">install</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span></code>
</pre>


<blockquote><p>OpenResty is designed for LuaJIT which targets Lua 5.1.  If you plan to only
use OpenResty, then in order to ensure that OpenResty is able to load Lapis
within its own runtime you will want to install Lapis targetting Lua 5.1. You
can use the <code>--lua-version=5.1</code> flag with LuaRocks to accomplish this.</p></blockquote>

<h2><a name="creating-an-application" href="#creating-an-application">Creating An Application</a></h2>

<h3><a name="creating-an-application/lapis-command-line-tool" href="#creating-an-application/lapis-command-line-tool"><code>lapis</code> Command Line Tool</a></h3>

<p>Lapis comes with a command line tool to help you create new projects and start
the server. To see what Lapis can do, run in your shell:</p>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">help</span></code>
</pre>


<p>The <code>lapis new</code> command can be used to start a new project. First run <code>lapis
help new</code> to learn more about the command line arguments the command can use.</p>

<p>For simplicity, in this guide we'll generate a new app with all the defaults.
Navigate to an empty directory where you want to keep your project and run the
following:</p>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace">  </span><span class="sh_identifier">lapis</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">new</span><span class="sh_bash_whitespace sh_whitespace">

</span><span class="sh_identifier">wrote</span><span class="sh_bash_whitespace sh_whitespace">  </span><span class="sh_identifier">nginx</span><span class="sh_operator">.</span><span class="sh_identifier">conf</span><span class="sh_bash_whitespace sh_whitespace">
</span><span class="sh_identifier">wrote</span><span class="sh_bash_whitespace sh_whitespace">  </span><span class="sh_identifier">mime</span><span class="sh_operator">.</span><span class="sh_identifier">types</span><span class="sh_bash_whitespace sh_whitespace">
</span><span class="sh_identifier">wrote</span><span class="sh_bash_whitespace sh_whitespace">  </span><span class="sh_identifier">app</span><span class="sh_operator">.</span><span class="sh_identifier">lua</span><span class="sh_bash_whitespace sh_whitespace">
</span><span class="sh_identifier">wrote</span><span class="sh_bash_whitespace sh_whitespace">  </span><span class="sh_identifier">config</span><span class="sh_operator">.</span><span class="sh_identifier">lua</span></code>
</pre>


<p>If you wish to continue this guide without OpenResty, you can run <code>lapis new
--cqueues</code>.</p>

<p>When generating a new project for OpenResty, a basic Nginx configuration and a
blank Lapis application are written.</p>

<p>Here&rsquo;s a brief overview of the default <code>nginx.conf</code></p>

<ul>
<li>Any requests inside <code>/static/</code> will serve files out of the directory
<code>static</code> (You can create this directory now if you want)</li>
<li>A request to <code>/favicon.ico</code> is read from <code>static/favicon.ico</code></li>
<li>All other requests will be served by Lua, more specifically a module named <code>"app"</code></li>
</ul>


<p>When you start the server using the <code>lapis server</code> command the <code>nginx.conf</code>
file is processed and templated variables are filled with values from the
configuration generated by the environment. This is discussed in more detail
further on.</p>

<h3><a name="creating-an-application/nginx-configuration" href="#creating-an-application/nginx-configuration">Nginx Configuration</a></h3>

<p>Let&rsquo;s take a closer look at the Nginx configuration that <code>lapis new</code> has given
us.  Although it&rsquo;s not necessary to look at this immediately, it&rsquo;s important to
understand when building more advanced applications or even just deploying your
application to production.</p>

<p>Here is the <code>nginx.conf</code> that has been generated:</p>

<pre class="highlight lang_nginx"><code><span class="sh_function">worker_processes</span><span class="sh_default"> </span><span class="sh_variable sh_label">${{NUM_WORKERS}};</span><span class="sh_default">
</span><span class="sh_function">error_log</span><span class="sh_default"> stderr notice;
</span><span class="sh_function">daemon</span><span class="sh_default"> </span><span class="sh_keyword">off</span><span class="sh_default">;
</span><span class="sh_function">pid</span><span class="sh_string"> logs/nginx.pid</span><span class="sh_default">;

</span><span class="sh_keyword">events</span><span class="sh_default"> {
  </span><span class="sh_function">worker_connections</span><span class="sh_default"> </span><span class="sh_number">1024</span><span class="sh_default">;
}

</span><span class="sh_keyword">http</span><span class="sh_default"> {
  </span><span class="sh_function">include</span><span class="sh_string"> mime.types</span><span class="sh_default">;

  </span><span class="sh_keyword">server</span><span class="sh_default"> {
    </span><span class="sh_function">listen</span><span class="sh_default"> </span><span class="sh_variable sh_label">${{PORT}};</span><span class="sh_default">
    </span><span class="sh_function">lua_code_cache</span><span class="sh_default"> </span><span class="sh_variable sh_label">${{CODE_CACHE}};</span><span class="sh_default">

    </span><span class="sh_keyword">location</span><span class="sh_string"> /</span><span class="sh_default"> {
      </span><span class="sh_function">default_type</span><span class="sh_default"> text/html;
      </span><span class="sh_function">content_by_lua</span><span class="sh_default"> </span><span class="sh_string">&#x27;
        require(&quot;lapis&quot;).serve(&quot;app&quot;)
      &#x27;</span><span class="sh_default">;
    }

    </span><span class="sh_keyword">location</span><span class="sh_string"> /static/</span><span class="sh_default"> {
      </span><span class="sh_function">alias</span><span class="sh_string"> static/</span><span class="sh_default">;
    }

    </span><span class="sh_keyword">location</span><span class="sh_string"> /favicon.ico</span><span class="sh_default"> {
      </span><span class="sh_function">alias</span><span class="sh_string"> static/favicon.ico</span><span class="sh_default">;
    }
  }
}</span></code>
</pre>


<p>The first thing to notice is that this is not a normal Nginx configuration
file. Special <code>${{VARIABLE}}</code> syntax is used by Lapis to inject environment
settings before starting the server.</p>

<p>There are a couple interesting things provided by the default configuration.
<code>error_log stderr notice</code> and <code>daemon off</code> lets our server run in the
foreground, and print log text to the console. This is great for development,
but worth turning off in a production environment.</p>

<p><code>lua_code_cache</code> is also another setting useful for development. When set to
<code>off</code> it causes all Lua modules to be reloaded on each request. Modifications to
the web application&rsquo;s source code can then be reloaded automatically. In a
production environment the cache should be enabled (<code>on</code>) for optimal performance.
Defaults to <code>off</code>.</p>

<p>The <code>content_by_lua</code> directive specifies a chunk of Lua code that will handle
any request that doesn&rsquo;t match the other locations. It loads Lapis and tells it
to serve the module named <code>"app"</code>. The <code>lapis new</code> command ran earlier provides
a skeleton <code>app</code> module to get started with</p>

<h2><a name="starting-the-server" href="#starting-the-server">Starting The Server</a></h2>

<p>Although it&rsquo;s possible to start Nginx manually, Lapis wraps building the
configuration and starting the server into a single convenient command.</p>

<p>Running <code>lapis server</code> in the shell will start the server. Lapis will
attempt to find your OpenResty installation. It will search the following
directories for an <code>nginx</code> binary. (The last one represents anything in your
<code>PATH</code>)</p>

<pre><code>"/usr/local/openresty/nginx/sbin/"
"/usr/local/opt/openresty/bin/"
"/usr/sbin/"
""
</code></pre>

<blockquote><p>Remember that you need OpenResty and not a normal installation of Nginx.
Lapis will ignore regular Nginx binaries.</p></blockquote>

<p>If you've been following along, go ahead and start the server to see what it
looks like:</p>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">server</span></code>
</pre>


<p>The default configuration puts the server in the foreground, use <code>CTRL+C</code> to
stop the server.</p>

<p>If the server is running in the background it can be stopped with the command
<code>lapis term</code>. It must be run in the root directory of the application.  This
command looks for the PID file for a running server and sends a <code>TERM</code> message
to that process if it exists.</p>

<h2><a name="creating-an-application" href="#creating-an-application">Creating An Application</a></h2>

<p>Now that you know how to generate a new project and start and stop the server
you're ready to start writing application code. This guide splits into two for
Lua &amp; MoonScript MoonScript and Lua.</p>

<ul>
<li><a href="lua_getting_started.html">Create an application with Lua</a></li>
<li><a href="moon_getting_started.html">Create an application with MoonScript</a></li>
</ul>


      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Mar  8 20:35:45 2024"></script>
  <script type="text/javascript" src="../reference.js?Fri Mar  8 20:35:45 2024"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
