<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Requests and Actions - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Oct  6 22:56:40 2023" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.15.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Requests and Actions</h2>
            <ul><li><a href="#routes-and-url-patterns">Routes &amp; URL Patterns</a></li>
<ul><li><a href="#routes-and-url-patterns/optional-route-components">Optional route components</a></li>
<li><a href="#routes-and-url-patterns/parameter-character-classes">Parameter character classes</a></li>
<li><a href="#routes-and-url-patterns/route-precedence">Route precedence</a></li></ul>
<li><a href="#named-routes">Named Routes</a></li>
<li><a href="#handling-http-verbs">Handling HTTP verbs</a></li>
<li><a href="#before-filters">Before Filters</a></li>
<li><a href="#request-object">Request Object</a></li>
<ul><li><a href="#request-object/request.req"><code>request.req</code></a></li>
<li><a href="#request-object/cookies">Cookies</a></li>
<li><a href="#request-object/session">Session</a></li></ul>
<li><a href="#request-parameters">Request Parameters</a></li>
<ul><li><a href="#request-parameters/boolean-parameters">Boolean parameters</a></li>
<li><a href="#request-parameters/nested-parameters">Nested Parameters</a></li>
<li><a href="#request-parameters/parameters-types-and-limits">Parameters Types &amp; Limits</a></li></ul>
<li><a href="#request-object-methods">Request Object Methods</a></li>
<ul><li><a href="#request-object-methods/request:write"><code>request:write(things...)</code></a></li>
<li><a href="#request-object-methods/request:url_for"><code>request:url_for(name_or_obj, params, query_params=nil, ...)</code></a></li>
<ul><li><a href="#request-object-methods/request:url_for/passing-an-object-to-url-for">Passing an object to <code>url_for</code></a></li>
<li><a href="#request-object-methods/request:url_for/using-the-url-key-method">Using the <code>url_key</code> method</a></li></ul>
<li><a href="#request-object-methods/request:build_url"><code>request:build_url(path, [options])</code></a></li>
<li><a href="#request-object-methods/request:flow"><code>request:flow(module_name)</code></a></li>
<li><a href="#request-object-methods/request:html"><code>request:html(fn)</code></a></li>
<li><a href="#request-object-methods/request:get_request"><code>request:get_request()</code></a></li></ul>
<li><a href="#render-options">Render Options</a></li>
<li><a href="#application-configuration">Application Configuration</a></li>
<ul><li><a href="#application-configuration/application.layout"><code>application.layout</code></a></li>
<li><a href="#application-configuration/application.error_page"><code>application.error_page</code></a></li>
<li><a href="#application-configuration/application.views_prefix"><code>application.views_prefix</code></a></li>
<li><a href="#application-configuration/application.actions_prefix"><code>application.actions_prefix</code></a></li>
<li><a href="#application-configuration/application.flows_prefix"><code>application.flows_prefix</code></a></li>
<li><a href="#application-configuration/application.Request"><code>application.Request</code></a></li>
<li><a href="#application-configuration/callbacks">Callbacks</a></li>
<ul><li><a href="#application-configuration/callbacks/application:default_route"><code>application:default_route()</code></a></li>
<li><a href="#application-configuration/callbacks/application:handle_404"><code>application:handle_404()</code></a></li>
<li><a href="#application-configuration/callbacks/application:handle_error"><code>application:handle_error(err, trace)</code></a></li></ul></ul>
<li><a href="#application-methods">Application Methods</a></li>
<ul><li><a href="#application-methods/application:match"><code>application:match([route_name], route_patch, action_fn)</code></a></li>
<li><a href="#application-methods/application:get"><code>application:get(...)</code></a></li>
<li><a href="#application-methods/application:post"><code>application:post(...)</code></a></li>
<li><a href="#application-methods/application:delete"><code>application:delete(...)</code></a></li>
<li><a href="#application-methods/application:put"><code>application:put(...)</code></a></li>
<li><a href="#application-methods/application:enable"><code>application:enable(feature)</code></a></li>
<li><a href="#application-methods/application:before_filter"><code>application:before_filter(fn)</code></a></li>
<li><a href="#application-methods/application:include"><code>application:include(other_app, opts={})</code></a></li>
<li><a href="#application-methods/application:find_action"><code>application:find_action(name, resolve=true)</code></a></li>
<li><a href="#application-methods/Application:extend"><code>Application:extend([name], fields={}, [init_fn])</code></a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Requests and Actions</h1>

<p>Every HTTP request that is handled by Lapis follows the same basic flow after
being handed off from processing server. The first step is routing. The path of
an incoming request is matched against the routes defined in your application
to look up the corresponding <em>action function</em>. An action is a regular
Lua/MoonScript function that will be called if the associated route matches.</p>

<p>An <em>action function</em> is invoked with one argument, a <a href="#request-object"><em>request
object</em></a>, when processing a request. The request object is
where you'll store all the data you want to share between your actions and
views. Additionally, the request object is your interface to the webserver on
how the result is sent to the client.</p>

<p>The return value of the action is used to control how the output is rendered. A
string return value will be rendered to the browser directly. A table return
value will be used as the <a href="#render-options"><em>render options</em></a>. If there is more
than one return value, all of them are merged into the final result. You can
return both strings and tables to control the output.</p>

<p>If there is no route that matches the request then the default route handler is
executed, read more in <a href="#application-configuration/callbacks"><em>application
callbacks</em></a>.</p>

<h2><a name="routes-and-url-patterns" href="#routes-and-url-patterns">Routes &amp; URL Patterns</a></h2>

<p>Route patterns use a special syntax to define dynamic parameters of the URL and
assign a name to them. The simplest routes have no parameters though:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/users/all&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/users/all&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span></code>
</pre>
</div>

</p>

<p>These routes match the URLs verbatim. The leading <code>/</code> is required. The route
must match the entire path of the request. That means a request to
<code>/hello/world</code> will not match the route <code>/hello</code>.</p>

<p>You can specify a named parameter with a <code>:</code> followed immediately by the name.
The parameter will match all characters excluding <code>/</code> (in the general case):</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/page/:page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">page</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/post/:post_id/:post_name&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/page/:page&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">page</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/post/:post_id/:post_name&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span></code>
</pre>
</div>

</p>

<blockquote><p>In the example above we called <code>print</code> to debug. When running inside
OpenResty, the output of <code>print</code> is sent to the Nginx notice log.</p></blockquote>

<p>The captured values of the route parameters are saved in the <code>params</code> field of
the request object by their name. A named parameter must contain at least 1
character, and will fail to match otherwise.</p>

<p>A splat is another kind of pattern that will match as much as it can, including
any <code>/</code> characters.  The splat is stored in a <code>splat</code>  named parameter in the
<code>params</code> table of the request object. It&rsquo;s just a single <code>*</code></p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/browse/*&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">splat</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/user/:name/file/*&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">name</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">splat</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/browse/*&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">splat</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_string">&quot;/user/:name/file/*&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">name</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">splat</span></code>
</pre>
</div>

</p>

<p>If you put any text directly after the splat or the named parameter it will not
be included in the named parameter. For example you can match URLs that end in
<code>.zip</code> with <code>/files/:filename.zip</code></p>

<h3><a name="routes-and-url-patterns/optional-route-components" href="#routes-and-url-patterns/optional-route-components">Optional route components</a></h3>

<p>Parentheses can be used to make a section of the route optional:</p>

<pre><code>/projects/:username(/:project)
</code></pre>

<p>The above would match either <code>/projects/leafo</code>  or <code>/projects/leafo/lapis</code>. Any
parameters within optional components that don&rsquo;t match will have a value of
<code>nil</code> from within the action.</p>

<p>These optional components can be nested and chained as much as you like:</p>

<pre><code>/settings(/:username(/:page))(.:format)
</code></pre>

<h3><a name="routes-and-url-patterns/parameter-character-classes" href="#routes-and-url-patterns/parameter-character-classes">Parameter character classes</a></h3>

<p>A character class can be applied to a named parameter to restrict what
characters can match. The syntax modeled after Lua&rsquo;s pattern character classes.
This route will make sure the that <code>user_id</code> named parameter only contains
digits:</p>

<pre><code>/user/:user_id[%d]/posts
</code></pre>

<p>And this route would only match hexadecimal strings for the <code>hex</code> parameter.</p>

<pre><code>/color/:hex[a-fA-F%d]
</code></pre>

<h3><a name="routes-and-url-patterns/route-precedence" href="#routes-and-url-patterns/route-precedence">Route precedence</a></h3>

<p>Routes are searched first by precedence, then by the order they were defined.
Route precedence from highest to lowest is:</p>

<ul>
<li>Literal routes <code>/hello/world</code></li>
<li>Variable routes <code>/hello/:variable</code>

<ul>
<li>Each additional <code>:variable</code> will decrease the precedence of the route</li>
</ul>
</li>
<li>Splat routes routes <code>/hello/*</code>

<ul>
<li>Each additional splat will <em>increase</em> the precedence of the route. Given the routes <code>/hello/*spat</code> and <code>/hello/*splat/world/*rest</code>, the second one will be checked before the first.</li>
</ul>
</li>
</ul>


<h2><a name="named-routes" href="#named-routes">Named Routes</a></h2>

<p>It&rsquo;s useful to give names to your routes so links to other pages can be
generated just by knowing the name of the page instead of hard-coding the
structure of the URL.</p>

<p><span class="for_moon">If the route of the action is a table with a single
pair, then the key of that table is the name and the value is the pattern.
MoonScript gives us convenient syntax for representing this:</span><span
class="for_lua">Every method on the application that defines a new route has a
second form that takes the name of the route as the first argument:</span></p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_profile&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leaf&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_profile&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/user/:name&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;, go home: &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">index:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_profile&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leaf&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">user_profile:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/user/:name&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;Hello #{@params.name}, go home: #{@url_for &quot;</span><span class="sh_identifier">index</span><span class="sh_string">&quot;}&quot;</span></code>
</pre>
</div>

</p>

<p>We can generate the paths to various actions using <span
class="for_moon"><code>@url_for</code></span><span
class="for_lua"><code>self:url_for()</code></span>. The first argument is the name of the
route, and the second optional argument is a table of values to fill a
parameterized route with.</p>

<p><a href="#request-object-methods/url_for">Read more about <code>url_for</code></a> to see the
different ways to generate URLs to pages.</p>

<h2><a name="handling-http-verbs" href="#handling-http-verbs">Handling HTTP verbs</a></h2>

<p>It&rsquo;s common to have a single action do different things depending on the HTTP
verb. Lapis comes with some helpers to make writing these actions simple.
<code>respond_to</code> takes a table indexed by HTTP verb with a value of the function to
perform when the action receives that verb.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">respond_to</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;create_account&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/create-account&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">GET</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">POST</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">do_something</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">redirect_to</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}))</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">create_account:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/create-account&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">GET:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_tbl_key sh_regex">POST:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">do_something</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">redirect_to:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;index&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>
</div>

</p>

<p><code>respond_to</code> can also take a before filter of its own that will run before the
corresponding HTTP verb action. We do this by specifying a <code>before</code> function.
The same semantics of <a href="#before-filters">before filters</a> apply, so if you call
<span class="for_moon"><code>@write</code></span><span
class="for_lua"><code>self:write()</code></span> then the rest of the action will not get
run.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">respond_to</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;edit_user&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/edit-user/:id&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">before</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Users</span><span class="sh_operator">:</span><span class="sh_identifier">find</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">id</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">not</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">write</span><span class="sh_operator">({</span><span class="sh_string">&quot;Not Found&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">404</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">GET</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Edit account &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_operator">.</span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">POST</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_operator">:</span><span class="sh_identifier">update</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">redirect_to</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}))</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/edit_user/:id&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">before:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_self_ref sh_label">@user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_operator">\</span><span class="sh_identifier">find</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">id</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_self_ref sh_label">@write</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">status:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">404</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Not Found&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">unless</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@user</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_tbl_key sh_regex">GET:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_string">&quot;Edit account #{@user.name}...&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_tbl_key sh_regex">POST:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_self_ref sh_label">@user</span><span class="sh_operator">\</span><span class="sh_identifier">update</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">redirect_to:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;index&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>
</div>

</p>

<p>On any <code>POST</code> request, regardless of whether <code>respond_to</code> is used or not, if
the <code>Content-type</code> header is set to <code>application/x-www-form-urlencoded</code> then
the body of the request will be parsed and all the parameters will be placed
into <span class="for_moon"><code>@params</code></span><span
class="for_lua"><code>self.params</code></span>.</p>

<p><span class="for_lua">You may have also seen the <code>app:get()</code> and <code>app:post()</code>
methods being called in previous examples. These are wrappers around
<code>respond_to</code> that let you quickly define an action for a particular HTTP verb.
You'll find these wrappers for the most common verbs: <code>get</code>, <code>post</code>, <code>delete</code>,
<code>put</code>. For any others you'll need to use <code>respond_to</code>.</span></p>

<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">get</span><span class="sh_operator">(</span><span class="sh_string">&quot;/test&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;I only render for GET requests&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">delete</span><span class="sh_operator">(</span><span class="sh_string">&quot;/delete-account&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- do something destructive</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span></code>
</pre>


<h2><a name="before-filters" href="#before-filters">Before Filters</a></h2>

<p>Sometimes you want a piece of code to run before every action. A good example
of this is setting up the user session. We can declare a before filter, or a
function that runs before every action, like so:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">before_filter</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">session</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">current_user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">load_user</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">session</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;current user is: &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">tostring</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">current_user</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_self_ref sh_label">@before_filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@session</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_self_ref sh_label">@current_user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">load_user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@session</span><span class="sh_operator">.</span><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;current user is: #{@current_user}&quot;</span></code>
</pre>
</div>

</p>

<p>You are free to add as many as you like by calling <span
class="for_moon"><code>@before_filter</code></span><span
class="for_lua"><code>app:before_filter</code></span> multiple times. They will be run in
the order they are registered.</p>

<p>If a before filter calls the <span class="for_moon"><code>@write</code></span><span
class="for_lua"><code>self:write()</code></span> method then the action will be cancelled.
For example we can cancel the action and redirect to another page if some
condition is not met:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">before_filter</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">not</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user_meets_requirements</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">write</span><span class="sh_operator">({</span><span class="sh_identifier">redirect_to</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;login&quot;</span><span class="sh_operator">)})</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;login&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/login&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- ...</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_self_ref sh_label">@before_filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_keyword">unless</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">user_meets_requirements</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_self_ref sh_label">@write</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">redirect_to:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;login&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">login:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/login&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">...</span></code>
</pre>
</div>

</p>

<blockquote><p><span class="for_moon"><code>@write</code></span><span
class="for_lua"><code>self:write()</code></span> is what processes the return value of a
regular action, so the same things you can return in an action can be passed
to <span class="for_moon"><code>@write</code></span><span
class="for_lua"><code>self:write()</code></span></p></blockquote>

<h2><a name="request-object" href="#request-object">Request Object</a></h2>

<p>When a request is processed, the action function is passed a <code>request object</code>
as its first argument. Because of Lua&rsquo;s convention to call the first argument
<code>self</code>, we refer to the request object as <code>self</code> when in the context of an
action.</p>

<p>The request object contains the following fields:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td></tr></thead><tbody><tr><td><code class="for_moon">@route_name</code><code class="for_lua">self.route_name</code></td><td><p>The name of the route that was matched during routing, if available</p>
<details class="option_example"><summary>Show Example</summary><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/my-page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">assert</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">route_name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">==</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_page&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_page&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/my-page&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_function">assert</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@route_name</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">==</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_page&quot;</span></code>
</pre>
</div>

</details></td></tr><tr><td><code class="for_moon">@params</code><code class="for_lua">self.params</code></td><td><p>A table containing all request parameters merged together, including query parameters and form-encoded parameters from the body of the request. See <a href="#request_parameters">Request Parameters</a> for more details.</p>
</td></tr><tr><td><code class="for_moon">@GET</code><code class="for_lua">self.GET</code></td><td><p>A table containing only the query parameters included in the URL (eg. <code>?hello=world</code>). Note that this field is included for any request with URL query parameters, regardless of the HTTP verb used for the request.</p>
</td></tr><tr><td><code class="for_moon">@POST</code><code class="for_lua">self.POST</code></td><td><p>A table containing only the form encoded parameters included in the body of the request. Note that this field is included for any request with form data in the body, regardless of the HTTP verb.</p>
</td></tr><tr><td><code class="for_moon">@req</code><code class="for_lua">self.req</code></td><td><p>An object containing the internal request information generated by the underlying server processing the request. The full structure of this object is intentionally undocumented. Only resort to referencing it if you need server specific data not available elsewhere.</p>
</td></tr><tr><td><code class="for_moon">@res</code><code class="for_lua">self.res</code></td><td><p>An object used to used to generate the response for the client at the end of the request. The structure of this object is specific to the underlying server processing the request, and is intentionally undocumented.</p>
</td></tr><tr><td><code class="for_moon">@app</code><code class="for_lua">self.app</code></td><td><p>The instance of the <code>lapis.Application</code> that is responding to requests. Note that a single instance is shared across many requests, but there may be multiple instances if there are multiple worker processes handling requests.</p>
</td></tr><tr><td><code class="for_moon">@cookies</code><code class="for_lua">self.cookies</code></td><td><p>A proxy table that can be used to read any cookies that have been included with the request. New cookies can be stored for the response  by setting them on this table. Only strings are supported as field names and values. See <a href="#request-object/cookies">Cookies</a> for more information.</p>
<details class="option_example"><summary>Show Example</summary><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">cookies</span><span class="sh_operator">.</span><span class="sh_identifier">last_seen</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">cookies</span><span class="sh_operator">.</span><span class="sh_identifier">current_date</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">tostring</span><span class="sh_operator">(</span><span class="sh_library sh_type">os.time</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@cookies</span><span class="sh_operator">.</span><span class="sh_identifier">last_seen</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_self_ref sh_label">@cookies</span><span class="sh_operator">.</span><span class="sh_identifier">current_date</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">tostring</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_library sh_type">os.time</span></code>
</pre>
</div>

</details></td></tr><tr><td><code class="for_moon">@session</code><code class="for_lua">self.session</code></td><td><p>A proxy table for reading and writing the dynamically created session object. A session object is a signed, json-encoded object that is transferred via cookies. Because it is signed, it&rsquo;s safe to include data in it that you know the end user can not tamper with. See <a href="#request-object/session">Session</a> for more information.</p>
</td></tr><tr><td><code class="for_moon">@options</code><code class="for_lua">self.options</code></td><td><p>A table of options that will controls how the request is rendered. It is populated by calls to <code>write</code>, and also set by the return value of your action. See <a href="#render-options">Render Options</a> for more information.</p>
</td></tr><tr><td><code class="for_moon">@buffer</code><code class="for_lua">self.buffer</code></td><td><p>The output buffer containing the fragments of text that will be written to the client after all processing is complete. Typically you'll not need to touch this manually. It is populated via the <code>write</code> method.</p>
</td></tr></tbody></table></p>

<h3><a name="request-object/request.req" href="#request-object/request.req"><code>request.req</code></a></h3>

<p>The raw request table <code class="for_moon">@req</code><code class="for_lua">self.req</code> contains data from the request provided
by the underlying server. The format of this data may be server specific, but
generally will contain the following common fields:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td></tr></thead><tbody><tr><td><code class="for_moon">@req.headers</code><code class="for_lua">self.req.headers</code></td><td><p>Request headers table</p>
</td></tr><tr><td><code class="for_moon">@req.parsed_url</code><code class="for_lua">self.req.parsed_url</code></td><td><p>A table generated containing all the components of the requesting URL. Contains fields like <code>scheme</code>, <code>path</code>, <code>host</code>, <code>port</code>, and <code>query</code></p>
</td></tr><tr><td><code class="for_moon">@req.params_get</code><code class="for_lua">self.req.params_get</code></td><td><p>Unprocessed table of parameters from the query string of the requesting URL</p>
</td></tr><tr><td><code class="for_moon">@req.params_post</code><code class="for_lua">self.req.params_post</code></td><td><p>Unprocessed table of parameters from the body of the request</p>
</td></tr></tbody></table></p>

<h3><a name="request-object/cookies" href="#request-object/cookies">Cookies</a></h3>

<p>The <code class="for_moon">@cookies</code><code class="for_lua">self.cookies</code> table in the request lets you read and write cookies.</p>

<p>The cookies object, <code class="for_moon">@cookies</code><code class="for_lua">self.cookies</code>, is a proxy object. It supports
reading existing cookies by indexing the object by name, and writing new
cookies by writing them to the table. When iterating, the cookies object will
always appear as an empty table. The initial cookies are stored in the
<code>__index</code> of the metatable.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/reads-cookie&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">cookies</span><span class="sh_operator">.</span><span class="sh_identifier">foo</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/sets-cookie&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">cookies</span><span class="sh_operator">.</span><span class="sh_identifier">foo</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;bar&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/reads-cookie&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@cookies</span><span class="sh_operator">.</span><span class="sh_identifier">foo</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_string">&quot;/sets-cookie&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_self_ref sh_label">@cookies</span><span class="sh_operator">.</span><span class="sh_identifier">foo</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;bar&quot;</span></code>
</pre>
</div>

</p>

<p>All new cookies created are given the default attributes <code>Path=/; HttpOnly</code>
(know as a <a href="http://en.wikipedia.org/wiki/HTTP_cookie#Terminology"><em>session
cookie</em></a>). You can
configure a cookie&rsquo;s settings by overriding the the <code>cookie_attributes</code> method
on your application. Here&rsquo;s an example that adds an expiration date to cookies
to make them persist:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">date</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;date&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">.</span><span class="sh_identifier">cookie_attributes</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">expires</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">date</span><span class="sh_operator">(</span><span class="sh_keyword">true</span><span class="sh_operator">):</span><span class="sh_identifier">adddays</span><span class="sh_operator">(</span><span class="sh_number">365</span><span class="sh_operator">):</span><span class="sh_identifier">fmt</span><span class="sh_operator">(</span><span class="sh_string">&quot;${http}&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Expires=&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">expires</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;; Path=/; HttpOnly&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">date</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;date&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">cookie_attributes:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">name</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">value</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">expires</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">date</span><span class="sh_symbol sh_embedded">(</span><span class="sh_keyword">true</span><span class="sh_symbol sh_embedded">)</span><span class="sh_operator">\</span><span class="sh_identifier">adddays</span><span class="sh_symbol sh_embedded">(</span><span class="sh_number">365</span><span class="sh_symbol sh_embedded">)</span><span class="sh_operator">\</span><span class="sh_identifier">fmt</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;${http}&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;Expires=#{expires}; Path=/; HttpOnly&quot;</span></code>
</pre>
</div>

</p>

<p>The <code>cookie_attributes</code> method takes the request object as the first argument
(<code>self</code>) and then the name and value of the cookie being processed.</p>

<h3><a name="request-object/session" href="#request-object/session">Session</a></h3>

<p>The <code class="for_moon">@session</code><code class="for_lua">self.session</code> is a more advanced way to persist data over requests.
The content of the session is serialized to JSON and stored in a specially
named cookie. The serialized cookie is also signed with your application secret
so it can&rsquo;t be tampered with. Because it&rsquo;s serialized with JSON you can store
nested tables and other primitive values.</p>

<p>The session object, <code class="for_moon">@session</code><code class="for_lua">self.session</code>, is a proxy object. It supports
reading values by indexing the object, and writing new session fields by
writing to the table. When iterating, the session object will always appear as
an empty table.</p>

<p>The session object can be manipulated the same way as the cookies object:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">.</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">not</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">session</span><span class="sh_operator">.</span><span class="sh_identifier">current_user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">session</span><span class="sh_operator">.</span><span class="sh_identifier">current_user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Adam&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_keyword">unless</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@session</span><span class="sh_operator">.</span><span class="sh_identifier">current_user</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_self_ref sh_label">@session</span><span class="sh_operator">.</span><span class="sh_identifier">current_user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Adam&quot;</span></code>
</pre>
</div>

</p>

<p>By default the session is stored in a cookie called <code>lapis_session</code>. You can
overwrite the name of the session using the <code>session_name</code> <a href="configuration.html">configuration
variable</a>. Sessions are signed with your
application secret, which is stored in the configuration value <code>secret</code>. It is
highly recommended to change this from the default.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_comment">-- config.lua</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">config</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">config</span><span class="sh_operator">(</span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">session_name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_app_session&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">secret</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;this is my secret string 123456&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_comment">-- config.moon</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">session_name</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_app_session&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">secret</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;this is my secret string 123456&quot;</span></code>
</pre>
</div>

</p>

<h2><a name="request-parameters" href="#request-parameters">Request Parameters</a></h2>

<p>The request object contains several fields that facilitate access to
user-supplied parameters sent with the request. These parameters are
automatically loaded from the following sources:</p>

<ul>
<li>URL parameters &ndash; These are created when using a route that has a named variable. For instance, a route <code>/users/:id</code> will create a parameter named <code>id</code>.</li>
<li>Body parameters &ndash; For request methods that support a body, such as <code>POST</code> and <code>PUT</code>, the body will be automatically parsed if the content type is <code>application/x-www-form-urlencoded</code> or <code>multipart/form-data</code>.</li>
<li>Query parameters &ndash; These are parameters included at the end of a request URL following the <code>?</code>. For example, <code>/users?filter=blue</code> will create a parameter called <code>filter</code> with the value <code>"blue"</code>.</li>
</ul>


<p>The <code class="for_moon">@params</code><code class="for_lua">self.params</code> object is a combination of all the default loaded
parameters listed above. URL parameters have the highest precedence, followed
by body parameters, and then query parameters. This means that an <code>:id</code> URL
parameter will not be overwritten by an <code>?id=</code> query parameter.</p>

<blockquote><p>Headers and cookies can also be accessed on the request object, but they are
not included in the parameters object.</p></blockquote>

<p>The body of the request is only parsed if the content type is
<code>application/x-www-form-urlencoded</code> or <code>multipart/form-data</code>. For requests that
use another content type, such as <code>json</code>, you can use the <code>json_params</code> helper
function to parse the body.</p>

<p>See <a href="../reference/quick_reference.html#how-can-i-read-json-http-body">How can I read JSON HTTP body?</a>.</p>

<h3><a name="request-parameters/boolean-parameters" href="#request-parameters/boolean-parameters">Boolean parameters</a></h3>

<p>A query parameter without a value is treated as a boolean parameter and will
have the value <code>true</code>.</p>

<p><code>/hello?hide_description&amp;color=blue</code> → <code>{ hide_description = true, color = "blue"}</code></p>

<h3><a name="request-parameters/nested-parameters" href="#request-parameters/nested-parameters">Nested Parameters</a></h3>

<p>It is common to use the <code>[]</code> syntax within a parameter name to represent nested
data within parameters. Lapis supports expanding this syntax for simple
key, value objects:</p>

<pre><code>/hello?upload[1][name]=test.txt&amp;upload[2][name]=file.png →

{
  upload = {
    ["1"] = { name = "test.txt" }, -- note that strings are not converted to numbers!
    ["2"] = { name = "file.png"}
  }
}
</code></pre>

<blockquote><p>Lapis does not support the empty <code>[]</code> syntax that you may have seen in other
frameworks for creating arrays. Only simple object expansion is supported.
Generally we encourage the application developer to do the parsing since
advanced parameter can unknowingly introduce bugs.</p></blockquote>

<h3><a name="request-parameters/parameters-types-and-limits" href="#request-parameters/parameters-types-and-limits">Parameters Types &amp; Limits</a></h3>

<p>The value of a parameter can either be a string, <code>true</code>, or a simple table. No
complex parsing or validation is performed on parameters; it is the
responsibility of the application creator to verify and sanitize any
parameters. For instance, if you're expecting a number, you will need to
convert the value to a number using something like the Lua built-in <code>tonumber</code>.</p>

<p>Lapis provides a <a href="../reference/input_validation.html">validation module</a> to
assist with verifying that user-supplied data matches a set of constraints that
you provide.</p>

<p>Duplicate parameter names are overwritten by subsequent values. Due to hash
table ordering, the final value may not be consistent, so we recommend against
setting the same parameters multiple times.</p>

<p>When using Nginx, a default limit of 100 parameters is parsed by default from
the body and query. This is to prevent malicious users from overloading your
server with a large amount of data.</p>

<blockquote><p>Are you storing or processing user input as a string? We highly recommend
adding limits on the maximum length of the string and trimming whitespace
from the sides. Additionally, verifying that the data is a valid Unicode
string can help prevent any processing errors by your database.</p></blockquote>

<h2><a name="request-object-methods" href="#request-object-methods">Request Object Methods</a></h2>

<h3><a name="request-object-methods/request:write" href="#request-object-methods/request:write"><code>request:write(things...)</code></a></h3>

<p>Appends all of the arguments to the output buffer or options table. The action
performed varies depending on the type of each argument:</p>

<ul>
<li><code>string</code> &mdash; The string is appended to the output buffer.</li>
<li><code>function</code> (or callable table) &mdash; The function is called with the output buffer, and the result is recursively passed to <code>write</code>.</li>
<li><code>table</code> &mdash; Key/value pairs are assigned into the <code class="for_moon">@options</code><code class="for_lua">self.options</code>, while all other values are recursively passed to <code>write</code>.</li>
</ul>


<p>Under most circumstances, it is unnecessary to call <code>write</code> because the return
value of an action is automatically passed to it. In before filters, <code>write</code>
serves a dual purpose: it writes to the output and cancels any further actions
from running.</p>

<h3><a name="request-object-methods/request:url_for" href="#request-object-methods/request:url_for"><code>request:url_for(name_or_obj, params, query_params=nil, ...)</code></a></h3>

<p>Generates a URL for <code>name_or_obj</code>.</p>

<blockquote><p>The function <code>url_for</code> is somewhat misleadingly named as it typically generates a path to the requested page. To obtain the complete URL, you can combine this function with <code>build_url</code>.</p></blockquote>

<p>If <code>name_or_obj</code> is a string, the route of that name is looked up and populated
using the values in <code>params</code>. If no named route exists that matches, then an
error is thrown.</p>

<p>Given the following routes:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- ...</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_data&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/data/:user_id/:data_field&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- ...</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">index:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">-- ..</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">user_data:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/data/:user_id/:data_field&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">-- ...</span></code>
</pre>
</div>

</p>

<p>URLs to the pages can be generated like this:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_comment">-- returns: /</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /data/123/height</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_data&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user_id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">123</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">data_field</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;height&quot;</span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_comment">-- returns: /</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;index&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /data/123/height</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_data&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">user_id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">123</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">data_field:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;height&quot;</span></code>
</pre>
</div>

</p>

<p>If the third argument, <code>query_params</code>, is supplied, it will be converted into
query parameters and appended to the end of the generated URL. If the route
doesn&rsquo;t take  any parameters in the URL then <code>nil</code>, or empty object, must be
passed as the second argument:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_comment">-- returns: /data/123/height?sort=asc</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_data&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user_id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">123</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">data_field</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;height&quot;</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">sort</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;asc&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /?layout=new</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">nil</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_identifier">layout</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;new&quot;</span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_comment">-- returns: /data/123/height?sort=asc</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_data&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">user_id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">123</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">data_field:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;height&quot;</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">sort:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;asc&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /?layout=new</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">nil</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">layout:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;new&quot;</span></code>
</pre>
</div>

</p>

<p>Any optional components of the route will only be included if all of the
enclosed parameters are provided. If the optional component does not have any
parameters then it will never be included.</p>

<p>Given the following route:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/user/:username(/:page)(.:format)&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- ...</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">user_page:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/user/:username(/:page)(.:format)&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">-- ...</span></code>
</pre>
</div>

</p>

<p>The following URLs can be generated:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_comment">-- returns: /user/leafo</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">username</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /user/leafo/projects</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">username</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">page</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;projects&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /user/leafo.json</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">username</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">format</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;json&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /user/leafo/code.json</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">username</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">page</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;code&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">format</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;json&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_comment">-- returns: /user/leafo</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_page&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">username:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /user/leafo/projects</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_page&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">username:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">page:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;projects&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /user/leafo.json</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_page&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">username:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">format:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;json&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /user/leafo/code.json</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_page&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">username:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">page:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;code&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">format:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;json&quot;</span></code>
</pre>
</div>

</p>

<p>If a route contains a splat, the value can be provided via the parameter named
<code>splat</code>:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;browse&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/browse(/*)&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- ...</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">browse:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/browse(/*)&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">-- ...</span></code>
</pre>
</div>

</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_comment">-- returns: /browse</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;browse&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /browse/games/recent</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;browse&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">splat</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;games/recent&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_comment">-- returns: /browse</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;browse&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- returns: /browse/games/recent</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;browse&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">splat:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;games/recent&quot;</span></code>
</pre>
</div>

</p>

<h4><a name="request-object-methods/request:url_for/passing-an-object-to-url-for" href="#request-object-methods/request:url_for/passing-an-object-to-url-for">Passing an object to <code>url_for</code></a></h4>

<p>If <code>name_or_obj</code> is a table, then the <code>url_params</code> method is called on that
table, and the return values are passed to <code>url_for</code>.</p>

<p>The <code>url_params</code> method takes as arguments the <code>request</code> object, followed by
anything else passed to <code>url_for</code> originally.</p>

<p>It&rsquo;s common to implement <code>url_params</code> on models, giving them the ability to
define what page they represent. For example, consider a <code>Users</code> model that
defines a <code>url_params</code> method, which goes to the profile page of the user:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Users</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Model</span><span class="sh_operator">:</span><span class="sh_identifier">extend</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">url_params</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">req</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">...)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_profile&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">...</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Model</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">url_params:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">req</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">...</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;user_profile&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@id</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">...</span></code>
</pre>
</div>

</p>

<p>We can now just pass an instance of <code>Users</code> directly to <code>url_for</code> and the path
for the <code>user_profile</code> route is returned:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Users</span><span class="sh_operator">:</span><span class="sh_identifier">find</span><span class="sh_operator">(</span><span class="sh_number">100</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_identifier">user</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">-- could return: /user-profile/100</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_operator">\</span><span class="sh_identifier">find</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">100</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">-- could return: /user-profile/100</span></code>
</pre>
</div>

</p>

<p>You might notice we passed <code>...</code> through the <code>url_params</code> method to the return
value. This allows the third <code>query_params</code> argument to still function:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Users</span><span class="sh_operator">:</span><span class="sh_identifier">find</span><span class="sh_operator">(</span><span class="sh_number">1</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_identifier">user</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">page</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;likes&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">-- could return: /user-profile/100?page=likes</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_operator">\</span><span class="sh_identifier">find</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">page:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;likes&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">-- could return: /user-profile/100?page=likes</span></code>
</pre>
</div>

</p>

<h4><a name="request-object-methods/request:url_for/using-the-url-key-method" href="#request-object-methods/request:url_for/using-the-url-key-method">Using the <code>url_key</code> method</a></h4>

<p>The value of any parameter in <code>params</code> is a string then it is inserted into the
generated path as is. If the value is a table, then the <code>url_key</code> method is
called on it, and the return value is inserted into the path.</p>

<p>For example, consider a <code>Users</code> model which we've generated a <code>url_key</code> method
for:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Users</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Model</span><span class="sh_operator">:</span><span class="sh_identifier">extend</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">url_key</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">route_name</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Model</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">url_key:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">route_name</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@id</span></code>
</pre>
</div>

</p>

<p>If we wanted to generate a path to the user profile we might normally write
something like this:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Users</span><span class="sh_operator">:</span><span class="sh_identifier">find</span><span class="sh_operator">(</span><span class="sh_number">1</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_profile&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_operator">.</span><span class="sh_identifier">id</span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_operator">\</span><span class="sh_identifier">find</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_profile&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_operator">.</span><span class="sh_identifier">id</span></code>
</pre>
</div>

</p>

<p>The <code>url_key</code> method we've defined lets us pass the <code>User</code> object directly as
the <code>id</code> parameter and it will be converted to the id:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Users</span><span class="sh_operator">:</span><span class="sh_identifier">find</span><span class="sh_operator">(</span><span class="sh_number">1</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;user_profile&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_operator">\</span><span class="sh_identifier">find</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user_profile&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span></code>
</pre>
</div>

</p>

<blockquote><p>The <code>url_key</code> method takes the name of the path as the first argument, so we
could change what we return based on which route is being handled.</p></blockquote>

<h3><a name="request-object-methods/request:build_url" href="#request-object-methods/request:build_url"><code>request:build_url(path, [options])</code></a></h3>

<p>Builds an absolute URL for the path. The current request&rsquo;s URI is used to build
the URL.</p>

<p>For example, if we are running our server on <code>localhost:8080</code>:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">build_url</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; http://localhost:8080</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">build_url</span><span class="sh_operator">(</span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; http://localhost:8080/hello</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">build_url</span><span class="sh_operator">(</span><span class="sh_string">&quot;world&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">host</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo.net&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">port</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">2000</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; http://leafo.net:2000/world</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_self_ref sh_label">@build_url</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; http://localhost:8080</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_self_ref sh_label">@build_url</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; http://localhost:8080/hello</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_self_ref sh_label">@build_url</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">host:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo.net&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">port:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">2000</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; http://leafo.net:2000/world</span></code>
</pre>
</div>

</p>

<p>The following options are supported:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>scheme</code></td><td><p>eg. <code>http</code>, <code>https</code></p>
</td><td><p>Current scheme</p>
</td></tr><tr><td><code>host</code></td><td>
</td><td><p>Current host</p>
</td></tr><tr><td><code>port</code></td><td><p>If port matches the default for the scheme (eg. 80 for http) then it will be left off</p>
</td><td><p>Current port</p>
</td></tr><tr><td><code>fragment</code></td><td><p>Part of the URL following the <code>#</code>. Must be string</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>query</code></td><td><p>Part of the URL following the <code>?</code>. Must be string</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr></tbody></table></p>

<h3><a name="request-object-methods/request:flow" href="#request-object-methods/request:flow"><code>request:flow(module_name)</code></a></h3>

<p>Loads a flow by <code>module_name</code> with the <code>flows_prefix</code> on the current request
object. If the flow with that name has been previously loaded, the existing
flow instance is returned.</p>

<h3><a name="request-object-methods/request:html" href="#request-object-methods/request:html"><code>request:html(fn)</code></a></h3>

<p>Returns a new function that implements the buffer writer interface for
rendering the contents of <code>fn</code> as an HTML scoped function. This is suitable for
returning from an action.</p>

<h3><a name="request-object-methods/request:get_request" href="#request-object-methods/request:get_request"><code>request:get_request()</code></a></h3>

<p>Returns <code>self</code>. This method is useful in scenarios where the request object is
being proxied, and you need direct access to the instance of the request object
for mutation. Examples include accessing the request object in a flow or in a
widget where the request object is embedded into the <em>helper chain</em>.</p>

<h2><a name="render-options" href="#render-options">Render Options</a></h2>

<p>Render options are set by explicit calls to <code>write</code> or by the return value of
the action function. They are accumulated in the <code class="for_moon">@options</code><code class="for_lua">self.options</code> field of
the request object. Typically, an action function does not generate the
response directly but sets the options to be used by Lapis during the rendering
phase of the request, which happens immediately after executing the action.</p>

<p>For example, in the following action, the <code>render</code> and <code>status</code> fields are used
to set the HTTP status response code and specify a view by name to be used to
generate the response body.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;error&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">404</span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;error&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">status:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">404</span></code>
</pre>
</div>

</p>

<p>Here are the options that can used to control the how the response is generated:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>status</code></td><td><p>Sets HTTP status code of the response (eg. 200, 404, 500, &hellip;)</p>
<details class="option_example"><summary>Show Example</summary><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">status</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">201</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">status:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">201</span></code>
</pre>
</div>

</details></td><td><p><code>200</code></p>
</td></tr><tr><td><code>render</code></td><td><p>Renders a view to the output buffer during the rendering phase of the request. If the value is <code>true</code> then the name of the route is used as the view name. Otherwise the value must be a string or a view class. When a string is provided as the view name, it will be loaded as a module with <code>require</code> using the full module name <code>{app.views_prefix}.{view_name}</code></p>
<details class="option_example"><summary>Show Example</summary><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;This loads views.index&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/page1&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_view&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/page2&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;helpers.my_view&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;This loads views.index&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/page1&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_view&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/page2&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;helpers.my_view&quot;</span></code>
</pre>
</div>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>content_type</code></td><td><p>Sets the <code>Content-type</code> header</p>
<details class="option_example"><summary>Show Example</summary><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/plain&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Plain text&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">layout</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">content_type</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;text/plain&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/plain&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Plain text&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">layout:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">content_type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;text/plain&quot;</span></code>
</pre>
</div>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>headers</code></td><td><p>A table of headers to add to the response</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>json</code></td><td><p>Renders the the JSON encoded value of the option. The content type is set to <code>application/json</code> and the layout is disabled.</p>
<details class="option_example"><summary>Show Example</summary><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/plain&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">json</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello world!&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">ids</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
        </span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
        </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
        </span><span class="sh_number">3</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/plain&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">json:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello world!&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">ids:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_number">3</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>
</div>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>layout</code></td><td><p>Overrides the layout from the application default. Set to <code>false</code> to entirely disable the layout. Can either be a renderable object (eg. a Widget or etlua template), or a string. When a string is provided it is used as the view name, it will be loaded as a module with <code>require</code> using the full module name <code>{app.views_prefix}.{view_name}</code></p>
<details class="option_example"><summary>Show Example</summary><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/none&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;No layout here!&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">layout</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">content_type</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;text/plain&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/mobile&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Custom layout&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">layout</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;mobile_layout&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/none&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;No layout here!&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">layout:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">content_type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;text/plain&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/mobile&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Custom layout&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">layout:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;mobile_layout&quot;</span></code>
</pre>
</div>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>redirect_to</code></td><td><p>Sets status to 302 and uses the value of this option for the <code>Location</code> header. Both relative and absolute URLs can be used. (Combine with <code>status</code> to perform 301 redirect)</p>
<details class="option_example"><summary>Show Example</summary><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/old&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">redirect_to</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;new&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;new&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/new&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;You made it!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/old&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">redirect_to:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;new&quot;</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;new&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/new&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;You made it!&quot;</span></code>
</pre>
</div>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>skip_render</code></td><td><p>Set to <code>true</code> to cause Lapis to skip it&rsquo;s entire rendering phase (including content, status, headers, cookies, sessions, etc.). Use this if you manually write the request response in the action method (using low level <code>ngx.print</code>, <code>ngx.header</code> or equivalent). This can be used to implement streaming output, as opposed to Lapis' default buffered output.</p>
<details class="option_example"><summary>Show Example</summary><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/stream&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_string">&quot;this will...&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_identifier">sleep</span><span class="sh_operator">(</span><span class="sh_number">1</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_string">&quot;stream to you&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_identifier">sleep</span><span class="sh_operator">(</span><span class="sh_number">1</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_string">&quot;slowly&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">skip_render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/stream&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;this will...&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_identifier">sleep</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;stream to you&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_identifier">sleep</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;slowly&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_tbl_key sh_regex">skip_render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span></code>
</pre>
</div>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr></tbody></table></p>

<p>When rendering JSON make sure to use the <code>json</code> render option. It will
automatically set the correct content type and disable the layout:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">json</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">hello</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">json:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">hello:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>
</div>

</p>

<h2><a name="application-configuration" href="#application-configuration">Application Configuration</a></h2>

<p>The following fields on the application object are designed to be overwritten
by the application creator to configure how the application processes a
request. These fields can either be overwritten on the instance or by setting
the instance fields when creating a new Application class.</p>

<h3><a name="application-configuration/application.layout" href="#application-configuration/application.layout"><code>application.layout</code></a></h3>

<p>This specifies a default view that will be used to wrap the content of the
results response. A layout is always rendered around the result of the action&rsquo;s
render unless <code>layout</code> is set to <code>false</code>, or a renderer with a separate content
type is used (e.g., <code>json</code>).</p>

<p>It can either be an instance of a view or a string. When a string is provided,
the layout is loaded as a module via the <code>require</code> using the module name
<code>{views_prefix}.{layout_name}</code>.</p>

<p>Default <code>require "lapis.views.layout"</code></p>

<h3><a name="application-configuration/application.error_page" href="#application-configuration/application.error_page"><code>application.error_page</code></a></h3>

<p>This is the view used to render an unrecoverable error in the default
<code>handle_error</code> callback. The value of this field is passed directly to Render
Option <code>render</code>, enabling the use of specifying the page by view name or
directly by a widget or template.</p>

<p>Default <code>require "lapis.views.error"</code></p>

<h3><a name="application-configuration/application.views_prefix" href="#application-configuration/application.views_prefix"><code>application.views_prefix</code></a></h3>

<p>This is a prefix appended to the view name (joined by <code>.</code>) whenever a view is
specified by string to determine the full module name to require.</p>

<p>Default <code>"views"</code></p>

<h3><a name="application-configuration/application.actions_prefix" href="#application-configuration/application.actions_prefix"><code>application.actions_prefix</code></a></h3>

<p>This is a prefix appended to the action name (joined by <code>.</code>) whenever an action
is specified by string to determine the full module name to require.</p>

<p>Default <code>"actions"</code></p>

<h3><a name="application-configuration/application.flows_prefix" href="#application-configuration/application.flows_prefix"><code>application.flows_prefix</code></a></h3>

<p>This is a prefix appended to the flow name (joined by <code>.</code>) whenever a flow is
specified by string to determine the full module name to require.</p>

<p>Default <code>"flows"</code></p>

<h3><a name="application-configuration/application.Request" href="#application-configuration/application.Request"><code>application.Request</code></a></h3>

<p>This is the class that will be used to instantiate new request objects when
dispatching a request.</p>

<p>Default <code>require "lapis.request"</code></p>

<h3><a name="application-configuration/callbacks" href="#application-configuration/callbacks">Callbacks</a></h3>

<p>Application callbacks are special methods that can be overridden to handle
special cases and provide additional configuration.</p>

<p>Although they are functions stored on the application, they are called like
like actions, meaning the first argument to the function is an instance of a
request object.</p>

<h4><a name="application-configuration/callbacks/application:default_route" href="#application-configuration/callbacks/application:default_route"><code>application:default_route()</code></a></h4>

<p>When a request does not match any of the routes you've defined, the
<code>default_route</code> method will be called to create a response.</p>

<p>A default implementation is provided:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">default_route</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- strip trailing /</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">req</span><span class="sh_operator">.</span><span class="sh_identifier">parsed_url</span><span class="sh_operator">.</span><span class="sh_identifier">path</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;./$&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">stripped</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">req</span><span class="sh_operator">.</span><span class="sh_identifier">parsed_url</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;^(.+)/+$&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">redirect_to</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">build_url</span><span class="sh_operator">(</span><span class="sh_identifier">stripped</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
        </span><span class="sh_identifier">status</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">301</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
        </span><span class="sh_identifier">query</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">req</span><span class="sh_operator">.</span><span class="sh_identifier">parsed_url</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">else</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">app</span><span class="sh_operator">.</span><span class="sh_identifier">handle_404</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_tbl_key sh_regex">default_route:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_comment">-- strip trailing /</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@req</span><span class="sh_operator">.</span><span class="sh_identifier">parsed_url</span><span class="sh_operator">.</span><span class="sh_identifier">path</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;./$&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">stripped</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@req</span><span class="sh_operator">.</span><span class="sh_identifier">parsed_url</span><span class="sh_operator">.</span><span class="sh_identifier">path</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;^(.+)/+$&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">redirect_to:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@build_url</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">stripped</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">query:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@req</span><span class="sh_operator">.</span><span class="sh_identifier">parsed_url</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_symbol sh_embedded">)</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">status:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">301</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_keyword">else</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_self_ref sh_label">@app</span><span class="sh_operator">.</span><span class="sh_identifier">handle_404</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@</span></code>
</pre>
</div>

</p>

<p>The default implementation will check for excess trailing <code>/</code> on the end of the
URL it will attempt to redirect to a version without the trailing slash.
Otherwise it will call the <code>handle_404</code> method on the application.</p>

<p>This method, <code>default_route</code>, is a normal method of your application. You can
override it to do whatever you like. For example, this adds logging:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">default_route</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_identifier">log</span><span class="sh_operator">(</span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_identifier">NOTICE</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;User hit unknown path &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">req</span><span class="sh_operator">.</span><span class="sh_identifier">parsed_url</span><span class="sh_operator">.</span><span class="sh_identifier">path</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_comment">-- call the original implementaiton to preserve the functionality it provides</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">.</span><span class="sh_identifier">default_route</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">default_route:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_identifier">log</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">ngx</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">NOTICE</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;User hit unknown path #{@req.parsed_url.path}&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_keyword">super</span><span class="sh_operator">!</span></code>
</pre>
</div>

</p>

<h4><a name="application-configuration/callbacks/application:handle_404" href="#application-configuration/callbacks/application:handle_404"><code>application:handle_404()</code></a></h4>

<p>In the default <code>default_route</code>, the method <code>handle_404</code> is called when the path
of the request did not match any routes.</p>

<p>A default implementation is provided:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">handle_404</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_function">error</span><span class="sh_operator">(</span><span class="sh_string">&quot;Failed to find route: &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">req</span><span class="sh_operator">.</span><span class="sh_identifier">request_uri</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">handle_404:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_function">error</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Failed to find route: #{@req.request_uri}&quot;</span></code>
</pre>
</div>

</p>

<p>This handler will cause a 500 error and a stack trace for every invalid
request. If you wish to create a suitable 404 page, this is where you would do
it.</p>

<p>By overriding the <code>handle_404</code> method instead of the <code>default_route</code>, we can
create a custom 404 page while maintaining the code for removing the trailing
slash.</p>

<p>Here&rsquo;s a straightforward 404 handler that merely displays the text <code>"Not
Found!"</code>:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">handle_404</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">404</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">layout</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Not Found!&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">handle_404:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">status:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">404</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">layout:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Not Found!&quot;</span></code>
</pre>
</div>

</p>

<h4><a name="application-configuration/callbacks/application:handle_error" href="#application-configuration/callbacks/application:handle_error"><code>application:handle_error(err, trace)</code></a></h4>

<p>Every action executed by Lapis is called through <a href="http://www.lua.org/manual/5.1/manual.html#pdf-xpcall"><code>xpcall</code></a>. This ensures
that fatal errors can be captured and a meaningful error page can be produced
instead of the server&rsquo;s default error page.</p>

<p>The error handler should only be utilized to capture fatal and unexpected
errors. Expected errors are discussed in the <a href="../reference/exception_handling.html">Exception Handling
guide</a>.</p>

<p>Lapis comes with a pre-defined error handler that extracts information about
the error and renders it into the template specified by
<code>application.error_page</code>. This error page includes a stack trace and the error
message.</p>

<p>If you wish to implement your own error handling logic, you can override the
<code>handle_error</code> method.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_comment">-- config.custom_error_page is made up for this example</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">function</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">handle_error</span><span class="sh_operator">(</span><span class="sh_identifier">err</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">trace</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_operator">.</span><span class="sh_identifier">custom_error_page</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_custom_error_page&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">else</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">.</span><span class="sh_identifier">handle_error</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">err</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">trace</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_comment">-- config.custom_error_page is made up for this example</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">handle_error:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">err</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">trace</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_operator">.</span><span class="sh_identifier">custom_error_page</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_custom_error_page&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_keyword">else</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_keyword">super</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">err</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">trace</span></code>
</pre>
</div>

</p>

<p>The request object, or <code>self</code>, that is passed to the error handler is not the
one that was created for the request that failed, as it may have been tainted
by the failed request via a partial write. Lapis generates an empty request
object for rendering the error page.</p>

<p>If you need to inspect the original request object to extract information about
why the error occurred, you can access it through
<code class="for_moon">@original_request</code><code class="for_lua">self.original_request</code>.</p>

<p>Lapis' default error page displays a full stack trace. Therefore, it is
recommended to replace it with a custom one in your production environments and
log the exception in the background to prevent leaking file pathes and function
names related to your application.</p>

<p>The <a href="https://github.com/leafo/lapis-exceptions"><code>lapis-exceptions</code></a> module augments the error handler to records errors
in a database. It can also email you when there&rsquo;s an exception.</p>

<h2><a name="application-methods" href="#application-methods">Application Methods</a></h2>

<p>A Lapis Application can be built either by subclassing it (via MoonScript or
<code>extend</code>), or by creating an instance of it and calling the appropriate methods
or overriding the appropriate fields.</p>

<h3><a name="application-methods/application:match" href="#application-methods/application:match"><code>application:match([route_name], route_patch, action_fn)</code></a></h3>

<p>Adds a new route to the route group contained by the application. See above for
more information on registering actions. Note that routes are inheritance by
the inheritance change of the application object.</p>

<p>You can overwrite a route by re-using the same route name, or path, and that
route will take precedence over one defined further up in the inheritance
change.</p>

<p>Class approach:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">:</span><span class="sh_identifier">extend</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/index&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello world!&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/about&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;My site is cool&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_self_ref sh_label">@match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/index&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello world!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_self_ref sh_label">@match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/about&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;My site is cool&quot;</span></code>
</pre>
</div>

</p>

<p>Instance approach:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/index&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello world!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/about&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;My site is cool&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">app</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;index&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/index&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello world!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">app</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/about&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;My site is cool&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="application-methods/application:get" href="#application-methods/application:get"><code>application:get(...)</code></a></h3>

<p>Shortcut method for adding route for a specific HTTP verb by utilizing the
<code>respond_to</code> via <code>match</code>. Same arguments as <code>match</code>.</p>

<h3><a name="application-methods/application:post" href="#application-methods/application:post"><code>application:post(...)</code></a></h3>

<p>Shortcut method for adding route for a specific HTTP verb by utilizing the
<code>respond_to</code> via <code>match</code>. Same arguments as <code>match</code>.</p>

<h3><a name="application-methods/application:delete" href="#application-methods/application:delete"><code>application:delete(...)</code></a></h3>

<p>Shortcut method for adding route for a specific HTTP verb by utilizing the
<code>respond_to</code> via <code>match</code>. Same arguments as <code>match</code>.</p>

<h3><a name="application-methods/application:put" href="#application-methods/application:put"><code>application:put(...)</code></a></h3>

<p>Shortcut method for adding route for a specific HTTP verb by utilizing the
<code>respond_to</code> via <code>match</code>. Same arguments as <code>match</code>.</p>

<h3><a name="application-methods/application:enable" href="#application-methods/application:enable"><code>application:enable(feature)</code></a></h3>

<p>Loads a module named <code>feature</code> using <code>require</code>. If the result of that module is
callable, then it will be called with one argument, <code>application</code>.</p>

<h3><a name="application-methods/application:before_filter" href="#application-methods/application:before_filter"><code>application:before_filter(fn)</code></a></h3>

<p>Appends a before filter to the chain of filters for the application. Before
filters are applied in the order they are added. They receive one argument, the
request object.</p>

<p>A before filter is a function that will run before the action&rsquo;s function. If a
<code>write</code> takes place in a before filter then the request is ended after the
before filter finishes executing. Any remaining before filters and the action
function are not called.</p>

<p>See <a href="#before-filters">Before Filters</a> for more information.</p>

<h3><a name="application-methods/application:include" href="#application-methods/application:include"><code>application:include(other_app, opts={})</code></a></h3>

<p>Copies all the routes from <code>other_app</code> into the current app. <code>other_app</code> can be
either an application class or an instance. If there are any before filters in
<code>other_app</code>, every action of <code>other_app</code> will be be wrapped in a new function
that calls those before filters before calling the original function.</p>

<p>Options can either be provided in the arugment <code>opts</code>, or will be pulled from
<code>other_app</code>, with precedence going to the value provided in <code>opts</code> if provided.</p>

<p>Note that application instance configuration like <code>layout</code> and <code>views_prefix</code>
are not kept from the included application.</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>path</code></td><td><p>If provided, every path copied over will be prefixed with the value of this option. It should start with a <code>/</code> and a trailing slash should be inlcuded if desired.</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>name</code></td><td><p>If provided, every route name will be prefixed with the value of the this option. Provide a trailing <code>.</code> if desired.</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr></tbody></table></p>

<h3><a name="application-methods/application:find_action" href="#application-methods/application:find_action"><code>application:find_action(name, resolve=true)</code></a></h3>

<p>Searches the inheritance chain for the first action specified by the route
name, <code>name</code>.</p>

<p>Returns the <code>action</code> value and the route path object if an action could be
found. If <code>resolve</code> is true the action value will be loaded if it&rsquo;s a deferred
action like <code>true</code> or a module name</p>

<p>Returns <code>nil</code> if no action could be found.</p>

<h3><a name="application-methods/Application:extend" href="#application-methods/Application:extend"><code>Application:extend([name], fields={}, [init_fn])</code></a></h3>

<p>Creates a subclass of the Application class. This method is only available on
the class object, not the instance. Instance fields can be provided as via the
<code>fields</code> arugment or by mutating the returned metatable object.</p>

<p>This method returns the newly created class object, and the metatable for any
instances of the class.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">MyApp</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">MyApp_mt</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">:</span><span class="sh_identifier">extend</span><span class="sh_operator">(</span><span class="sh_string">&quot;MyApp&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">layout</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;custom_layout&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">views_prefix</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;widgets&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">function</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">MyApp_mt</span><span class="sh_operator">:</span><span class="sh_identifier">handle_error</span><span class="sh_operator">(</span><span class="sh_identifier">err</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_function">error</span><span class="sh_operator">(</span><span class="sh_string">&quot;oh no!&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- note that `match` is a class method, so MyApp_mt is not used here</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">MyApp</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;home&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello world!&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>


      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Oct  6 22:56:40 2023"></script>
  <script type="text/javascript" src="../reference.js?Fri Oct  6 22:56:40 2023"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
