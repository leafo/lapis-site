<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Input Validation - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Oct  6 22:56:41 2023" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.15.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Input Validation</h2>
            <ul><li><a href="#tableshape-validation">Tableshape Validation</a></li>
<ul><li><a href="#tableshape-validation/with_params"><code>with_params(t, fn)</code></a></li>
<li><a href="#tableshape-validation/type-constructors">Type Constructors</a></li>
<ul><li><a href="#tableshape-validation/type-constructors/types.params_shape"><code>types.params_shape(param_spec, [opts])</code></a></li>
<li><a href="#tableshape-validation/type-constructors/types.params_array"><code>types.params_array(t, [opts])</code></a></li>
<li><a href="#tableshape-validation/type-constructors/types.assert_error"><code>types.assert_error(t)</code></a></li>
<li><a href="#tableshape-validation/type-constructors/types.flatten_errors"><code>types.flatten_errors(t)</code></a></li></ul>
<li><a href="#tableshape-validation/builtin-types">Builtin types</a></li>
<ul><li><a href="#tableshape-validation/builtin-types/types.empty"><code>types.empty</code></a></li>
<li><a href="#tableshape-validation/builtin-types/types.valid_text"><code>types.valid_text</code></a></li>
<li><a href="#tableshape-validation/builtin-types/types.cleaned_text"><code>types.cleaned_text</code></a></li>
<li><a href="#tableshape-validation/builtin-types/types.trimmed_text"><code>types.trimmed_text</code></a></li>
<li><a href="#tableshape-validation/builtin-types/types.truncated_text"><code>types.truncated_text(len)</code></a></li>
<li><a href="#tableshape-validation/builtin-types/types.limited_text"><code>types.limited_text(max_len, min_len=1)</code></a></li>
<li><a href="#tableshape-validation/builtin-types/types.db_id"><code>types.db_id</code></a></li>
<li><a href="#tableshape-validation/builtin-types/types.db_enum"><code>types.db_enum(enum)</code></a></li></ul></ul>
<li><a href="#assert-valid">Assert Valid</a></li>
<ul><li><a href="#assert-valid/validation-functions">Validation Functions</a></li>
<li><a href="#assert-valid/optional-validations">Optional validations</a></li>
<li><a href="#assert-valid/creating-a-custom-validator">Creating a Custom Validator</a></li>
<li><a href="#assert-valid/manual-validation">Manual Validation</a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Input Validation</h1>

<p>Any parameters that are sent to your application should be treated as untrusted
input. It is your responsibility to verify that the inputs match some expected
format before you use them directly in your models and application logic.</p>

<p>Some common types of inputs that web application developers often forget to
verify:</p>

<ul>
<li>Very long inputs, eg. receiving a megabyte of text when you only expect a few characters</li>
<li>Invalid Unicode sequences, unprintable characters, or control codes</li>
<li>Excess invisible characters or whitespace</li>
<li>Type mismatch, like expecting a string when an object is provided</li>
<li>Numbers that are substantially larger than expected, or negative (eg. fetching a page number 893289328)</li>
<li>Inputs that are outside the domain of a smaller set of pre-existing options (eg. a value for an enum)</li>
<li>Incorrectly treating an empty string as a provided value</li>
</ul>


<p>The Lapis validation module helps you ensure that inputs are correct and safe
before you start using them. Validation is also able to <em>transform</em> malformed
input to turn it into something usable, eg. stripping whitespace from the start
and end of a string.</p>

<blockquote><p>Lapis is currently introducing a new validation system based around
<a href="https://github.com/leafo/tableshape">Tableshape</a>. The legacy validation
functions will remain unchanged until further notice, but we recommend using
the Tableshape validation when possible.</p></blockquote>

<h2><a name="tableshape-validation" href="#tableshape-validation">Tableshape Validation</a></h2>

<p><a href="https://github.com/leafo/tableshape">Tableshape</a> is a Lua library that is used
for validating a value or the structure of an object. It includes the ability
to <em>transform</em> values, which can be used to repair inputs that don&rsquo;t quite
match the expected criteria. Tableshape type validators are plain Lua objects
that can be composed or nested to verify the structure of more complex types.</p>

<p>Lapis provides a handful of Tableshape compatible types and type constructors
for the validation of request parameters.</p>

<p>Tableshape is not installed by default as a dependency of Lapis. In order to
use the Tableshape powered validation types you must install Tableshape:</p>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">luarocks</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">install</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">tableshape</span></code>
</pre>


<p>Types and type-constructors are located in the <code>lapis.validate.types</code> module.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.validate.types&quot;</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.validate.types&quot;</span></code>
</pre>
</div>

</p>

<blockquote><p>The <code>lapis.validate.types</code> module has its <code>__index</code> metamethod set to the
<code>types</code> object of the <code>tableshape</code> module. This enables access to any
Tableshape type directly from the Lapis module without having to import both.
Any types used in the examples below that are not directly documented are
types provided by Tableshape (eg. <code>types.string</code> is a type provided by
Tableshape that verifies a value such that <code>type(value) == "string"</code>).</p></blockquote>

<h3><a name="tableshape-validation/with_params" href="#tableshape-validation/with_params"><code>with_params(t, fn)</code></a></h3>

<p>The <code>with_params</code> is a helper function for wrapping an action function such
that it only runs if fields from <code class="for_moon">@params</code><code class="for_lua">self.params</code> can be validated. The
validated parameter table is passed as the first argument to <code>fn</code>.</p>

<blockquote><p><code class="for_moon">@params</code><code class="for_lua">self.params</code> is left unchanged. This enables the calling of nested
functions that use <code>with_params</code> to work with other sets of parameters</p></blockquote>

<p>It returns a new function that is designed to be called with a <em>request object</em>
as the first argument.</p>

<p>The argument, <code>t</code>, can either be a Tableshape type, or it can be a plain Lua
table that will be converted into a type using <code>types.params_shape(t)</code>.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors_json</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">capture_errors_json</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">with_params</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.validate&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">with_params</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">post</span><span class="sh_operator">(</span><span class="sh_string">&quot;/user/:id&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors_json</span><span class="sh_operator">(</span><span class="sh_identifier">with_params</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">{</span><span class="sh_string">&quot;id&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">{</span><span class="sh_string">&quot;action&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">one_of</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_string">&quot;delete&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;update&quot;</span><span class="sh_operator">}}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">params</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_string">&quot;Perform&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">action</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;on user&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">id</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)))</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors_json</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">types</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.validate.types&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">with_params</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.validate&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/user/:id&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors_json</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">with_params</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;id&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;action&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">one_of</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;delete&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;update&quot;</span><span class="sh_symbol sh_embedded">}}</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">params</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Perform&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">action</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;on user&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">id</span></code>
</pre>
</div>

</p>

<p>The params type, <code>t</code>, is wrapped in <code>types.assert_error</code>. If validation fails
then an error is raised for the nearest <code>capture_errors</code>. In the example above,
<code>capture_errors_json</code> is used to display errors as a JSON response.</p>

<h3><a name="tableshape-validation/type-constructors" href="#tableshape-validation/type-constructors">Type Constructors</a></h3>

<h4><a name="tableshape-validation/type-constructors/types.params_shape" href="#tableshape-validation/type-constructors/types.params_shape"><code>types.params_shape(param_spec, [opts])</code></a></h4>

<p>Creates a type checker that is suitable for extracting validated values from a
parameters objects (or any other plain Lua table). <code>params_shape</code> is similar
to <code>types.shape</code> from Tableshape with a few key differences:</p>

<ul>
<li>Fields to verify are specified in an array of tuples, values are checked in the order they provided.</li>
<li>Any excess fields that are not explicitly specified within <code>param_spec</code> do not generate an error, and are left out of the transformed result.</li>
<li>The error returned by the type checker is not a single string value, but instead an array of errors that is compatible with the <code class="for_moon">@errors</code><code class="for_lua">self.errors</code> pattern seen in Lapis actions.</li>
<li>The formatting of error mesages can be customized.</li>
<li>A new object is always returned from transform, even if the input matches the output</li>
</ul>


<p><code>types.params_shape</code> is designed to be used with the transform API of
Tableshape. The resulting transformed object is a validated table of
parameters.</p>

<p><code>param_spec</code> is an array of parameter specification objects object, the
parameters are checked in order:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.validate.types&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">test_params</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">params_shape</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">{</span><span class="sh_string">&quot;user_id&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">{</span><span class="sh_string">&quot;bio&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">+</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">limited_text</span><span class="sh_operator">(</span><span class="sh_number">256</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">{</span><span class="sh_string">&quot;confirm&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">literal</span><span class="sh_operator">(</span><span class="sh_string">&quot;yes&quot;</span><span class="sh_operator">),</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">error</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Please check confirm&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">params</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">err</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">test_params</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">({...})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">params</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- params is an object that contains only fields that we have validated</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.validate.types&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">test_params</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">params_shape</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;user_id&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;bio&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">+</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">limited_text</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">256</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;confirm&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">literal</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;yes&quot;</span><span class="sh_symbol sh_embedded">)</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">error:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Please check confirm&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">params</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">err</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">test_params</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_operator">...</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">params</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">bio</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_comment">-- params is an object that contains only fields that we have validated</span></code>
</pre>
</div>

</p>

<p>The following options are supported via the second argument:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>error_prefix</code></td><td><p>Prefix all error messages with this substring</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr></tbody></table></p>

<p>Each item in <code>params_spec</code> is a Lua table that matches the following format:</p>

<pre><code>{"field_name", type_checker, additional_options...}
</code></pre>

<p><code>field_name</code> must be a string, <code>type_checker</code> must be an instance of a
Tableshape type checker.</p>

<p>Additional options are provided as hash table properties of the table. The
following options are supported:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>error</code></td><td><p>A string to replace the error message with if the field fails validation</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>label</code></td><td><p>A prefix to be used in place of the field name when generating an error message</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>as</code></td><td><p>The name to store the resulting value as in the output transformed object. By default, the field name is used</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr></tbody></table></p>

<h4><a name="tableshape-validation/type-constructors/types.params_array" href="#tableshape-validation/type-constructors/types.params_array"><code>types.params_array(t, [opts])</code></a></h4>

<p>Creates a type checker that extracts array components from a table. Every item
in the array must match type <code>t</code>, otherwise the checker will fail. Any other
items in the table, not part of the array component, are ignored and not
included in the final result. A new table is always returned in the transformed
output, even if no changes have been made to any of the values. Similar to
<code>params_shape</code>, errors are accumulated into an array object.</p>

<p>The <code>opts</code> argument is a table of options that control how the type checker
processes the input:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>length</code></td><td><p>A type checker, typically <code>types.range</code>, that is used to verify the length of the array before checking individual items. The length is computed with the <code>#</code> operator. If length check fails then no other checks are done, and a single failure message is returned</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>item_prefix</code></td><td><p>A string that prefixed before each collected error to identify the kind of object being checked</p>
</td><td><p>&ldquo;item&rdquo;</p>
</td></tr><tr><td><code>iter</code></td><td><p>Function used as iterator to visit each item in the table</p>
</td><td><p>ipairs</p>
</td></tr></tbody></table></p>

<h4><a name="tableshape-validation/type-constructors/types.assert_error" href="#tableshape-validation/type-constructors/types.assert_error"><code>types.assert_error(t)</code></a></h4>

<p>Wraps a Tableshape type checker, <code>t</code>, to yield an error when the checking or
transforming process fails. The error yielded is compatible with Lapis error
handling, such as <code>assert_error</code> and <code>capture_errors</code>.</p>

<p>This can be utilized to simplify code paths, as it eliminates the need to check
for an error case when validating an input. The error will be automatically
passed up the stack to the enclosing <code>capture_errors</code>.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.validate.types&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">assert_empty</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">assert_error</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">some_value</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">...</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">empy_val</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">assert_empty</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_identifier">some_value</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_string">&quot;We are guaranteed to have an empty value&quot;</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.validate.types&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">assert_empty</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">assert_error</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">some_value</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">...</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">empy_val</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">assert_empty</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">some_value</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;We are guaranteed to have an empty value&quot;</span></code>
</pre>
</div>

</p>

<h4><a name="tableshape-validation/type-constructors/types.flatten_errors" href="#tableshape-validation/type-constructors/types.flatten_errors"><code>types.flatten_errors(t)</code></a></h4>

<p>Converts errors that might be contained in an array table into a single string
error message.</p>

<p>The constructors <code>params_shape</code> and <code>params_array</code> accumulate errors into an
array table to enhance error reporting for end-users. However, this error
format is not compatible with standard tableshape error handling, as it expects
a single string. This ensures that any error messages generated by the
contained type, <code>t</code>, are single strings.</p>

<p>If an array of errors is encountered, they are joined by <code>", "</code>.</p>

<h3><a name="tableshape-validation/builtin-types" href="#tableshape-validation/builtin-types">Builtin types</a></h3>

<h4><a name="tableshape-validation/builtin-types/types.empty" href="#tableshape-validation/builtin-types/types.empty"><code>types.empty</code></a></h4>

<p>Matches either <code>nil</code>, an empty string, or a string of whitespace. Empty and
whitespace strings are transformed to <code>nil</code>.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">(</span><span class="sh_string">&quot;&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; true</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">(</span><span class="sh_string">&quot;  &quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; true</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">(</span><span class="sh_string">&quot;Hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; false</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;   &quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_keyword">nil</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; true</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;  &quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; true</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; false</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;   &quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">nil</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil</span></code>
</pre>
</div>

</p>

<blockquote><p>On failure, <code>transform</code> returns <code>nil</code>, and an error. Transforming an invalid
value with <code>types.empty</code> and only checking the first return value may not be
desirable.  The transform method can be combined with a type check to ensure
an empty value is provided. When using nested type checkers, like
<code>types.shape</code> and <code>table.params_shape</code>, Tableshape is aware of this
distinction and no additional code is necessary.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">some_value</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">...</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">(</span><span class="sh_identifier">some_value</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_string">&quot;some value is empty!&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">result</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_identifier">some_value</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">some_value</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">...</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">some_value</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;some value is empty!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">result</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">empty</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">some_value</span></code>
</pre>
</div>


Alternatively, <code>types.assert</code> or <code>types.assert_error</code> can be used to
guarantee the value matches the type checker</p></blockquote>

<h4><a name="tableshape-validation/builtin-types/types.valid_text" href="#tableshape-validation/builtin-types/types.valid_text"><code>types.valid_text</code></a></h4>

<p>Matches a string that is valid UTF8. Invalid characters sequences or
unprintable characters will cause validation to valid.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">valid_text</span><span class="sh_operator">(</span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; true</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">valid_text</span><span class="sh_operator">(</span><span class="sh_string">&quot;hel\0o&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected valid text&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">valid_text</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; true</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">valid_text</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hel\0o&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected valid text&quot;</span></code>
</pre>
</div>

</p>

<h4><a name="tableshape-validation/builtin-types/types.cleaned_text" href="#tableshape-validation/builtin-types/types.cleaned_text"><code>types.cleaned_text</code></a></h4>

<p>Matches a string, transforms it such that any invalid UTF8 sequences and
non-printable characters are stripped (eg removing <code>null</code> bytes)</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">cleaned_text</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">--&gt; &quot;hello&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">cleaned_text</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;hel\0o&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;helo&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">cleaned_text</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_number">55</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected text&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">cleaned_text</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">--&gt; &quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">cleaned_text</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hel\0o&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;helo&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">cleaned_text</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">55</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected text&quot;</span></code>
</pre>
</div>

</p>

<h4><a name="tableshape-validation/builtin-types/types.trimmed_text" href="#tableshape-validation/builtin-types/types.trimmed_text"><code>types.trimmed_text</code></a></h4>

<p>Matches a string that is valid UTF8, and transforms such that any whitespace or
empty UTF8 characters stripped from either side.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">trimmed_text</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;hello&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">trimmed_text</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot; wor ld \t &quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;wor ld&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">trimmed_text</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">trimmed_text</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot; wor ld \t &quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;wor ld&quot;</span></code>
</pre>
</div>

</p>

<p>This type is equivalent to the following: <code>types.valid_text / trim</code>, where
<code>trim</code> is implemented using the pattern in <code>lapis.util.utf8</code></p>

<h4><a name="tableshape-validation/builtin-types/types.truncated_text" href="#tableshape-validation/builtin-types/types.truncated_text"><code>types.truncated_text(len)</code></a></h4>

<p>Matches a string that is valid UTF8, and transforms it such that it is <code>len</code>
characters or shorter. Note that length is UTF8 aware, and will truncate by the
number of characters and not bytes.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">truncated_text</span><span class="sh_operator">(</span><span class="sh_number">5</span><span class="sh_operator">):</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;hello&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">truncated_text</span><span class="sh_operator">(</span><span class="sh_number">5</span><span class="sh_operator">):</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;hi world&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;hi wo&quot;</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- invalid types are rejected</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">truncated_text</span><span class="sh_operator">(</span><span class="sh_number">5</span><span class="sh_operator">):</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_keyword">true</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected text&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">truncated_text</span><span class="sh_symbol sh_embedded">(</span><span class="sh_number">5</span><span class="sh_symbol sh_embedded">)</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">truncated_text</span><span class="sh_symbol sh_embedded">(</span><span class="sh_number">5</span><span class="sh_symbol sh_embedded">)</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hi world&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;hi wo&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- invalid types are rejected</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">truncated_text</span><span class="sh_symbol sh_embedded">(</span><span class="sh_number">5</span><span class="sh_symbol sh_embedded">)</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_symbol sh_embedded">(</span><span class="sh_keyword">true</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected text&quot;</span></code>
</pre>
</div>

</p>

<h4><a name="tableshape-validation/builtin-types/types.limited_text" href="#tableshape-validation/builtin-types/types.limited_text"><code>types.limited_text(max_len, min_len=1)</code></a></h4>

<p>Matches a string that is valid UTF8 and has a length within the specified range
of <code>min_len</code> to <code>max_len</code>, inclusive. Note that length is UTF8 aware, and will
count by the number of characters and not bytes.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">limit5</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">limited_text</span><span class="sh_operator">(</span><span class="sh_number">5</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">limit5</span><span class="sh_operator">(</span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">limit5</span><span class="sh_operator">(</span><span class="sh_string">&quot;hi world&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected text between 1 and 5 characters&quot;</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- invalid types are rejected</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">limit5</span><span class="sh_operator">(</span><span class="sh_number">12</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected text between 1 and 5 characters&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">limit5</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">limited_text</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">5</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">limit5</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">limit5</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hi world&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected text between 1 and 5 characters&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- invalid types are rejected</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">limit5</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">12</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected text between 1 and 5 characters&quot;</span></code>
</pre>
</div>

</p>

<h4><a name="tableshape-validation/builtin-types/types.db_id" href="#tableshape-validation/builtin-types/types.db_id"><code>types.db_id</code></a></h4>

<p>Matches number or string that represents an integer that is suitable for the
default 4 byte <code>serial</code> type of a PostgreSQL database column. The value is
transformed to a number.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;0&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt;  0</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;2392&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; 2392</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_number">-5</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected database ID integer&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;-5&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected database ID integer&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;42.8&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected database ID integer&quot;</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- value is too big</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;29328302830230&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected database ID integer&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;0&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt;  0</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;2392&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; 2392</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">-5</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected database ID integer&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;-5&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected database ID integer&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;42.8&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected database ID integer&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- value is too big</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_id</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;29328302830230&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected database ID integer&quot;</span></code>
</pre>
</div>

</p>

<h4><a name="tableshape-validation/builtin-types/types.db_enum" href="#tableshape-validation/builtin-types/types.db_enum"><code>types.db_enum(enum)</code></a></h4>

<p>Matches from the set of values contained by a <code>db.enum</code> object. Transforms the
value to the integer value of the enum using <code>for_db</code>.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">model</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.model&quot;</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">statuses</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">model</span><span class="sh_operator">.</span><span class="sh_identifier">enum</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">default</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">banned</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">deleted</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">check_status</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_enum</span><span class="sh_operator">(</span><span class="sh_identifier">statuses</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">check_status</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;default&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; 1</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">check_status</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;invalid&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected enum(default, banned, deleted)&quot;</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">check_status</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_number">2</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; 2</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">check_status</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_string">&quot;2&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; 2</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- value out of range is rejected</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">check_status</span><span class="sh_operator">:</span><span class="sh_identifier">transform</span><span class="sh_operator">(</span><span class="sh_number">5</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected enum(default, banned, deleted)&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">enum</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.model&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">statuses</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">enum</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">default:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">banned:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">deleted:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">check_status</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">db_enum</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">statuses</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">check_status</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;default&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; 1</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">check_status</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;invalid&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected enum(default, banned, deleted)&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">check_status</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; 2</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">check_status</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;2&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; 2</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- value out of range is rejected</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">check_status</span><span class="sh_operator">\</span><span class="sh_identifier">transform</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">5</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; nil, &quot;expected enum(default, banned, deleted)&quot;</span></code>
</pre>
</div>

</p>

<h2><a name="assert-valid" href="#assert-valid">Assert Valid</a></h2>

<blockquote><p><strong>This is the legacy validation system.</strong> Due to shortcomings addressed by
the Tableshape validation system, it is not recommended to <code>assert_valid</code> and
related functions any more</p></blockquote>

<p>The <code>assert_valid</code> function is Lapis&rsquo;s legacy validation framework. It provides
a simple set of validation functions. Here&rsquo;s a complete example:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">validate</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.validate&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_operator">.</span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/create-user&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">validate</span><span class="sh_operator">.</span><span class="sh_identifier">assert_valid</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">exists</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">min_length</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">max_length</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">25</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;password&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">exists</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">min_length</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;password_repeat&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">equals</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">password</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;email&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">exists</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">min_length</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;accept_terms&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">equals</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;yes&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;You must accept the Terms of Service&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_identifier">create_the_user</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">username</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">username</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">password</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">password</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">email</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">email</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">assert_valid</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.validate&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/create-user&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_identifier">assert_valid</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">exists:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">min_length:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">max_length:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">25</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;password&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">exists:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">min_length:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;password_repeat&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">equals:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">password</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;email&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">exists:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">min_length:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;accept_terms&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">equals:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;yes&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;You must accept the Terms of Service&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_identifier">create_the_user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">username:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">username</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">password:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">password</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">email:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">email</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span></code>
</pre>
</div>

</p>

<p><code>assert_valid</code> takes two arguments, a table to be validated, and a second array
table with a list of validations to perform. Each validation is the following format:</p>

<pre><code>{ Validation_Key, [Error_Message], Validation_Function: Validation_Argument, ... }
</code></pre>

<p><code>Validation_Key</code> is the key to fetch from the table being validated.</p>

<p>Any number of validation functions can be provided. If a validation function
takes multiple arguments, pass an array table. (Note: A single table argument
cannot be used, it will be unpacked into arguments.)</p>

<p><code>Error_Message</code> is an optional second positional value. If provided it will be
used as the validation failure error message instead of the default generated
one. Because of how Lua tables work, it can also be provided after the
validation functions as demonstrated in the example above.</p>

<h3><a name="assert-valid/validation-functions" href="#assert-valid/validation-functions">Validation Functions</a></h3>

<ul>
<li><code>exists: true</code> &mdash; check if the value exists and is not an empty string</li>
<li><code>matches_pattern: pat</code> &mdash; value is a string that matches the Lua pattern provided by <code>pat</code></li>
<li><code>min_length: Min_Length</code> &mdash; value must be at least <code>Min_Length</code> chars (Warning: this counts by number of bytes, not characters)</li>
<li><code>max_length: Max_Length</code> &mdash; value must be at most <code>Max_Length</code> chars (Warning: this counts by number of bytes, not characters)</li>
<li><code>is_integer: true</code> &mdash; value matches integer pattern</li>
<li><code>is_color: true</code> &mdash; value matches CSS hex color (eg. <code>#1234AA</code>)</li>
<li><code>is_file: true</code> &mdash; value is an uploaded file, see <a href="utilities.html#file-uploads">File Uploads</a></li>
<li><code>equals: String</code> &mdash; value is equal to String</li>
<li><code>type: String</code> &mdash; type of value is equal to String</li>
<li><code>one_of: {A, B, C, ...}</code> &mdash; value is equal to one of the elements in the array table</li>
</ul>


<h3><a name="assert-valid/optional-validations" href="#assert-valid/optional-validations">Optional validations</a></h3>

<p>You can set <code>optional</code> to true for a validation to make it validate only when
some value is provided. If the parameter&rsquo;s value is <code>nil</code>, then the validation
will skip it without failure.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_identifier">validate</span><span class="sh_operator">.</span><span class="sh_identifier">assert_valid</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;color&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">exists</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">min_length</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">max_length</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">25</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">optional</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">assert_valid</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;color&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">exists:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">min_length:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">max_length:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">25</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">optional:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>
</div>

</p>

<h3><a name="assert-valid/creating-a-custom-validator" href="#assert-valid/creating-a-custom-validator">Creating a Custom Validator</a></h3>

<p>Custom validators for use in <code>assert_valid</code> can be defined like so:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">validate</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.validate&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">validate</span><span class="sh_operator">.</span><span class="sh_identifier">validate_functions</span><span class="sh_operator">.</span><span class="sh_identifier">integer_greater_than</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">input</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">min</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">num</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">tonumber</span><span class="sh_operator">(</span><span class="sh_identifier">input</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">num</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">and</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">num</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">&gt;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">min</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;%s must be greater than &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">min</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_operator">.</span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">validate</span><span class="sh_operator">.</span><span class="sh_identifier">assert_valid</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;number&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">integer_greater_than</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">100</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">validate_functions</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">assert_valid</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.validate&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">validate_functions</span><span class="sh_operator">.</span><span class="sh_identifier">integer_greater_than</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">input</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">min</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">num</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">tonumber</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">input</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">num</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">and</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">num</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">min</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;%s must be greater than #{min}&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">assert_valid</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;number&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">integer_greater_than:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">100</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>
</div>

</p>

<h3><a name="assert-valid/manual-validation" href="#assert-valid/manual-validation">Manual Validation</a></h3>

<p>In addition to <code>assert_valid</code> there is one more useful validation function:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">validate</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.validate&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">validate</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">validate</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.validate&quot;</span></code>
</pre>
</div>

</p>

<ul>
<li><code>validate(object, validation)</code> &mdash; takes the same exact arguments as
<code>assert_valid</code>, but returns either errors or <code>nil</code> on failure instead of
yielding the error.</li>
</ul>


      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Oct  6 22:56:41 2023"></script>
  <script type="text/javascript" src="../reference.js?Fri Oct  6 22:56:41 2023"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
