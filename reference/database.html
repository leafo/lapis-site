<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Database Access - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Wed Dec 14 21:17:53 2022" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.11.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Contents</h2>
            <ul><li><a href="#establishing-a-connection">Establishing A Connection</a></li>
<ul><li><a href="#establishing-a-connection/postgresql">PostgreSQL</a></li>
<li><a href="#establishing-a-connection/mysql">MySQL</a></li></ul>
<li><a href="#making-a-query">Making a Query</a></li>
<li><a href="#query-interface">Query Interface</a></li>
<ul><li><a href="#query-interface/db.query"><code>db.query(query, params...)</code></a></li>
<li><a href="#query-interface/db.select"><code>db.select(query, params...)</code></a></li>
<li><a href="#query-interface/db.insert"><code>db.insert(table, values, opts_or_returning...)</code></a></li>
<li><a href="#query-interface/db.update"><code>db.update(table, values, conditions, params...)</code></a></li>
<li><a href="#query-interface/db.delete"><code>db.delete(table, conditions, params...)</code></a></li>
<li><a href="#query-interface/db.escape_literal"><code>db.escape_literal(value)</code></a></li>
<li><a href="#query-interface/db.escape_identifier"><code>db.escape_identifier(str)</code></a></li>
<li><a href="#query-interface/db.interpolate_query"><code>db.interpolate_query(query, ...)</code></a></li>
<li><a href="#query-interface/db.encode_clause"><code>db.encode_clause(clause_obj)</code></a></li></ul>
<li><a href="#database-primitives">Database Primitives</a></li>
<ul><li><a href="#database-primitives/db.raw"><code>db.raw(str)</code></a></li>
<li><a href="#database-primitives/db.is_raw"><code>db.is_raw(obj)</code></a></li>
<li><a href="#database-primitives/db.list"><code>db.list({values...})</code></a></li>
<li><a href="#database-primitives/db.is_list"><code>db.is_list(obj)</code></a></li>
<li><a href="#database-primitives/db.clause"><code>db.clause({clause...}, opts?)</code></a></li>
<li><a href="#database-primitives/db.is_clause"><code>db.is_clause(obj)</code></a></li>
<li><a href="#database-primitives/db.array"><code>db.array({values...})</code></a></li>
<li><a href="#database-primitives/db.is_array"><code>db.is_array(obj)</code></a></li>
<li><a href="#database-primitives/db.NULL"><code>db.NULL</code></a></li>
<li><a href="#database-primitives/db.TRUE"><code>db.TRUE</code></a></li>
<li><a href="#database-primitives/db.FALSE"><code>db.FALSE</code></a></li></ul>
<li><a href="#database-schemas">Database Schemas <span data-keywords="schema"></span></a></li>
<ul><li><a href="#database-schemas/creating-and-dropping-tables">Creating and Dropping Tables</a></li>
<ul><li><a href="#database-schemas/creating-and-dropping-tables/create_table"><code>create_table(table_name, { table_declarations... })</code></a></li>
<li><a href="#database-schemas/creating-and-dropping-tables/drop_table"><code>drop_table(table_name)</code></a></li></ul>
<li><a href="#database-schemas/indexes">Indexes</a></li>
<ul><li><a href="#database-schemas/indexes/create_index"><code>create_index(table_name, col1, col2..., [options])</code></a></li>
<li><a href="#database-schemas/indexes/drop_index"><code>drop_index(table_name, col1, col2...)</code></a></li></ul>
<li><a href="#database-schemas/altering-tables">Altering Tables</a></li>
<ul><li><a href="#database-schemas/altering-tables/add_column"><code>add_column(table_name, column_name, column_type)</code></a></li>
<li><a href="#database-schemas/altering-tables/drop_column"><code>drop_column(table_name, column_name)</code></a></li>
<li><a href="#database-schemas/altering-tables/rename_column"><code>rename_column(table_name, old_name, new_name)</code></a></li>
<li><a href="#database-schemas/altering-tables/rename_table"><code>rename_table(old_name, new_name)</code></a></li></ul>
<li><a href="#database-schemas/column-types">Column Types</a></li></ul>
<li><a href="#database-migrations">Database Migrations</a></li>
<ul><li><a href="#database-migrations/running-migrations">Running Migrations</a></li>
<li><a href="#database-migrations/manually-running-migrations">Manually Running Migrations</a></li></ul>
<li><a href="#database-helpers">Database Helpers</a></li>
<ul><li><a href="#database-helpers/db.format_date"><code>db.format_date(time)</code></a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Database Access</h1>

<p>Lapis comes with a set of classes and functions for working with either
<a href="http://www.postgresql.org/">PostgreSQL</a> or <a href="https://www.mysql.com/">MySQL</a>. In
the future other databases will be directly supported. In the meantime, you're
free to use other OpenResty database drivers, you just won&rsquo;t have access to
Lapis' query API.</p>

<p>Every query is performed asynchronously through the <a href="http://wiki.nginx.org/HttpLuaModule#ngx.socket.tcp">OpenResty cosocket
API</a>. A request will yield
and resume automatically so there&rsquo;s no need to code with callbacks, queries can
be written sequentially as if they were in a synchronous environment. Additionally
connections to the server are automatically pooled for optimal performance.</p>

<p>Depending on which database you use, a different library is used:</p>

<p><a href="https://github.com/leafo/pgmoon">pgmoon</a> is the driver used to run
PostgreSQL queries. It has the advantage of being able to be used within
OpenResty&rsquo;s cosocket API in addition to on the command line using LuaSocket&rsquo;s
synchronous API.</p>

<p>When in the context of the server,
<a href="https://github.com/openresty/lua-resty-mysql">lua-resty-mysql</a> is the driver
used to run MySQL queries. When on the command line,
<a href="http://keplerproject.github.io/luasql/doc/us/">LuaSQL</a> with MySQL is used.</p>

<h2><a name="establishing-a-connection" href="#establishing-a-connection">Establishing A Connection</a></h2>

<p>You'll need to configure Lapis so it can connect to the database. Lapis manages
a single global database connection (or pool of connections) in the <code>lapis.db</code>
module. It will ensure that you are using connections efficiently, and clean up
any resources automatically. When you first attempt to send a query, Lapis will
automatically prepare a connection for use. It is not necessary to manually
connect or disconnect to the database for standard use.</p>

<p>If you need multiple database connections in the same project then you will
have to manually create and release them.</p>

<h3><a name="establishing-a-connection/postgresql" href="#establishing-a-connection/postgresql">PostgreSQL</a></h3>

<p>To use PostgreSQL create a <code>postgres</code> block in the <span
class="for_moon"><code>config.moon</code></span><span class="for_lua"><code>config.lua</code></span>
file.</p>

<pre class="highlight lang_lua"><code><span class="sh_comment">-- config.lua</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">config</span><span class="sh_operator">(</span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">postgres</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">host</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;127.0.0.1&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;pg_user&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">password</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_password&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">database</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_database&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_comment">-- config.moon</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">postgres</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">host</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;127.0.0.1&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;pg_user&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">password</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_password&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">database</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_database&quot;</span></code>
</pre>


<p><code>host</code> defaults to <code>127.0.0.1</code> and <code>user</code> defaults to <code>postgres</code>, so you can
leave those fields out if they aren&rsquo;t different from the defaults. If a
non-default port is required it can be appended to the <code>host</code> with colon
syntax: <code>my_host:1234</code> (Otherwise <code>5432</code>, the PostgreSQL default, is used).</p>

<h3><a name="establishing-a-connection/mysql" href="#establishing-a-connection/mysql">MySQL</a></h3>

<p>To use MySQL create a <code>mysql</code> block in the <span
class="for_moon"><code>config.moon</code></span><span class="for_lua"><code>config.lua</code></span>
file.</p>

<pre class="highlight lang_lua"><code><span class="sh_comment">-- config.lua</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">config</span><span class="sh_operator">(</span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">mysql</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">host</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;127.0.0.1&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;mysql_user&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">password</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_password&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">database</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_database&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_comment">-- config.moon</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">mysql</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">host</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;127.0.0.1&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;mysql_user&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">password</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_password&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">database</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_database&quot;</span></code>
</pre>


<p>You're now ready to start making queries.</p>

<h2><a name="making-a-query" href="#making-a-query">Making a Query</a></h2>

<p>There are generally two ways to work with the data in your database:</p>

<ol>
<li>The <code>lapis.db</code> module is a collection of functions to make queries to the database, returning the reults as plain Lua tables.</li>
<li>The <a href="models.html"><code>Model</code> class</a> is a wrapper around a Lua table that helps you synchronize it with a row in a database table. When appropriate, the results from the database are converted to instances of the model&rsquo;s class.</li>
</ol>


<p>The <code>Model</code> class is the preferred way to interact with the database. Issuing
queries from the <code>lapis.db</code> module should preferred for achieving things the
<code>Model</code> class is unable to do easily.</p>

<p>Here&rsquo;s an example of how you might use the <code>query</code> function in the <code>lapis.db</code>
module to issue a query to the database:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">(</span><span class="sh_string">&quot;select * from my_table where id = ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">10</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;ok!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">db</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;select * from my_table where id = ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">10</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;ok!&quot;</span></code>
</pre>


<p>And here&rsquo;s how you would accomplish something similar using <code>Model</code> class to
represent rows in a table:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Model</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db.model&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">Model</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">MyTable</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">Model</span><span class="sh_operator">:</span><span class="sh_identifier">extend</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">row</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">MyTable</span><span class="sh_operator">:</span><span class="sh_identifier">find</span><span class="sh_operator">(</span><span class="sh_number">10</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;ok!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Model</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.model&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">MyTable</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Model</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">row</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">MyTable</span><span class="sh_operator">\</span><span class="sh_identifier">find</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">10</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;ok!&quot;</span></code>
</pre>


<p>By default all queries will log to the Nginx notice log. You'll be able to see
each query as it happens.</p>

<p>You can also issue queries in your command line scripts using the same
configuration, just require the model or <code>lapis.db</code> module and start using it.
Keep in mind that your configuration is loaded based on the working directory
of your project, so you should execute your scripts from the same directory as
your <span class="for_moon"><code>config.moon</code></span><span
class="for_lua"><code>config.lua</code></span> file so that you configuration can
be loaded.</p>

<h2><a name="query-interface" href="#query-interface">Query Interface</a></h2>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db&quot;</span></code>
</pre>


<p>The <code>db</code> module provides the following functions:</p>

<h3><a name="query-interface/db.query" href="#query-interface/db.query"><code>db.query(query, params...)</code></a></h3>

<p>Sends a query to the database using an active &amp; available connection. If there
is no connection, then Lapis will automatically allocate &amp; connect one using
the details provided in your configuration.</p>

<p>Returns the results as a Lua table if successful. Will throw an error if the
operation failed.</p>

<p>The first argument is the query to perform. If the query contains any <code>?</code>s then
they are replaced in the order they appear with the remaining arguments. The
remaining arguments are escaped with <code>escape_literal</code> before being
interpolated, making SQL injection impossible.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res1</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">(</span><span class="sh_string">&quot;SELECT * FROM hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res2</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">(</span><span class="sh_string">&quot;UPDATE things SET color = ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;blue&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res3</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">(</span><span class="sh_string">&quot;INSERT INTO cats (age, name, alive) VALUES (?, ?, ?)&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">25</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;dogman&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">res1</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;SELECT * FROM hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">res2</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;UPDATE things SET color = ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;blue&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">res3</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;INSERT INTO cats (age, name, alive) VALUES (?, ?, ?)&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">25</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;dogman&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">SELECT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">*</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">FROM</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">hello</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_keyword">UPDATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">things</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">SET</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">color</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&#x27;blue&#x27;</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_keyword">INSERT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INTO</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">cats</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">age</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">name</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">alive</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">VALUES</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_number">25</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&#x27;dogman&#x27;</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TRUE</span><span class="sh_operator">)</span></code>
</pre>


<p>A query that fails to execute will raise a Lua error. The error will contain
the message from the database along with the query.</p>

<p>Every single function that Lapis provides which communicates with the datbase
will eventually end up calling <code>db.query</code>. The same logic with regards to error
handling and connection management applies to all database operations that
Lapis does.</p>

<h3><a name="query-interface/db.select" href="#query-interface/db.select"><code>db.select(query, params...)</code></a></h3>

<p>Similar to <code>db.query</code>, but it appends <code>"SELECT"</code> to the front of the query.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_function">select</span><span class="sh_operator">(</span><span class="sh_string">&quot;* from hello where active = ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_function">select</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;* from hello where active = ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">SELECT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">*</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">hello</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">where</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">active</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">FALSE</span></code>
</pre>


<h3><a name="query-interface/db.insert" href="#query-interface/db.insert"><code>db.insert(table, values, opts_or_returning...)</code></a></h3>

<p>Inserts a row into <code>table</code>. <code>values</code> is a Lua table of column names and values.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">age</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">10</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello World&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">age:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">10</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello World&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">INSERT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INTO</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_string">&quot;age&quot;</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;name&quot;</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">VALUES</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_number">10</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&#x27;Hello World&#x27;</span><span class="sh_operator">)</span></code>
</pre>


<p>A list of column names to be returned can be given after the value table:</p>

<p><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_operator">(</span><span class="sh_string">&quot;some_other_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello World&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;id&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;some_other_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello World&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;id&quot;</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">INSERT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INTO</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;some_other_table&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_string">&quot;name&quot;</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">VALUES</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_string">&#x27;Hello World&#x27;</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">RETURNING</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;id&quot;</span></code>
</pre>


<blockquote><p><code>RETURNING</code> and <code>ON CONFLICT</code> are PostgreSQL feature, and not available when using MySQL</p></blockquote>

<p>Alternatively, a options table can be provided as third argument with support
for the following fields: (When providing an options table, all other arguments
are ignored)</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>returning</code></td><td><p>An array table of column names or the string <code>'*'</code> to represent all column names. Their values will be return from the insertion query using <code>RETURNING</code> clause to initially populate the model object. <code>db.raw</code> can be used for more advanced expressions</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">color</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;blue&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">returning</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;*&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">created_at</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;2021-4-11 6:6:20&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">returning</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_operator">(</span><span class="sh_string">&quot;date_trunc(&#x27;year&#x27;, created_at) as create_year&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">color:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;blue&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">returning:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;*&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">created_at:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;2021-4-11 6:6:20&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">returning:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;date_trunc(&#x27;year&#x27;, created_at) as create_year&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>on_conflict</code></td><td><p>Control the <code>ON CONFLICT</code> clause for the insertion query. Currently only supports the string value <code>"do_nothing"</code> to do nothing when the query has a conflict</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">color</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;blue&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">on_conflict</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;do_nothing&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">color:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;blue&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">on_conflict:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;do_nothing&quot;</span><span class="sh_symbol sh_embedded">)</span></code>
</pre>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr></tbody></table></p>

<h3><a name="query-interface/db.update" href="#query-interface/db.update"><code>db.update(table, values, conditions, params...)</code></a></h3>

<p>Updates <code>table</code> with <code>values</code> on all rows that match <code>conditions</code>. If
conditions is a plain table or a <code>db.clause</code> object, then it will be converted
to SQL using <code>db.encode_clause</code>.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_operator">(</span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Dogbert 2.0&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">active</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">100</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">active</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Dogbert 2.0&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">active:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">100</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">active:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">UPDATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">SET</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;name&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&#x27;Dogbert 2.0&#x27;</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;active&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TRUE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">WHERE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;id&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">100</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">and</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;active&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">IS</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NULL</span></code>
</pre>


<p>The return value is a table containing the status of the update. The number of
rows updated can be determined by the <code>affected_rows</code> field of the returned
table.</p>

<p><code>conditions</code> can also be a string, the remaining arguments will be interpolated
into the query as if you called <code>db.interpolate_query</code>.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_operator">(</span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">count</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_operator">(</span><span class="sh_string">&quot;count + 1&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;count &gt; ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">10</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">count:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_string">&quot;count + 1&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;count &gt; ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">10</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">UPDATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">SET</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;count&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">count</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">+</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">WHERE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">count</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">&gt;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">10</span></code>
</pre>


<p>When using a table or <code>db.clause</code> argument for conditions, all the extra
arguments are escaped as identifiers and appended as a <code>RETURNING</code> clause:</p>

<p><pre class="highlight lang_lua"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_operator">(</span><span class="sh_string">&quot;cats&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">count</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_operator">(</span><span class="sh_string">&quot;count + 1&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">1200</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;count&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;cats&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">count:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;count + 1&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1200</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;count&quot;</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">UPDATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;cats&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">SET</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;count&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">count</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">+</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">WHERE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;id&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">1200</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">RETURNING</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">count</span></code>
</pre>


<blockquote><p>You can use a <code>db.raw()</code> in place of the returning identifier name to
evaluate a raw sql expression.</p></blockquote>

<p>When using the returning clause the return value of <code>db.update</code> will be an
array of rows generated by the <code>RETURNING</code> expression, in addition to
containing the <code>affected_rows</code> field.</p>

<blockquote><p><code>RETURNING</code> is a PostgreSQL feature, and is not available when using MySQL</p></blockquote>

<h3><a name="query-interface/db.delete" href="#query-interface/db.delete"><code>db.delete(table, conditions, params...)</code></a></h3>

<p>Deletes rows from <code>table</code> that match <code>conditions</code>.</p>

<p>The <code>conditions</code> arugment can either be a Lua table mapping column to value, a
<code>db.clause</code>, or a string as a SQL fragment. When using the string condition,
the remaining arguments as passed as parameters to the SQL fragment as if you
called <code>db.interpolate_query</code>.</p>

<p>The return value is a table containing the status of the delete. The number of
rows deleted can be determined by the <code>affected_rows</code> field of the returned
table.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_operator">(</span><span class="sh_string">&quot;cats&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Roo&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_operator">(</span><span class="sh_string">&quot;cats&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;name = ? and age is null&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Gato&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;cats&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Roo&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;cats&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;name = ? and age is null&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Gato&quot;</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">DELETE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">FROM</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;cats&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">WHERE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;name&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&#x27;Roo&#x27;</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_keyword">DELETE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">FROM</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;cats&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">WHERE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">name</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&#x27;Gato&#x27;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">and</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">age</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">is</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">null</span></code>
</pre>


<p>When using a table argument for conditions, all the extra arguments are
escaped as identifiers and appended as a <code>RETURNING</code> clause:</p>

<p><pre class="highlight lang_lua"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_operator">(</span><span class="sh_string">&quot;cats&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">1200</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;last_updated_at&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;cats&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1200</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;last_updated_at&quot;</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">DELETE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">FROM</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;cats&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">WHERE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;id&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">1200</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">RETURNING</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;last_updated_at&quot;</span></code>
</pre>


<blockquote><p>You can use a <code>db.raw()</code> in place of the returning identifier name to
evaluate a raw sql expression.</p></blockquote>

<p>The return value will now be an array of rows generated by the return values,
in addition to containing the <code>affected_rows</code> field.</p>

<blockquote><p><code>RETURNING</code> is a PostgreSQL feature, and is not available when using MySQL</p></blockquote>

<h3><a name="query-interface/db.escape_literal" href="#query-interface/db.escape_literal"><code>db.escape_literal(value)</code></a></h3>

<p>Escapes a value for use in a query. A value is any type that can be stored in a
column. Numbers, strings, and booleans will be escaped accordingly.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">escaped</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">escape_literal</span><span class="sh_operator">(</span><span class="sh_identifier">value</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">(</span><span class="sh_string">&quot;select * from hello where id = &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">escaped</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">escaped</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">escape_literal</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">value</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;select * from hello where id = #{escaped}&quot;</span></code>
</pre>


<p><code>escape_literal</code> is not appropriate for escaping column or table names. See
<code>escape_identifier</code>.</p>

<h3><a name="query-interface/db.escape_identifier" href="#query-interface/db.escape_identifier"><code>db.escape_identifier(str)</code></a></h3>

<p>Escapes a string for use in a query as an identifier. An identifier is a column
or table name.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">table_name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">escape_identifier</span><span class="sh_operator">(</span><span class="sh_string">&quot;table&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">(</span><span class="sh_string">&quot;select * from &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">table_name</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">table_name</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">escape_identifier</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;table&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;select * from #{table_name}&quot;</span></code>
</pre>


<p><code>escape_identifier</code> is not appropriate for escaping values. See
<code>escape_literal</code> for escaping values.</p>

<h3><a name="query-interface/db.interpolate_query" href="#query-interface/db.interpolate_query"><code>db.interpolate_query(query, ...)</code></a></h3>

<p>Interpolates a query containing <code>?</code> markers with the rest of the arguments
escaped via <code>escape_literal</code>. If a <code>db.clause</code> is passed as one of the
arguments, then it will be encoded using <code>db.encode_clause</code>.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">q</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">interpolate_query</span><span class="sh_operator">(</span><span class="sh_string">&quot;select * from table where value = ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">42</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">(</span><span class="sh_identifier">q</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">q</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">interpolate_query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;select * from table where value = ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">42</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">q</span><span class="sh_moonscript_whitespace sh_whitespace">
</span></code>
</pre>

</p>

<h3><a name="query-interface/db.encode_clause" href="#query-interface/db.encode_clause"><code>db.encode_clause(clause_obj)</code></a></h3>

<p>Generates a boolean SQL expression from an object describing one or many
conditions. The <code>clause</code> argument must be either a plain Lua table or a value
returned by <code>db.clause</code>.</p>

<p>If provided a plain table, then all key, value pairs are taken from the table
using <code>pairs</code>,and converted to an SQL fragment similar to
<code>db.escape_identifier(key) = db.escape_literal(value)</code>, then concatenated with
the <code>AND</code> SQL operator.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">encode_clause</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Garf&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">color</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">list</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;orange&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;ginger&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}),</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">processed_at</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">encode_clause</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Garf&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">color:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">list</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;orange&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;ginger&quot;</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">processed_at:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;color&quot; IN (&#x27;orange&#x27;, &#x27;ginger&#x27;) AND &quot;processed_at&quot; IS NULL AND &quot;name&quot; = &#x27;Garf&#x27;</span></code>
</pre>

</p>

<p>If provided a <code>db.clause</code>, then a richer set of conditions can be described.
See the documentation for <a href="#database-primitives/clause"><code>db.clause</code></a></p>

<p><code>db.encode_clause</code> will throw an error on an empty clause. This is to prevent
the mistake of accidentally providing <code>nil</code> in place of a value of <code>db.NULL</code>
that results in generating a clause that matches a much wider range of data
than desired.</p>

<h2><a name="database-primitives" href="#database-primitives">Database Primitives</a></h2>

<p>To make writing queries easier and safer, Lapis provides a set of basic
primitive types that can be used within your queries for constructing more
complicated values. Generally speaking, you should avoid interpolating data
directly into queries whenever possible as it creates the opportunity for SQL
injection attacks when values aren&rsquo;t properly encoded.</p>

<p>All database primitives constructors and values can be found on the <code>db</code>
module:</p>

<p><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db&quot;</span></code>
</pre>

</p>

<h3><a name="database-primitives/db.raw" href="#database-primitives/db.raw"><code>db.raw(str)</code></a></h3>

<p>Returns a an object wrapping the string argument that will be inserted verbatim
into a query without being escaped. Special care should be taken to avoid
generating invalid SQL and and to avoid introducing SQL injection attacks by
concatenated unsafe data into the string.</p>

<p><code>db.raw</code> can be used inin almost any place where SQL query construction takes
place.  For example, <code>db.escape_literal</code> and <code>db.escape_identifier</code> will both
pass the string through unchanged. It can also be used in <code>db.encode_clause</code>
for both keys and values. You can use it where things like column names or
table names are also requested (eg. <code>db.update</code>)</p>

<p><pre class="highlight lang_lua"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_operator">(</span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">count</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_operator">(</span><span class="sh_string">&quot;count + 1&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_function">select</span><span class="sh_operator">(</span><span class="sh_string">&quot;* from another_table where x = ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_operator">(</span><span class="sh_string">&quot;now()&quot;</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">count:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_string">&quot;count + 1&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_function">select</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;* from another_table where x = ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">raw</span><span class="sh_string">&quot;now()&quot;</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">UPDATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">SET</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;count&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">count</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">+</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_keyword">SELECT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">*</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">another_table</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">where</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">x</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">now</span><span class="sh_operator">()</span></code>
</pre>


<h3><a name="database-primitives/db.is_raw" href="#database-primitives/db.is_raw"><code>db.is_raw(obj)</code></a></h3>

<p>Returns <code>true</code> if <code>obj</code> is a value created by <code>db.raw</code>.</p>

<h3><a name="database-primitives/db.list" href="#database-primitives/db.list"><code>db.list({values...})</code></a></h3>

<p>Returns a special value that will be inserted into the query using SQL&rsquo;s list
syntax. It takes a single argument of an array table. A new object is returned
that wraps the original table. The original table is not modified.</p>

<p>The resulting object can be used in place of a value used within SQL query
generation with functions like <code>interpolate_query</code> and <code>encode_clause</code>. Each
item in the list will be escaped with <code>escape_literal</code> before being inserted
into the query.</p>

<p>Note how when it is used as a value for an SQL clause object, the <code>IN</code> syntax
is used.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">ids</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">list</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_number">3</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_number">5</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_function">select</span><span class="sh_operator">(</span><span class="sh_string">&quot;* from another table where id in ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">ids</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_operator">(</span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">height</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">55</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">ids</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">ids</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">ids</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">list</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_number">3</span><span class="sh_operator">,</span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_number">5</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_function">select</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;* from another table where id in ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">ids</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">height:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">55</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">:ids</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>

</p>

<h3><a name="database-primitives/db.is_list" href="#database-primitives/db.is_list"><code>db.is_list(obj)</code></a></h3>

<p>Returns <code>true</code> if <code>obj</code> is a value created by <code>db.list</code>.</p>

<h3><a name="database-primitives/db.clause" href="#database-primitives/db.clause"><code>db.clause({clause...}, opts?)</code></a></h3>

<p>Creates a <em>clause</em> object that can be encoded into a boolean SQL expression for
filtering or finding operations in the database. A clause object is an
encodable type that can be used in places like <code>db.encode_clause</code> and and
<code>db.interpolate_query</code> to safely generate an SQL fragment where all values are
escaped accordingly. Any built in Lapis functions that can take an object to
filter the affected rows can also take a clause object in place of a query
fragment or plain Lua table.</p>

<p>By default, a clause object will combine all paramters contained with the <code>AND</code>
operator.</p>

<p>When encoded to SQL, the clause object will attempt to extract filters from all
entries in the table:</p>

<ul>
<li>Key, value pairs in the hash-table portion of the clause table will be converted to a SQL fragment similar to <code>db.escape_identifier(key) = db.escape_literal(value)</code>. This mode is aware of booleans and <code>db.list</code> objects to generate the correct syntax</li>
<li>Values in the array portion of the clause table will handled based on their type:

<ul>
<li>String values will be treated as raw SQL fragments that will be concatenated into the clause directly. All string values are warpped in <code>()</code> to ensure there are no precedence issues</li>
<li>Table values will passed to <code>interpolate_query</code> if the sub-table&rsquo;s first item is a string, eg. <code>{"views_count &gt; ?", 100}</code></li>
<li>A <code>nil</code> value will be skipped, meaning you can place conditionals directly inside of the clause</li>
<li>Clause objects can be nested by placing them in the array portion of the clause table</li>
</ul>
</li>
</ul>


<p>Here is an example demonstrating all the different ways of building out a clause:</p>

<p><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">filter</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">12</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;username like &#x27;%admin&#x27;&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">deleted</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">status</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">list</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_number">3</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_number">4</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}),</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;views_count &gt; ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_number">100</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">active</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">promoted</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">operator</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;OR&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">(</span><span class="sh_string">&quot;SELECT * FROM profiles WHERE ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">filter</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">12</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;username like &#x27;%admin&#x27;&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">deleted:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">status:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">list</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_number">3</span><span class="sh_operator">,</span><span class="sh_number">4</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;views_count &gt; ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">100</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">active:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">promoted:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">operator:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;OR&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;SELECT * FROM profiles WHERE ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">filter</span></code>
</pre>

</p>

<p>The following SQL will be generated:</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">SELECT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">*</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">FROM</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">profiles</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">WHERE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">username</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">like</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&#x27;%admin&#x27;</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">AND</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">views_count</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">&gt;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">100</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">AND</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_string">&quot;active&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">OR</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;promoted&quot;</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">AND</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;status&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">IN</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_number">3</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">4</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">AND</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;id&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">12</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">AND</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">not</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;deleted&quot;</span><span class="sh_operator">,</span></code>
</pre>


<p>The second argument can be a table of options. The following properties are
supported:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>operator</code></td><td><p>Change the operator used to join the clause components. eg. <code>AND</code>, <code>OR</code></p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">filter</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">status</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;deleted&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">deleted</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">operator</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;OR&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">encode_clause</span><span class="sh_operator">(</span><span class="sh_identifier">filter</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
   </span><span class="sh_tbl_key sh_regex">status:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;deleted&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
   </span><span class="sh_tbl_key sh_regex">deleted:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">operator:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;OR&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">encode_clause</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;deleted&quot; OR &quot;status&quot; = &#x27;deleted&#x27;</span></code>
</pre>

</details></td><td><p><code>"AND"</code></p>
</td></tr><tr><td><code>table_name</code></td><td><p>Prefixes each named field with the escaped table name. Note that this
does not apply to SQL fragments in the clause. Sub-clauses are also not
affected.</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">filter</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">color</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;green&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">published</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">table_name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;posts&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">encode_clause</span><span class="sh_operator">(</span><span class="sh_identifier">filter</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">color:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;green&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">published:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">table_name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;posts&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">encode_clause</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; &quot;posts&quot;.&quot;color&quot; = &#x27;green&#x27; AND &quot;posts&quot;.&quot;published&quot;</span></code>
</pre>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>allow_empty</code></td><td><p>By default, an empty clause will throw an error when it is attampted to
be encoded. This is to prevent you from accidentally filtering on
something that has a nil value that should actually be provided. You must
set this field to <code>true</code> in order to allow for the empty clause to be
encoded into a query.</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">some_object</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">the_id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">user_id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">something</span><span class="sh_operator">.</span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">some_object</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">the_id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- This will throw an error to prevent you from accidentally deleting all</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">-- rows because of an empty clause created by a nil value</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">clause</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">user_id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">something</span><span class="sh_operator">.</span><span class="sh_identifier">id</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">-- oops, used the wrong field name and set this to nil</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr></tbody></table></p>

<h3><a name="database-primitives/db.is_clause" href="#database-primitives/db.is_clause"><code>db.is_clause(obj)</code></a></h3>

<p>Returns <code>true</code> if <code>obj</code> is a value created by <code>db.clause</code>.</p>

<h3><a name="database-primitives/db.array" href="#database-primitives/db.array"><code>db.array({values...})</code></a></h3>

<p>Converts the argument passed to an array type that will be inserted/updated
using PostgreSQL&rsquo;s array syntax. This function does not exist for MySQL.</p>

<p>The return value of this function can be used in place of any regular value
passed to a SQL query function. Each item in the list will be escaped with
<code>escape_literal</code> before being inserted into the query.</p>

<p><strong>Note:</strong> This function mutates the object passed in by setting its metatable.
The returning object is the same value as the argument. This will allow the
object to still function as a regular Lua array. If you do not want to mutate
the argument, you must make a copy before passing it in.</p>

<p>Additionally, when a query returns an array from the database, it is
automatically converted into a <code>db.array</code>.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_operator">(</span><span class="sh_string">&quot;some_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">tags</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">array</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;world&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">insert</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;some_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">tags:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">array</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world&quot;</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">INSERT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INTO</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;some_table&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_string">&quot;tags&quot;</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">VALUES</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">ARRAY</span><span class="sh_default">[</span><span class="sh_string">&#x27;hello&#x27;</span><span class="sh_operator">,</span><span class="sh_string">&#x27;world&#x27;</span><span class="sh_default">]</span><span class="sh_operator">)</span></code>
</pre>


<h3><a name="database-primitives/db.is_array" href="#database-primitives/db.is_array"><code>db.is_array(obj)</code></a></h3>

<p>Returns <code>true</code> if <code>obj</code> is a table with the <code>PostgresArray</code> metatable (eg. a
value created by <code>db.array</code>)</p>

<h3><a name="database-primitives/db.NULL" href="#database-primitives/db.NULL"><code>db.NULL</code></a></h3>

<p>Represents <code>NULL</code> in SQL syntax. In Lua, <code>nil</code> can&rsquo;t be stored in a table, so the
<code>db.NULL</code> object can be used to provide <code>NULL</code> as a value. When used with
<code>encode_clause</code>, the <code>IS NULL</code> syntax is automatically used.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_operator">(</span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">update</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">UPDATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;the_table&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">SET</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">name</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_default">=</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NULL</span></code>
</pre>


<h3><a name="database-primitives/db.TRUE" href="#database-primitives/db.TRUE"><code>db.TRUE</code></a></h3>

<p>Represents <code>TRUE</code> in SQL syntax. In most cases, it is not necessary to use this
constant, and instead the Lua boolean values can be used.</p>

<h3><a name="database-primitives/db.FALSE" href="#database-primitives/db.FALSE"><code>db.FALSE</code></a></h3>

<p>Represents <code>FALSE</code> in SQL syntax. In most cases, it is not necessary to use this
constant, and instead the Lua boolean values can be used.</p>

<h2><a name="database-schemas" href="#database-schemas">Database Schemas <span data-keywords="schema"></span></a></h2>

<p>Lapis comes with a collection of tools for creating your database schema inside
of the <code>lapis.db.schema</code> module.</p>

<h3><a name="database-schemas/creating-and-dropping-tables" href="#database-schemas/creating-and-dropping-tables">Creating and Dropping Tables</a></h3>

<h4><a name="database-schemas/creating-and-dropping-tables/create_table" href="#database-schemas/creating-and-dropping-tables/create_table"><code>create_table(table_name, { table_declarations... })</code></a></h4>

<p>The first argument to <code>create_table</code> is the name of the table and the second
argument is an array table that describes the table.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db.schema&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">types</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">create_table</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">{</span><span class="sh_string">&quot;id&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">serial</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">{</span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">varchar</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_string">&quot;PRIMARY KEY (id)&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">schema</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.schema&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">create_table</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">create_table</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;id&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">serial</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">varchar</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_string">&quot;PRIMARY KEY (id)&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<blockquote><p>In MySQL you should use <code>types.id</code> to get an autoincrementing primary key ID.
Additionally you should not specify <code>PRIMARY KEY (id)</code> either.</p></blockquote>

<p>This will generate the following SQL:</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">CREATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TABLE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">IF</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NOT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">EXISTS</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_sql_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;id&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">serial</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NOT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NULL</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;username&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">character</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">varying</span><span class="sh_operator">(</span><span class="sh_number">255</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NOT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NULL</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace">
  </span><span class="sh_keyword">PRIMARY</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">KEY</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">id</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_operator">)</span><span class="sh_default">;</span></code>
</pre>


<p>The items in the second argument to <code>create_table</code> can either be a table, or a
string. When the value is a table it is treated as a column/type tuple:</p>

<pre><code>{ column_name, column_type }
</code></pre>

<p>They are both plain strings. The column name will be escaped automatically.
The column type will be inserted verbatim after it is passed through
<code>tostring</code>. <code>schema.types</code> has a collection of common types that can be used.
For example, <code>schema.types.varchar</code> evaluates to <code>character varying(255) NOT
NULL</code>. See more about types below.</p>

<p>If the value to the second argument is a string then it is inserted directly
into the <code>CREATE TABLE</code> statement, that&rsquo;s how we create the primary key above.</p>

<h4><a name="database-schemas/creating-and-dropping-tables/drop_table" href="#database-schemas/creating-and-dropping-tables/drop_table"><code>drop_table(table_name)</code></a></h4>

<p>Drops a table.</p>

<pre class="highlight lang_lua"><code><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">drop_table</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">drop_table</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">drop_table</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span class="sh_keyword">DROP</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TABLE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">IF</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">EXISTS</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_default">;</span></code>
</pre>


<h3><a name="database-schemas/indexes" href="#database-schemas/indexes">Indexes</a></h3>

<h4><a name="database-schemas/indexes/create_index" href="#database-schemas/indexes/create_index"><code>create_index(table_name, col1, col2..., [options])</code></a></h4>

<p><code>create_index</code> is used to add new indexes to a table. The first argument is a
table, the rest of the arguments are the ordered columns that make up the
index. Optionally the last argument can be a Lua table of options.</p>

<p>There are two options <code>unique: BOOL</code>, <code>where: clause_string</code>.</p>

<p><code>create_index</code> will also check if the index exists before attempting to create
it. If the index exists then nothing will happen.</p>

<p>Here are some example indexes:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">create_index</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">create_index</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">create_index</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;created_at&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">create_index</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">unique</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">create_index</span><span class="sh_operator">(</span><span class="sh_string">&quot;posts&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;category&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;title&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">create_index</span><span class="sh_operator">(</span><span class="sh_string">&quot;uploads&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;name&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">where</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;not deleted&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">create_index</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">create_index</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;created_at&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">create_index</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">unique:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">create_index</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;posts&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;category&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;title&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">create_index</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;uploads&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;name&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">where:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;not deleted&quot;</span></code>
</pre>


<p>This will generate the following SQL:</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">CREATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INDEX</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">ON</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">created_at</span><span class="sh_operator">)</span><span class="sh_default">;</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_keyword">CREATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">UNIQUE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INDEX</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">ON</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">username</span><span class="sh_operator">)</span><span class="sh_default">;</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_keyword">CREATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INDEX</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">ON</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;posts&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">category</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">title</span><span class="sh_operator">)</span><span class="sh_default">;</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_keyword">CREATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INDEX</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">ON</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;uploads&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">name</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">WHERE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">not</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_identifier">deleted</span><span class="sh_default">;</span></code>
</pre>


<h4><a name="database-schemas/indexes/drop_index" href="#database-schemas/indexes/drop_index"><code>drop_index(table_name, col1, col2...)</code></a></h4>

<p>Drops an index from a table. It calculates the name of the index from the table
name and columns. This is the same as the default index name generated by
database on creation.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">drop_index</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">drop_index</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">drop_index</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;created_at&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">drop_index</span><span class="sh_operator">(</span><span class="sh_string">&quot;posts&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;title&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;published&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">drop_index</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">drop_index</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;created_at&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">drop_index</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;posts&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;title&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;published&quot;</span></code>
</pre>


<p>This will generate the following SQL:</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">DROP</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INDEX</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">IF</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">EXISTS</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users_created_at_idx&quot;</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_keyword">DROP</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">INDEX</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">IF</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">EXISTS</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;posts_title_published_idx&quot;</span></code>
</pre>


<h3><a name="database-schemas/altering-tables" href="#database-schemas/altering-tables">Altering Tables</a></h3>

<h4><a name="database-schemas/altering-tables/add_column" href="#database-schemas/altering-tables/add_column"><code>add_column(table_name, column_name, column_type)</code></a></h4>

<p>Adds a column to a table.</p>

<pre class="highlight lang_lua"><code><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">add_column</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;age&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">add_column</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">add_column</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;age&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span></code>
</pre>


<p>Generates the SQL:</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">ALTER</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TABLE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">ADD</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">COLUMN</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;age&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">integer</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NOT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NULL</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">DEFAULT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_number">0</span></code>
</pre>


<h4><a name="database-schemas/altering-tables/drop_column" href="#database-schemas/altering-tables/drop_column"><code>drop_column(table_name, column_name)</code></a></h4>

<p>Removes a column from a table.</p>

<pre class="highlight lang_lua"><code><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">drop_column</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;age&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">drop_column</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">drop_column</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;age&quot;</span></code>
</pre>


<p>Generates the SQL:</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">ALTER</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TABLE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">DROP</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">COLUMN</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;age&quot;</span></code>
</pre>


<h4><a name="database-schemas/altering-tables/rename_column" href="#database-schemas/altering-tables/rename_column"><code>rename_column(table_name, old_name, new_name)</code></a></h4>

<p>Changes the name of a column.</p>

<pre class="highlight lang_lua"><code><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">rename_column</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;age&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lifespan&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">rename_column</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">rename_column</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;age&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lifespan&quot;</span></code>
</pre>


<p>Generates the SQL:</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">ALTER</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TABLE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">RENAME</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">COLUMN</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;age&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TO</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lifespan&quot;</span></code>
</pre>


<h4><a name="database-schemas/altering-tables/rename_table" href="#database-schemas/altering-tables/rename_table"><code>rename_table(old_name, new_name)</code></a></h4>

<p>Changes the name of a table.</p>

<pre class="highlight lang_lua"><code><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">rename_table</span><span class="sh_operator">(</span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;members&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">rename_table</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">rename_table</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;members&quot;</span></code>
</pre>


<p>Generates the SQL:</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">ALTER</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TABLE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;users&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">RENAME</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TO</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;members&quot;</span></code>
</pre>


<h3><a name="database-schemas/column-types" href="#database-schemas/column-types">Column Types</a></h3>

<p>All of the column type generators are stored in <code>schema.types</code>. All the types
are special objects that can either be turned into a type declaration string
with <code>tostring</code>, or called like a function to be customized.</p>

<p>Here are all the default values:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db.schema&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">types</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">boolean</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; boolean NOT NULL DEFAULT FALSE</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">date</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; date NOT NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">double</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">        </span><span class="sh_comment">--&gt; double precision NOT NULL DEFAULT 0</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">foreign_key</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">   </span><span class="sh_comment">--&gt; integer NOT NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; integer NOT NULL DEFAULT 0</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">numeric</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; numeric NOT NULL DEFAULT 0</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">real</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; real NOT NULL DEFAULT 0</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">serial</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">        </span><span class="sh_comment">--&gt; serial NOT NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">text</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; text NOT NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">time</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; timestamp without time zone NOT NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">varchar</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; character varying(255) NOT NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">enum</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; smallint NOT NULL</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.schema&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">boolean</span><span class="sh_moonscript_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; boolean NOT NULL DEFAULT FALSE</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">date</span><span class="sh_moonscript_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; date NOT NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">double</span><span class="sh_moonscript_whitespace sh_whitespace">        </span><span class="sh_comment">--&gt; double precision NOT NULL DEFAULT 0</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">foreign_key</span><span class="sh_moonscript_whitespace sh_whitespace">   </span><span class="sh_comment">--&gt; integer NOT NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span><span class="sh_moonscript_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; integer NOT NULL DEFAULT 0</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">numeric</span><span class="sh_moonscript_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; numeric NOT NULL DEFAULT 0</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">real</span><span class="sh_moonscript_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; real NOT NULL DEFAULT 0</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">serial</span><span class="sh_moonscript_whitespace sh_whitespace">        </span><span class="sh_comment">--&gt; serial NOT NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">text</span><span class="sh_moonscript_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; text NOT NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">time</span><span class="sh_moonscript_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; timestamp without time zone NOT NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">varchar</span><span class="sh_moonscript_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; character varying(255) NOT NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">enum</span><span class="sh_moonscript_whitespace sh_whitespace">          </span><span class="sh_comment">--&gt; smallint NOT NULL</span></code>
</pre>


<p>You'll notice everything is <code>NOT NULL</code> by default, and the numeric types have
defaults of 0 and boolean false.</p>

<p>When a type is called like a function it takes one argument, a table of
options. The options include:</p>

<ul>
<li><code>default: value</code> &mdash; sets default value</li>
<li><code>null: boolean</code> &mdash; determines if the column is <code>NOT NULL</code></li>
<li><code>unique: boolean</code> &mdash; determines if the column has a unique index</li>
<li><code>primary_key: boolean</code> &mdash; determines if the column is the primary key</li>
<li><code>array: bool|number</code> &mdash; makes the type an array (PostgreSQL Only), pass number to set how many dimensions the array is, <code>true</code> == <code>1</code></li>
</ul>


<p>Here are some examples:</p>

<pre class="highlight lang_lua"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">default</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">null</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">--&gt; integer DEFAULT 1</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">primary_key</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">        </span><span class="sh_comment">--&gt; integer NOT NULL DEFAULT 0 PRIMARY KEY</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">text</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">null</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">                  </span><span class="sh_comment">--&gt; text</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">varchar</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">primary_key</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">        </span><span class="sh_comment">--&gt; character varying(255) NOT NULL PRIMARY KEY</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">real</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">array</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">                 </span><span class="sh_comment">--&gt; real[]</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">default:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">null:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">--&gt; integer DEFAULT 1</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">primary_key:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; integer NOT NULL DEFAULT 0 PRIMARY KEY</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">text</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">null:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">                 </span><span class="sh_comment">--&gt; text</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">varchar</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">primary_key:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">       </span><span class="sh_comment">--&gt; character varying(255) NOT NULL PRIMARY KEY</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">real</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">array:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">                </span><span class="sh_comment">--&gt; real[]</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">text</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">array:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_moonscript_whitespace sh_whitespace">                   </span><span class="sh_comment">--&gt; text[][]</span></code>
</pre>


<blockquote><p>MySQL has a complete different type set than PostgreSQL, see <a href="https://github.com/leafo/lapis/blob/master/lapis/db/mysql/schema.moon#L162">MySQL types</a></p></blockquote>

<h2><a name="database-migrations" href="#database-migrations">Database Migrations</a></h2>

<p>Because requirements typically change over the lifespan of a web application
it&rsquo;s useful to have a system to make incremental schema changes to the
database.</p>

<p>We define migrations in our code as a table of functions where the key of each
function in the table is the name of the migration. You are free to name the
migrations anything but it&rsquo;s suggested to give them Unix timestamps as names:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db.schema&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">[</span><span class="sh_number">1368686109</span><span class="sh_operator">]</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">add_column</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_operator">[</span><span class="sh_number">1368686843</span><span class="sh_operator">]</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">create_index</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">add_column</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">create_index</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.schema&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_number">1368686109</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">add_column</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">integer</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_number">1368686843</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">create_index</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_table&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<p>A migration function is a plain function. Generally they will call the
schema functions described above, but they don&rsquo;t have to.</p>

<p>Only the functions that haven&rsquo;t already been executed will be called when we
tell our migrations to run. The migrations that have already been run are
stored in the migrations table, a database table that holds the names of the
migrations that have already been run. Migrations are run in the order of their
keys sorted ascending.</p>

<h3><a name="database-migrations/running-migrations" href="#database-migrations/running-migrations">Running Migrations</a></h3>

<p>The Lapis command line tool has a special command for running migrations. It&rsquo;s
called <code>lapis migrate</code>.</p>

<p>This command expects a module called <code>migrations</code> that returns a table of
migrations in the format described above.</p>

<p>Let&rsquo;s create this file with a single migration as an example.</p>

<pre class="highlight lang_lua"><code><span class="sh_comment">-- migrations.lua</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db.schema&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">types</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">[</span><span class="sh_number">1</span><span class="sh_operator">]</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">schema</span><span class="sh_operator">.</span><span class="sh_identifier">create_table</span><span class="sh_operator">(</span><span class="sh_string">&quot;articles&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;id&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">serial</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;title&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">text</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;content&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">text</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">

      </span><span class="sh_string">&quot;PRIMARY KEY (id)&quot;</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_comment">-- migrations.moon</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">create_table</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.schema&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_number">1</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">create_table</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;articles&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;id&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">serial</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;title&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">text</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;content&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">types</span><span class="sh_operator">.</span><span class="sh_identifier">text</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

      </span><span class="sh_string">&quot;PRIMARY KEY (id)&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<p>After creating the file, ensure that it is compiled to Lua and run <code>lapis
migrate</code>. The command will first create the migrations table if it doesn&rsquo;t
exist yet then it will run every migration that hasn&rsquo;t been executed yet.</p>

<p>Read more about <a href="command_line.html#command-reference/lapis-migrate">the migrate command</a>.</p>

<h3><a name="database-migrations/manually-running-migrations" href="#database-migrations/manually-running-migrations">Manually Running Migrations</a></h3>

<p>We can manually create the migrations table using the following code:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">migrations</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db.migrations&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">migrations</span><span class="sh_operator">.</span><span class="sh_identifier">create_migrations_table</span><span class="sh_operator">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">migrations</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.migrations&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">migrations</span><span class="sh_operator">.</span><span class="sh_identifier">create_migrations_table</span><span class="sh_operator">!</span></code>
</pre>


<p>It will execute the following SQL:</p>

<pre class="highlight lang_sql"><code><span class="sh_keyword">CREATE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">TABLE</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">IF</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NOT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">EXISTS</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis_migrations&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_sql_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;name&quot;</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">character</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">varying</span><span class="sh_operator">(</span><span class="sh_number">255</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NOT</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">NULL</span><span class="sh_operator">,</span><span class="sh_sql_whitespace sh_whitespace">
  </span><span class="sh_keyword">PRIMARY</span><span class="sh_sql_whitespace sh_whitespace"> </span><span class="sh_keyword">KEY</span><span class="sh_operator">(</span><span class="sh_identifier">name</span><span class="sh_operator">)</span><span class="sh_sql_whitespace sh_whitespace">
</span><span class="sh_operator">)</span><span class="sh_default">;</span></code>
</pre>


<p>Then we can manually run migrations with the following code:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">migrations</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db.migrations&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">migrations</span><span class="sh_operator">.</span><span class="sh_identifier">run_migrations</span><span class="sh_operator">(</span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;migrations&quot;</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">run_migrations</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.migrations&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">run_migrations</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;migrations&quot;</span></code>
</pre>


<h2><a name="database-helpers" href="#database-helpers">Database Helpers</a></h2>

<p>These are additional helper functions from the <code>db</code> module that
aren&rsquo;t directly related to the query interface.</p>

<h4><a name="database-helpers/db.format_date" href="#database-helpers/db.format_date"><code>db.format_date(time)</code></a></h4>

<p>Returns a date string formatted properly for insertion in the database.</p>

<p>The <code>time</code> argument is optional, will default to the current UTC time.</p>

<p><pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">date</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">format_date</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_operator">(</span><span class="sh_string">&quot;update things set published_at = ?&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">date</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">date</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">format_date</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">query</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;update things set published_at = ?&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">date</span></code>
</pre>

</p>

      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Wed Dec 14 21:17:53 2022"></script>
  <script type="text/javascript" src="../reference.js?Wed Dec 14 21:17:53 2022"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
