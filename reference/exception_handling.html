<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exception Handling - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Mar  8 20:35:45 2024" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.16.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Exception Handling</h2>
            <ul><li><a href="#the-kinds-of-errors">The Kinds of Errors</a></li>
<li><a href="#capturing-recoverable-errors">Capturing Recoverable Errors</a></li>
<li><a href="#error-handling-functions">Error Handling Functions</a></li>
<ul><li><a href="#error-handling-functions/capture_errors"><code>capture_errors(fn, [error_handler_fn])</code></a></li>
<li><a href="#error-handling-functions/capture_errors_json"><code>capture_errors_json(fn)</code></a></li>
<li><a href="#error-handling-functions/yield_error"><code>yield_error(msg)</code></a></li>
<li><a href="#error-handling-functions/assert_error"><code>assert_error(cond, ...)</code></a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Exception Handling</h1>

<h2><a name="the-kinds-of-errors" href="#the-kinds-of-errors">The Kinds of Errors</a></h2>

<p>Lapis makes a distinction between two kinds of errors: Recoverable and
non-recoverable errors. Errors thrown by Lua&rsquo;s runtime during execution or
calls to  <code>error</code> are considered non-recoverable. (This also includes the Lua
built-in function <code>assert</code>)</p>

<p>Because non-recoverable errors aren&rsquo;t expected to be captured by the user,
Lapis catches them and prints an exception message to the browser. Any action
that may have been running is aborted and Lapis prints a special view showing
the stack trace along with setting the status to <code>500</code>.</p>

<p>These kinds of errors typically are an indicator of a bug or other serious
issue and should be fixed.</p>

<p>Recoverable errors are a user controlled way of aborting the execution of an
action to run a special error handling function. They are implemented using
coroutines instead of Lua&rsquo;s error system.</p>

<p>Examples include non-valid inputs from users, or missing records from the
database.</p>

<h2><a name="capturing-recoverable-errors" href="#capturing-recoverable-errors">Capturing Recoverable Errors</a></h2>

<p>The <code>capture_errors</code> helper is used wrap an action such that it can capture
errors and run an error handler.</p>

<p>This does not capture runtime errors. You should use <code>pcall</code> if you
want to capture runtime errors as you would normally do in Lua.</p>

<p>Lua doesn&rsquo;t have the concept of exceptions like most other languages. Instead
Lapis creates an exception handling system using coroutines. We must define the
scope in which we will capture errors. We do that using the <code>capture_errors</code>
helper. Then we can throw a raw error using <code>yield_error</code>.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">yield_error</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_operator">.</span><span class="sh_identifier">capture_errors</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_operator">.</span><span class="sh_identifier">yield_error</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/do_something&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">yield_error</span><span class="sh_operator">(</span><span class="sh_string">&quot;something bad happened&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">yield_error</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/do_something&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">yield_error</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;something bad happened&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;Hello!&quot;</span></code>
</pre>


<p>What happens when there is an error? The action will stop executing at the
first error, and then the error handler is run. The default error handler will
set an array-like table of errors in <span
class="for_moon"><code>@errors</code></span><span class="for_lua"><code>self.errors</code></span> and
return <span class="for_moon"><code>render: true</code></span><span class="for_lua"><code>{
render = true }</code></span>. In your view you can then display the errors. This
means that if you have a named route the view of that route will render. You
should then code your view to sometimes have a <code>errors</code> table.</p>

<p>If you want to have a custom error handler you can invoke <code>capture_errors</code> with
a table: (note that <span class="for_moon"><code>@errors</code></span><span
class="for_lua"><code>self.errors</code></span> is set before the custom handler)</p>

<pre class="highlight lang_lua"><code><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/do_something&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">on_error</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">log_errors</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">errors</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">-- you would supply the log_errors function</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_error_page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">500</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">bad_thing</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">yield_error</span><span class="sh_operator">(</span><span class="sh_string">&quot;something bad happened&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/do_something&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">on_error:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">log_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">-- you would supply the log_errors function</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_error_page&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">status:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">500</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">bad_thing</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_identifier">yield_error</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;something bad happened&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<p><code>capture_errors</code> when called with a table will use the first positional value
as the action.</p>

<p>If you're building a JSON API then another method is provided,
<code>capture_errors_json</code>, which renders the errors in a JSON object like so:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors_json</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">yield_error</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_operator">.</span><span class="sh_identifier">capture_errors_json</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_operator">.</span><span class="sh_identifier">yield_error</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors_json</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">yield_error</span><span class="sh_operator">(</span><span class="sh_string">&quot;something bad happened&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors_json</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">yield_error</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors_json</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">yield_error</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;something bad happened&quot;</span></code>
</pre>


<p>Would render (with the correct content type):</p>

<pre class="highlight lang_json"><code><span class="sh_operator">{</span><span class="sh_json_whitespace sh_whitespace"> </span><span class="sh_default">errors</span><span class="sh_operator">:</span><span class="sh_json_whitespace sh_whitespace"> </span><span class="sh_operator">[</span><span class="sh_string">&quot;something bad happened&quot;</span><span class="sh_operator">]</span><span class="sh_json_whitespace sh_whitespace"> </span><span class="sh_operator">}</span></code>
</pre>


<h2><a name="error-handling-functions" href="#error-handling-functions">Error Handling Functions</a></h2>

<p>All of these functions are available in the <code>lapis.application</code> module.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">application</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">application</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="error-handling-functions/capture_errors" href="#error-handling-functions/capture_errors"><code>capture_errors(fn, [error_handler_fn])</code></a></h3>

<p>Wraps action action handler <code>fn</code> in a coroutine that will look for errors
thrown by <code>yield_error</code> or <code>assert_error</code>.</p>

<p>As a convenience, <code>fn</code> can also be a table. In that case, then the first item
of the table will be used as the <code>fn</code> and the <code>on_error</code> field will be used as
the <code>error_handler_fn</code></p>

<p>The default <code>error_handler_fn</code> will return <code>{render = true}</code>, but <code>self.errors</code>
will be set on the request object as a Lua array table containing all of the
errors that have been captured. Keep in mind this will attempt to render the
default view based on the name of the route. If your route does not have a
name, then this will cause the request to fail with an exception.</p>

<p>If providing a custom error handler, it can be written as a standard action
handler function. The return value is used to control how the response is
written. Things like status codes and redirects can be used as normally.</p>

<h3><a name="error-handling-functions/capture_errors_json" href="#error-handling-functions/capture_errors_json"><code>capture_errors_json(fn)</code></a></h3>

<p>Similar to <code>capture_errors</code> but provides a default error handler that returns
<code>self.errors</code> as a JSON response. Here is the full implementation:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors_json</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">capture_errors_json</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">fn</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">(</span><span class="sh_identifier">fn</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">json</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
        </span><span class="sh_identifier">errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">errors</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">capture_errors_json</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">fn</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">fn</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">json:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">errors:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>
</div>

</p>

<h3><a name="error-handling-functions/yield_error" href="#error-handling-functions/yield_error"><code>yield_error(msg)</code></a></h3>

<p>Sends an error message up to the wrapping <code>capture_errors</code>. The coroutine is
never resumed on error so the any code following <code>yield_error</code> will not
execute.</p>

<h3><a name="error-handling-functions/assert_error" href="#error-handling-functions/assert_error"><code>assert_error(cond, ...)</code></a></h3>

<p>It is idiomatic in Lua to return <code>nil</code> and an error message from a function
when it fails. For this reason the helper <code>assert_error</code> exists. If the first
argument is falsey (<code>nil</code> or <code>false</code>) then the second argument is thrown as an
error, otherwise all the arguments are returned from the function unchanged.</p>

<p><code>assert_error</code> is very handy with database methods, which make use of this
idiom.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">assert_error</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_operator">.</span><span class="sh_identifier">capture_errors</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_operator">.</span><span class="sh_identifier">assert_error</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">assert_error</span><span class="sh_operator">(</span><span class="sh_identifier">Users</span><span class="sh_operator">:</span><span class="sh_identifier">find</span><span class="sh_operator">({</span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_operator">}))</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;result: &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">user</span><span class="sh_operator">.</span><span class="sh_identifier">id</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span><span class="sh_lua_whitespace sh_whitespace">
</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">assert_error</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">user</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">assert_error</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_operator">\</span><span class="sh_identifier">find</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">id:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;result: #{user.id}&quot;</span></code>
</pre>


<p>If you call this function not within a <code>capture_errors</code> context, then a hard
Lua <code>error</code> will be thrown.</p>

      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Mar  8 20:35:45 2024"></script>
  <script type="text/javascript" src="../reference.js?Fri Mar  8 20:35:45 2024"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
