<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Utilities - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Mar  8 20:35:45 2024" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.16.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Utilities</h2>
            <ul><li><a href="#functions">Functions <span stat-keyword="util"></span></a></li>
<ul><li><a href="#functions/unescape"><code>unescape(str)</code></a></li>
<li><a href="#functions/escape"><code>escape(str)</code></a></li>
<li><a href="#functions/escape_pattern"><code>escape_pattern(str)</code></a></li>
<li><a href="#functions/parse_query_string"><code>parse_query_string(str)</code></a></li>
<li><a href="#functions/encode_query_string"><code>encode_query_string(tbl)</code></a></li>
<li><a href="#functions/underscore"><code>underscore(str)</code></a></li>
<li><a href="#functions/slugify"><code>slugify(str)</code></a></li>
<li><a href="#functions/uniquify"><code>uniquify(tbl)</code></a></li>
<li><a href="#functions/trim"><code>trim(str)</code></a></li>
<li><a href="#functions/trim_all"><code>trim_all(tbl)</code></a></li>
<li><a href="#functions/trim_filter"><code>trim_filter(tbl, [{keys ...}], [empty_val=nil])</code></a></li>
<li><a href="#functions/to_json"><code>to_json(obj)</code></a></li>
<li><a href="#functions/from_json"><code>from_json(str)</code></a></li>
<li><a href="#functions/time_ago_in_words"><code>time_ago_in_words(date, [parts=1], [suffix="ago"])</code></a></li>
<li><a href="#functions/autoload"><code>autoload(prefix, tbl={})</code></a></li></ul>
<li><a href="#encoding-methods">Encoding Methods</a></li>
<ul><li><a href="#encoding-methods/encode_base64"><code>encode_base64(str)</code></a></li>
<li><a href="#encoding-methods/decode_base64"><code>decode_base64(str)</code></a></li>
<li><a href="#encoding-methods/hmac_sha1"><code>hmac_sha1(secret, str)</code></a></li>
<li><a href="#encoding-methods/encode_with_secret"><code>encode_with_secret(object, secret=config.secret)</code></a></li>
<li><a href="#encoding-methods/decode_with_secret"><code>decode_with_secret(msg_and_sig, secret=config.secret)</code></a></li></ul>
<li><a href="#csrf-protection">CSRF Protection</a></li>
<ul><li><a href="#csrf-protection/csrf.generate_token"><code>csrf.generate_token(req, data=nil)</code></a></li>
<li><a href="#csrf-protection/csrf.validate_token"><code>csrf.validate_token(req, callback=nil)</code></a></li>
<li><a href="#csrf-protection/csrf.assert_token"><code>csrf.assert_token(...)</code></a></li></ul>
<li><a href="#making-http-requests">Making HTTP Requests</a></li>
<ul><li><a href="#making-http-requests/http.request"><code>http.request(url_or_table, body)</code></a></li>
<li><a href="#making-http-requests/http.simple"><code>http.simple(req, body)</code></a></li></ul>
<li><a href="#caching">Caching</a></li>
<ul><li><a href="#caching/cache.cached"><code>cache.cached(fn_or_tbl)</code></a></li>
<li><a href="#caching/cache.delete"><code>cache.delete(key, [dict_name="page_cache"])</code></a></li>
<li><a href="#caching/cache.delete_all"><code>cache.delete_all([dict_name="page_cache"])</code></a></li>
<li><a href="#caching/cache.delete_path"><code>cache.delete_path(path, [dict_name="page_cache"])</code></a></li></ul>
<li><a href="#file-uploads">File Uploads</a></li>
<li><a href="#application-helpers">Application Helpers</a></li>
<ul><li><a href="#application-helpers/respond_to"><code>respond_to(verbs_to_fn={})</code></a></li>
<li><a href="#application-helpers/capture_errors"><code>capture_errors(fn_or_tbl)</code></a></li>
<li><a href="#application-helpers/capture_errors_json"><code>capture_errors_json(fn)</code></a></li>
<li><a href="#application-helpers/yield_error"><code>yield_error(error_message)</code></a></li>
<li><a href="#application-helpers/obj"><code>obj, msg, ... = assert_error(obj, msg, ...)</code></a></li>
<li><a href="#application-helpers/json_params"><code>json_params(fn)</code></a></li></ul>
<li><a href="#utf8">UTF8</a></li>
<ul><li><a href="#utf8/utf8.trim"><code>utf8.trim</code></a></li>
<li><a href="#utf8/utf8.printable_character"><code>utf8.printable_character</code></a></li>
<li><a href="#utf8/utf8.whitepace"><code>utf8.whitepace</code></a></li>
<li><a href="#utf8/utf8.string_length"><code>utf8.string_length</code></a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Utilities</h1>

<h2><a name="functions" href="#functions">Functions <span stat-keyword="util"></span></a></h2>

<p>Utility functions are found in:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/unescape" href="#functions/unescape"><code>unescape(str)</code></a></h3>

<p>URL unescapes string, returning the resulting string.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">original_string</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello%2C%20World%21&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">unescaped_string</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">unescape</span><span class="sh_operator">(</span><span class="sh_identifier">original_string</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">unescaped_string</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;Hello, World!&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">original_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello%2C%20World%21&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">unescaped_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">unescape</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">original_string</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">unescaped_string</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;Hello, World!&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/escape" href="#functions/escape"><code>escape(str)</code></a></h3>

<p>URL escapes string, returning the resulting string.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">original_string</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello, World!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">escaped_string</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">escape</span><span class="sh_operator">(</span><span class="sh_identifier">original_string</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">escaped_string</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;Hello%2C%20World%21&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">original_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello, World!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">escaped_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">escape</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">original_string</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">escaped_string</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;Hello%2C%20World%21&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/escape_pattern" href="#functions/escape_pattern"><code>escape_pattern(str)</code></a></h3>

<p>Escapes string for use in Lua pattern. This function is useful for instances
where you want to use a string as a pattern in Lua&rsquo;s string matching functions,
but the string may contain special characters that have special meanings in Lua
patterns.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">pattern</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">escape_pattern</span><span class="sh_operator">(</span><span class="sh_string">&quot;[special]&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">pattern</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;%[special%]&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">pattern</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">escape_pattern</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;[special]&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">pattern</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;%[special%]&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/parse_query_string" href="#functions/parse_query_string"><code>parse_query_string(str)</code></a></h3>

<p>Parses a query string into a table. Note that if query keys do not include a
value, their value will be set to <code>true</code> in the table. Each parsed tuple is
inserted into the table in two ways: first as a <code>[key] = value</code>, which overwrites any
existing keys, and secondly, it is appended to the end of the array portion of the table
as <code>{key, value}</code>.</p>

<blockquote><p>The query string being parsed should not start with a &lsquo;?&rsquo;. The function only
processes the key-value pairs and does not handle the &lsquo;?&rsquo; character typically
used at the start of query strings in URLs.</p></blockquote>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">query_table</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">parse_query_string</span><span class="sh_operator">(</span><span class="sh_string">&quot;key1=value1&amp;key2&amp;key1=value2&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">query_table</span><span class="sh_operator">[</span><span class="sh_string">&quot;key1&quot;</span><span class="sh_operator">])</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- &quot;value2&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">query_table</span><span class="sh_operator">[</span><span class="sh_string">&quot;key2&quot;</span><span class="sh_operator">])</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- true</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- numeric indicies showing duplicates</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_deprecated_function sh_function">unpack</span><span class="sh_operator">(</span><span class="sh_identifier">query_table</span><span class="sh_operator">[</span><span class="sh_number">1</span><span class="sh_operator">]))</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- &quot;key1&quot;, &quot;value1&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_deprecated_function sh_function">unpack</span><span class="sh_operator">(</span><span class="sh_identifier">query_table</span><span class="sh_operator">[</span><span class="sh_number">2</span><span class="sh_operator">]))</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- &quot;key2&quot;, true</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_deprecated_function sh_function">unpack</span><span class="sh_operator">(</span><span class="sh_identifier">query_table</span><span class="sh_operator">[</span><span class="sh_number">3</span><span class="sh_operator">]))</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- &quot;key1&quot;, &quot;value2&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">query_table</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">parse_query_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;key1=value1&amp;key2&amp;key1=value2&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">query_table</span><span class="sh_symbol sh_embedded">[</span><span class="sh_string">&quot;key1&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- &quot;value2&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">query_table</span><span class="sh_symbol sh_embedded">[</span><span class="sh_string">&quot;key2&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- true</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- numeric indicies showing duplicates</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">unpack</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">query_table</span><span class="sh_symbol sh_embedded">[</span><span class="sh_number">1</span><span class="sh_symbol sh_embedded">]</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- &quot;key1&quot;, &quot;value1&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">unpack</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">query_table</span><span class="sh_symbol sh_embedded">[</span><span class="sh_number">2</span><span class="sh_symbol sh_embedded">]</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- &quot;key2&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">unpack</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">query_table</span><span class="sh_symbol sh_embedded">[</span><span class="sh_number">1</span><span class="sh_symbol sh_embedded">]</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- &quot;key1&quot;, &quot;value2&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/encode_query_string" href="#functions/encode_query_string"><code>encode_query_string(tbl)</code></a></h3>

<p>Converts a key-value table into a query string. For ordered query strings, the
numeric indices of the table can also be a table in the form <code>{key, value}</code>.
The two formats can be mixed into the same table and all parameters will be encoded.</p>

<blockquote><p>The output of <code>parse_query_string</code>, if passed directly into
<code>encode_query_string</code>, will cause duplicates due to the parsing structure. To
re-encode, either strip the hash table parts or strip the numeric indices.</p></blockquote>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">example1</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">encode_query_string</span><span class="sh_operator">({</span><span class="sh_identifier">key1</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;value1&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">key2</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">example1</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;key1=value1&amp;key2&quot;</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- example with numeric indices pairs that guarantees output order</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">example2</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">encode_query_string</span><span class="sh_operator">({{</span><span class="sh_identifier">key1</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;value1&quot;</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_identifier">key2</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_operator">}})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">example2</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;key1=value1&amp;key2&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">example1</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">encode_query_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_tbl_key sh_regex">key1:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;value1&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">key2:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">example1</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;key1=value1&amp;key2&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- example with numeric indices pairs that guarantees output order</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">example2</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">encode_query_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{{</span><span class="sh_string">&quot;key1&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;value1&quot;</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;key2&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_symbol sh_embedded">}}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">example2</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;key1=value1&amp;key2&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/underscore" href="#functions/underscore"><code>underscore(str)</code></a></h3>

<p>Convert CamelCase to camel_case. This is used in various parts of Lapis, such
as handling the automatic translation of names like converting a class name to
a database table name.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">underscored</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">underscore</span><span class="sh_operator">(</span><span class="sh_string">&quot;CamelCase&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">underscored</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;camel_case&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">underscored</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">underscore</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;CamelCase&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">underscored</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;camel_case&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/slugify" href="#functions/slugify"><code>slugify(str)</code></a></h3>

<p>Converts a string to a slug suitable for a URL. Removes all whitespace and
symbols and replaces them with <code>-</code>.</p>

<blockquote><p>It might be worthwhile to check if the output is an empty string, to ensure
that a slug could be generated from the input string. For example, a string
composed entirely of symbols will be converted into an empty string.</p></blockquote>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">slug</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">slugify</span><span class="sh_operator">(</span><span class="sh_string">&quot;Hello World!&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">slug</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;hello-world&quot;</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">slug2</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">slugify</span><span class="sh_operator">(</span><span class="sh_string">&quot;!!!@@@###$$$&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">slug2</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">slug</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">slugify</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Hello World!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">slug</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;hello-world&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">slug2</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">slugify</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;!!!@@@###$$$&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">slug2</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/uniquify" href="#functions/uniquify"><code>uniquify(tbl)</code></a></h3>

<p>Iterates over the array table <code>tbl</code>, appending all unique values into a new
array table, and then returns this new table. The original table is not
modified; a new table is always returned.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">unique_table</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">uniquify</span><span class="sh_operator">({</span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_deprecated_function sh_function">unpack</span><span class="sh_operator">(</span><span class="sh_identifier">unique_table</span><span class="sh_operator">))</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: 1, 2, 3</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">unique_table</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">uniquify</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">3</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">unpack</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">unique_table</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: 1, 2, 3</span></code>
</pre>
</div>

</p>

<h3><a name="functions/trim" href="#functions/trim"><code>trim(str)</code></a></h3>

<p>Trims the whitespace from both sides of a string. Note that this function is
only aware of ASCII whitespace characters, such as space, newline, tab, etc.
For full Unicode/UTF8 support, see the <code>lapis.util.utf8</code> module.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">trimmed</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">trim</span><span class="sh_operator">(</span><span class="sh_string">&quot;   Hello World!   &quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">trimmed</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;Hello World!&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">trimmed</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">trim</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;   Hello World!   &quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">trimmed</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;Hello World!&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/trim_all" href="#functions/trim_all"><code>trim_all(tbl)</code></a></h3>

<p>Trims the whitespace from all values in a table. It uses <code>pairs</code> to traverse
every key in the table. Trimming is performed with the <code>trim</code> function provided in
the <code>lapis.util</code> module.</p>

<p>The table is modified in place.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">trimmed_table</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_identifier">key1</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;   value1   &quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">key2</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;   value2   &quot;</span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">trim_all</span><span class="sh_operator">(</span><span class="sh_identifier">trimmed_table</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">for</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">k</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">v</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">in</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">pairs</span><span class="sh_operator">(</span><span class="sh_identifier">trimmed_table</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">do</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">k</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">v</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: key1 value1, key2 value2</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">trimmed_table</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_tbl_key sh_regex">key1:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;   value1   &quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">key2:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;   value2   &quot;</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">trim_all</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">trimmed_table</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">for</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">k</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">v</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">in</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">pairs</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">trimmed_table</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">do</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">print</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">k</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">v</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_error">end</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: key1 value1, key2 value2</span></code>
</pre>
</div>

</p>

<h3><a name="functions/trim_filter" href="#functions/trim_filter"><code>trim_filter(tbl, [{keys ...}], [empty_val=nil])</code></a></h3>

<p>Trims the whitespace off of all values in a table. The entry is removed from
the table if the trimmed value is an empty string.</p>

<p>If an array table <code>keys</code> is supplied then any other keys not in that list are
removed (with <code>nil</code>, not the <code>empty_val</code>)</p>

<p>If <code>empty_val</code> is provided then the whitespace only values are replaced with
that value instead of <code>nil</code></p>

<p>The table is modified in place.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">trim_filter</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">trim_filter</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">unknown_input</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">username</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;     hello    &quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">level</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;admin&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">description</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot; &quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">trim_filter</span><span class="sh_operator">(</span><span class="sh_identifier">unknown_input</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;description&quot;</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">NULL</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- unknown input is now:</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">-- {</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">--   username = &quot;hello&quot;,</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">--   description = db.NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">-- }</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">trim_filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">unknown_input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">username:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;  hello  &quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">level:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;admin&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">description:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot; &quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">trim_filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">unknown_input</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;description&quot;</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">NULL</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- unknown input is now:</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">-- {</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">--   username: &quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">--   description: db.NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">-- }</span></code>
</pre>
</div>

</p>

<h3><a name="functions/to_json" href="#functions/to_json"><code>to_json(obj)</code></a></h3>

<p>Converts <code>obj</code> to JSON. This process removes recursion and elements that cannot
be encoded, thus preventing infinite recursion. The following types are
stripped: userdata, function, thread.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">example1</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">to_json</span><span class="sh_operator">({</span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_number">3</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">example1</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;[1,2,3]&quot;</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">example2</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">to_json</span><span class="sh_operator">({</span><span class="sh_identifier">hello</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world&quot;</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">example2</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &#x27;{&quot;hello&quot;:&quot;world&quot;}&#x27;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">example1</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">to_json</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_number">2</span><span class="sh_operator">,</span><span class="sh_number">3</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">example1</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;[1,2,3]&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">example2</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">to_json</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_tbl_key sh_regex">hello:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world&quot;</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">example2</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &#x27;{&quot;hello&quot;:&quot;world&quot;}&#x27;</span></code>
</pre>
</div>

</p>

<h3><a name="functions/from_json" href="#functions/from_json"><code>from_json(str)</code></a></h3>

<p>Converts JSON to table, a direct wrapper around Lua CJSON&rsquo;s <code>decode</code>.</p>

<h3><a name="functions/time_ago_in_words" href="#functions/time_ago_in_words"><code>time_ago_in_words(date, [parts=1], [suffix="ago"])</code></a></h3>

<p>Returns a string in the format &ldquo;1 day ago&rdquo;.</p>

<p><code>parts</code> allows you to add more words. With <code>parts=2</code>, the string
returned would be in the format <code>1 day, 4 hours ago</code>.</p>

<h3><a name="functions/autoload" href="#functions/autoload"><code>autoload(prefix, tbl={})</code></a></h3>

<p>Modifies <code>tbl</code> such that accessing an unset value in <code>tbl</code> will run a <code>require</code>
to search for the value. This is useful for autoloading components split across
many files. It overwrites the <code>__index</code> metamethod. The result of the require
is cached in the table, so the loading process only happens once. Returns the
<code>tbl</code> value.</p>

<blockquote><p>By default, a new empty table is created for the &lsquo;tbl&rsquo; argument, so it&rsquo;s not
necessary to provide one if you intend to create a new autoloading table.</p></blockquote>

<p>The following is the list of search patterns tried in order when requesting an
unloaded field:</p>

<ol>
<li><code>require("#{prefix}.#{field}")</code></li>
<li><code>require("#{prefix}.#{util.underscore(field)}")</code></li>
</ol>


<p>If a module is not able to be located, an error is thrown.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">models</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_operator">.</span><span class="sh_identifier">autoload</span><span class="sh_operator">(</span><span class="sh_string">&quot;models&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">_</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">models</span><span class="sh_operator">.</span><span class="sh_identifier">HelloWorld</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; will require &quot;models.hello_world&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">_</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">models</span><span class="sh_operator">.</span><span class="sh_identifier">foo_bar</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; will require &quot;models.foo_bar&quot;</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">models</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">autoload</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;models&quot;</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">models</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">HelloWorld</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; will require &quot;models.hello_world&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">models</span><span class="sh_operator">.</span><span class="sh_identifier">foo_bar</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; will require &quot;models.foo_bar&quot;</span></code>
</pre>
</div>

</p>

<h2><a name="encoding-methods" href="#encoding-methods">Encoding Methods</a></h2>

<p>Encoding functions are found in:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">encoding</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util.encoding&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">encoding</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util.encoding&quot;</span></code>
</pre>


<h3><a name="encoding-methods/encode_base64" href="#encoding-methods/encode_base64"><code>encode_base64(str)</code></a></h3>

<p>Base64 encodes a string.</p>

<h3><a name="encoding-methods/decode_base64" href="#encoding-methods/decode_base64"><code>decode_base64(str)</code></a></h3>

<p>Base64 decodes a string.</p>

<h3><a name="encoding-methods/hmac_sha1" href="#encoding-methods/hmac_sha1"><code>hmac_sha1(secret, str)</code></a></h3>

<p>Calculates the hmac-sha1 digest of <code>str</code> using <code>secret</code>. Returns a binary
string.</p>

<h3><a name="encoding-methods/encode_with_secret" href="#encoding-methods/encode_with_secret"><code>encode_with_secret(object, secret=config.secret)</code></a></h3>

<p>Encodes a Lua object and generates a signature for it. Returns a single string
that contains the encoded object and signature.</p>

<h3><a name="encoding-methods/decode_with_secret" href="#encoding-methods/decode_with_secret"><code>decode_with_secret(msg_and_sig, secret=config.secret)</code></a></h3>

<p>Decodes a string created by <code>encode_with_secret</code>. The decoded object is only
returned if the signature is correct. Otherwise returns <code>nil</code> and an error
message. The secret must match what was used with <code>encode_with_secret</code>.</p>

<h2><a name="csrf-protection" href="#csrf-protection">CSRF Protection</a></h2>

<p>CSRF protection provides a way to prevent unauthorized requests that originate
from other sites that are not your application. The common approach is to
generate a special token that is placed on pages that make need to make calls
with HTTP methods that are not <em>safe</em> (POST, PUT, DELETE, etc.). This token
must be sent back to the server on the requests to verify the request came from
a page generated by your application.</p>

<p>The default CSRF implementation generates a random string on the server and
stores it in the cookie. (The cookie&rsquo;s name is your session name followed by
<code>_token</code>.) The CSRF token is a cryptographically signed string that contains
the random string. You can optionally attach data to the CSRF token to control
how it can expire.</p>

<p>Before using any of the cryptographic functions it&rsquo;s important to set your
application&rsquo;s secret. This is a string that only the application knows about.
If your application is open source it&rsquo;s worthwhile to not commit this secret.
The secret is set in <a href="#configuration-and-environments">your configuration</a> like so:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">config</span><span class="sh_operator">(</span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">secret</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;this is my secret string 123456&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">secret</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;this is my secret string 123456&quot;</span></code>
</pre>
</div>

</p>

<p>Now that you have the secret configured, we might create a CSRF protected form
like so:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">get</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf_token</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">generate_token</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">html</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">form</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">method</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">action</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">input</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">type</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hidden&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;csrf_token&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">value</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf_token</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">input</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">type</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;submit&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">post</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">assert_token</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;The form is valid!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">csrf</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">form:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">GET:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">csrf_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">generate_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_self_ref sh_label">@html</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_identifier">form</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">method:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">action:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_symbol sh_embedded">)</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
          </span><span class="sh_identifier">input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hidden&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;csrf_token&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">value:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf_token</span><span class="sh_moonscript_whitespace sh_whitespace">
          </span><span class="sh_identifier">input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;submit&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_tbl_key sh_regex">POST:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">assert_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_string">&quot;The form is valid!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>
</div>

</p>

<blockquote><p>If you're using CSRF protection in a lot of actions then it might be helpful
to create a before filter that generates the token automatically.</p></blockquote>

<p>The following functions are part of the CSRF module:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">csrf</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.csrf&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="csrf-protection/csrf.generate_token" href="#csrf-protection/csrf.generate_token"><code>csrf.generate_token(req, data=nil)</code></a></h3>

<p>Generates a token for the current session. If a random string has not been set
in the cookie yet, then it will be generated. You can optionally pass in data
to have it encoded into the token. You can then use the <code>callback</code> parameter of
<code>validate_token</code> to verify data&rsquo;s value.</p>

<p>The random string is stored in a cookie named as your session name with
<code>_token</code> appended to the end.</p>

<h3><a name="csrf-protection/csrf.validate_token" href="#csrf-protection/csrf.validate_token"><code>csrf.validate_token(req, callback=nil)</code></a></h3>

<p>Validates the CSRF token located in <code>req.params.csrf_token</code>. For any endpoints
you validation the token on you must pass the query or form parameter
<code>csrf_token</code> with the value of the token returned by <code>generate_token</code>.</p>

<p>If the validation fails then <code>nil</code> and an error message are returned. A
callback function can be provided as the second argument. It&rsquo;s a function that
will be called with the data payload stored in the token. You can specify the
data with the second argument of <code>generate_token</code>.</p>

<p>Here&rsquo;s an example of adding an expiration date using the token data:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">get</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf_token</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">generate_token</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_comment">-- expire in 4 hours</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">expires</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_library sh_type">os.time</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">+</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">60</span><span class="sh_operator">*</span><span class="sh_number">60</span><span class="sh_operator">*</span><span class="sh_number">4</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- render a form using csrf_token...</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">post</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">assert_token</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">data</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_library sh_type">os.time</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">&gt;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">data</span><span class="sh_operator">.</span><span class="sh_identifier">expires</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">or</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">0</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">nil</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;token is expired&quot;</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">

    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;The request is valid!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">csrf</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">form:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">GET:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">csrf_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">generate_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_comment">-- expire in 4 hours</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_tbl_key sh_regex">expires:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_library sh_type">os.time</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">+</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">60</span><span class="sh_operator">*</span><span class="sh_number">60</span><span class="sh_operator">*</span><span class="sh_number">4</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_comment">-- render a form using csrf_token...</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_tbl_key sh_regex">POST:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">assert_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">d</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_library sh_type">os.time</span><span class="sh_symbol sh_embedded">()</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">d</span><span class="sh_operator">.</span><span class="sh_identifier">expires</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">or</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">0</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_moonscript_whitespace sh_whitespace">
          </span><span class="sh_keyword">return</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">nil</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;token is expired&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">

      </span><span class="sh_string">&quot;The form is valid!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>
</div>

</p>

<h3><a name="csrf-protection/csrf.assert_token" href="#csrf-protection/csrf.assert_token"><code>csrf.assert_token(...)</code></a></h3>

<p>First calls <code>validate_token</code> with same arguments, then calls <code>assert_error</code> if
validation fails.</p>

<h2><a name="making-http-requests" href="#making-http-requests">Making HTTP Requests</a></h2>

<p>The <code>lapis.http</code> module will attempt to select an HTTP client that works in the
current server/environment. All of these modules should implement LuaSocket&rsquo;s
<code>request</code> function interface. See: <a href="https://lunarmodules.github.io/luasocket/http.html#request">https://lunarmodules.github.io/luasocket/http.html#request</a></p>

<ul>
<li>When using Nginx: <code>lapis.nginx.http</code></li>
<li>When using Cqueues/lua-http: <code>http.compat.socket</code></li>
<li>Default: LuaSocket&rsquo;s <code>socket.http</code> (Note: <code>luasec</code> is required to perform HTTPS requests)</li>
</ul>


<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.http&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">ltn12</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;ltn12&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- a simple GET request</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status_code</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">request</span><span class="sh_operator">(</span><span class="sh_string">&quot;http://leafo.net&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- a simple POST request</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">out</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">_</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status_code</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">request</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">url</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;http://leafo.net&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">method</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">[</span><span class="sh_string">&quot;Content-type&quot;</span><span class="sh_operator">]</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;application/x-www-form-urlencoded&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">source</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">ltn12</span><span class="sh_operator">.</span><span class="sh_identifier">source</span><span class="sh_operator">.</span><span class="sh_library sh_type">string</span><span class="sh_operator">(</span><span class="sh_string">&quot;param1=value1&amp;param2=value2&quot;</span><span class="sh_operator">),</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">sink</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">ltn12</span><span class="sh_operator">.</span><span class="sh_identifier">sink</span><span class="sh_operator">.</span><span class="sh_library sh_type">table</span><span class="sh_operator">(</span><span class="sh_identifier">out</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_library sh_type">table.concat</span><span class="sh_operator">(</span><span class="sh_identifier">out</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">http</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.http&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">ltn12</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;ltn12&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- a simple GET request</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">status_code</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;http://leafo.net&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">


</span><span class="sh_identifier">out</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{}</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">_</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">status_code</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">url:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;http://leafo.net&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">method:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">headers:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">[</span><span class="sh_string">&quot;Content-type&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;application/x-www-form-urlencoded&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">source:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">ltn12</span><span class="sh_operator">.</span><span class="sh_identifier">source</span><span class="sh_operator">.</span><span class="sh_library sh_type">string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;param1=value1&amp;param2=value2&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">sink</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">ltn12</span><span class="sh_operator">.</span><span class="sh_identifier">sink</span><span class="sh_operator">.</span><span class="sh_library sh_type">table</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">out</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">body</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_library sh_type">table.concat</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">out</span></code>
</pre>
</div>

</p>

<p>For OpenResty, Lapis will use nginx&rsquo;s <code>proxy_pass</code> directive as an HTTP client.
In our tests, this has been the most reliable solution available that is fully
asynchronous and will not block your workers. Before you can make any requests,
you must modify your Nginx configuration to add a special <code>location</code> block that will facilitate the HTTP request.</p>

<p>Add the following to your server block:</p>

<pre class="highlight lang_nginx"><code><span class="sh_keyword">location</span><span class="sh_string"> /proxy</span><span class="sh_default"> {
  internal;
  </span><span class="sh_function">rewrite_by_lua</span><span class="sh_default"> </span><span class="sh_string">&quot;
    local req = ngx.req

    for k,v in pairs(req.get_headers()) do
      if k ~= &#x27;content-length&#x27; then
        req.clear_header(k)
      end
    end

    if ngx.ctx.headers then
      for k,v in pairs(ngx.ctx.headers) do
        req.set_header(k, v)
      end
    end
  &quot;</span><span class="sh_default">;

  resolver </span><span class="sh_number">8.8.8.8</span><span class="sh_default">;
  proxy_http_versi</span><span class="sh_keyword">on</span><span class="sh_default"> </span><span class="sh_number">1.1</span><span class="sh_default">;
  </span><span class="sh_function">proxy_pass</span><span class="sh_default"> </span><span class="sh_variable sh_label">$_url;</span><span class="sh_default">
}</span></code>
</pre>


<blockquote><p>This code ensures that the correct headers are set for the subrequest that is
created.</p></blockquote>

<p>Additionally, in the nginx <code>location</code> that processes your Lapis requests, you
need to define the <code>$_url</code> variable, which will hold the request URL.</p>

<pre class="highlight lang_nginx"><code><span class="sh_keyword">location</span><span class="sh_string"> /</span><span class="sh_default"> {
  </span><span class="sh_keyword">set</span><span class="sh_default"> </span><span class="sh_variable sh_label">$_url</span><span class="sh_default"> </span><span class="sh_string">&quot;&quot;</span><span class="sh_default">; </span><span class="sh_comment"># Add this line</span><span class="sh_default">
  </span><span class="sh_function">content_by_lua</span><span class="sh_default"> </span><span class="sh_string">&quot;require(&#x27;lapis&#x27;).serve(&#x27;app&#x27;)&quot;</span><span class="sh_default">;
  </span><span class="sh_comment"># ...</span><span class="sh_default">
}</span></code>
</pre>


<p>Now we can use the <code>lapis.nginx.http</code> module. There are two methods. <code>request</code>
and <code>simple</code>. <code>request</code> implements the Lua Socket HTTP request API (complete
with LTN12).</p>

<p><code>simple</code> is a simplified API with no LTN12:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.http&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">get</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- a simple GET request</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status_code</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">request</span><span class="sh_operator">(</span><span class="sh_string">&quot;http://leafo.net&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_identifier">http</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.nginx.http&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_comment">-- a simple GET request</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">status_code</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;http://leafo.net&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="making-http-requests/http.request" href="#making-http-requests/http.request"><code>http.request(url_or_table, body)</code></a></h3>

<p>This is documentation for the Lapis Nginx-specific implementation of the
<a href="https://lunarmodules.github.io/luasocket/http.html#request">LuaSocket request
function</a>. Although
this function attempts to cover the most common calling cases, it is not a
perfect replacement.</p>

<p>When used in Nginx, this function is non-blocking. The function does not
support streaming responses, which means large request responses will be
buffered entirely into memory. The result cannot be read until the full request
completes. Also, it does not support <code>proxy</code>, <code>create</code>, <code>step</code>, or <code>redirect</code>
parameters of LuaSocket&rsquo;s request function.</p>

<p>The <code>/proxy</code> location described above must exist in the same server block that
is handling the original request for this function to work.</p>

<blockquote><p>If you are looking for a more flexible HTTP client that is specific to Nginx,
look at <a href="https://github.com/ledgetech/lua-resty-http">https://github.com/ledgetech/lua-resty-http</a></p></blockquote>

<p><strong>Parameters:</strong></p>

<ul>
<li><code>url_or_table</code>: This can either be a string specifying the URL for a simple GET/POST request, or a table for more complex requests. If a table, the following keys can be used:

<ul>
<li><code>url</code>: The URL to request.  (Required)</li>
<li><code>method</code>: The HTTP method to use, for example: <code>"GET"</code>, <code>"POST"</code>, <code>"PUT"</code>, etc.</li>
<li><code>source</code>: An <code>ltn12</code> source that generates the body of the request.</li>
<li><code>headers</code>: A plain table of headers to include in the request.</li>
<li><code>sink</code>: An <code>ltn12</code> sink that will receive the output of the request.</li>
</ul>
</li>
<li><code>body</code>: This arugment is only used if <code>url_or_table</code> is provided as a string. Converts the request to a POST request and adds the <code>"Content-type: application/x-www-form-urlencoded"</code> header pair</li>
</ul>


<p><strong>Returns:</strong></p>

<p>The function returns three values:</p>

<ol>
<li><code>body</code>: The string result of the request. If a <code>sink</code> is provided, then the body is returned as the number value <code>1</code>, and the body should be read from the sink.</li>
<li><code>status</code>: The HTTP status code of the response, as a number.</li>
<li><code>headers</code>: A table of headers from the response.</li>
</ol>


<p>Every successful HTTP request increments the following performance metrics in the Nginx context:</p>

<ul>
<li><code>http_count</code>: This metric counts the total number of HTTP requests.</li>
<li><code>http_time</code>: This metric measures the total time taken for HTTP requests. It is calculated as the difference between the current time and the start time of the request.</li>
</ul>


<h3><a name="making-http-requests/http.simple" href="#making-http-requests/http.simple"><code>http.simple(req, body)</code></a></h3>

<blockquote><p>This function is now deprecated. We recommend using the <code>http.request</code>
interface, which is compatible with multiple HTTP clients.</p></blockquote>

<p>Performs an HTTP request using the internal <code>/proxy</code> location.</p>

<p>Returns 3 values, the string result of the request, http status code, and a
table of headers.</p>

<p>If there is only one argument and it is a string then that argument is treated
as a URL for a GET request.</p>

<p>If there is a second argument it is set as the body of a POST request. If
the body is a table it is encoded with <code>encode_query_string</code> and the
<code>Content-type</code> header is set to <code>application/x-www-form-urlencoded</code></p>

<p>If the first argument is a table then it is used to manually set request
parameters. It takes the following keys:</p>

<ul>
<li><code>url</code> &mdash; the URL to request</li>
<li><code>method</code> &mdash; <code>"GET"</code>, <code>"POST"</code>, <code>"PUT"</code>, etc&hellip;</li>
<li><code>body</code> &mdash; string or table which is encoded</li>
<li><code>headers</code> &mdash; a table of request headers to set</li>
</ul>


<h2><a name="caching" href="#caching">Caching</a></h2>

<blockquote><p>The caching functionality here is very rudimentary. If you are looking for
more robust caching, look into the <code>proxy_cache</code> directive that is part of
the Nginx HTTP proxy module:
<a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache">https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache</a></p></blockquote>

<p>Lapis comes with a simple memory cache for caching the entire result of an
action keyed on the parameters it receives. This is useful for speeding up the
rendering of rarely changing pages because all database calls and HTML methods
can be skipped.</p>

<p>The Lapis cache uses the <a href="http://wiki.nginx.org/HttpLuaModule#lua_shared_dict">shared dictionary
API</a> from HttpLuaModule.
The first thing you'll need to do is create a shared dictionary in your Nginx
configuration.</p>

<p>Add the following to your <code>http</code> block to create a 15mb cache:</p>

<pre class="highlight lang_nginx"><code><span class="sh_function">lua_shared_dict</span><span class="sh_default"> page_cache </span><span class="sh_number">15</span><span class="sh_default">m;</span></code>
</pre>


<p>Now we are ready to start using the caching module, <code>lapis.cache</code>.</p>

<h3><a name="caching/cache.cached" href="#caching/cache.cached"><code>cache.cached(fn_or_tbl)</code></a></h3>

<p>Wraps an action to use the cache.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">cached</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello/world&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello world!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">my_page:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello/world&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;hello world!&quot;</span></code>
</pre>


<p>The first request to <code>/hello/world</code> will run the action and store the result in
the cache, all subsequent requests will skip the action and return the text
stored in the cache.</p>

<p>The cache will remember not only the raw text output, but also the content
type and status code.</p>

<p>The cache key also takes into account any GET parameters, so a request to
<code>/hello/world?one=two</code> is stored in a separate cache slot. Multiple parameters
are sorted so they can come in any order and still match the same cache key.</p>

<p>When the cache is hit, a special response header is set to 1,
<code>x-memory-cache-hit</code>. This is useful for debugging your application to make
sure the cache is working.</p>

<p>Instead of passing a function as the action of the cache you can also pass in a
table. When passing in a table the function must be the first numerically
indexed item in the table.</p>

<p>The table supports the following options:</p>

<ul>
<li><code>dict_name</code> &mdash; override the name of the shared dictionary used (defaults to <code>"page_cache"</code>)</li>
<li><code>exptime</code> &mdash; how long in seconds the cache should stay alive, 0 is forever (defaults to <code>0</code>)</li>
<li><code>cache_key</code> &mdash; set a custom function for generating the cache key (default is described above)</li>
<li><code>when</code> &mdash; a function that should return truthy a value if the page should be cached. Receives the request object as first argument (defaults to <code>nil</code>)</li>
</ul>


<p>For example, you could implement microcaching, where the page is cached for a
short period of time, like so:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">cached</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/microcached&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">exptime</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello world!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}))</span><span class="sh_lua_whitespace sh_whitespace">
</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/microcached&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">exptime:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello world!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<h3><a name="caching/cache.delete" href="#caching/cache.delete"><code>cache.delete(key, [dict_name="page_cache"])</code></a></h3>

<p>Deletes an entry from the cache. Key can either be a plain string, or a tuple
of <code>{path, params}</code> that will be encoded as the key.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cache</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">cache</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">thing</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">cache</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">cache</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">thing:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<h3><a name="caching/cache.delete_all" href="#caching/cache.delete_all"><code>cache.delete_all([dict_name="page_cache"])</code></a></h3>

<p>Deletes all entries from the cache.</p>

<h3><a name="caching/cache.delete_path" href="#caching/cache.delete_path"><code>cache.delete_path(path, [dict_name="page_cache"])</code></a></h3>

<p>Deletes all entries for a specific path.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cache</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">cache</span><span class="sh_operator">.</span><span class="sh_identifier">delete_path</span><span class="sh_operator">(</span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">cache</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">cache</span><span class="sh_operator">.</span><span class="sh_identifier">delete_path</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello&quot;</span></code>
</pre>


<h2><a name="file-uploads" href="#file-uploads">File Uploads</a></h2>

<p>File uploads can be handled with a multipart form and accessing the file from
the <span class="for_moon"><code>@params</code></span><span
class="for_lua"><code>self.params</code></span> of the request.</p>

<p>For example, let&rsquo;s create the following form:</p>

<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Widget</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.html&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">MyForm</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Widget</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">content:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">form</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">action:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">method:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">enctype:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;multipart/form-data&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;file&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;uploaded_file&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;submit&quot;</span></code>
</pre>


<p>When the form is submitted, the file is stored as a table with <code>filename</code> and
<code>content</code> properties in <span class="for_moon"><code>@params</code></span><span
class="for_lua"><code>self.params</code></span> under the name of the form input:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">post</span><span class="sh_operator">(</span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">file</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">uploaded_file</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">file</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Uploaded: &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">file</span><span class="sh_operator">.</span><span class="sh_identifier">filename</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;, &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">#</span><span class="sh_identifier">file</span><span class="sh_operator">.</span><span class="sh_identifier">content</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;bytes&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">file</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">uploaded_file</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_string">&quot;Uploaded #{file.filename}, #{#file.content}bytes&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span></code>
</pre>


<p>A validation exists for ensuring that a param is an uploaded file, it&rsquo;s called
<code>is_file</code>:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">post</span><span class="sh_operator">(</span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">assert_valid</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;uploaded_file&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">is_file</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_comment">-- file is ready to be used</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">assert_valid</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;uploaded_file&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">is_file:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_comment">-- file is ready to be used...</span></code>
</pre>


<p>An uploaded file is loaded entirely into memory, so you should be careful about
the memory requirements of your application. Nginx limits the size of uploads
through the
<a href="http://wiki.nginx.org/HttpCoreModule#client_max_body_size"><code>client_max_body_size</code></a>
directive. It&rsquo;s only 1 megabyte by default, so if you plan to allow uploads
greater than that you should set a new value in your Nginx configuration.</p>

<h2><a name="application-helpers" href="#application-helpers">Application Helpers</a></h2>

<p>The following functions are part of the <code>lapis.application</code> module:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">application</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span></code>
</pre>


<h3><a name="application-helpers/respond_to" href="#application-helpers/respond_to"><code>respond_to(verbs_to_fn={})</code></a></h3>

<p><code>verbs_to_fn</code> is a table of functions that maps a HTTP verb to a corresponding
function. Returns a new function that dispatches to the correct function in the
table based on the verb of the request. See
<a href="actions.html#handling-http-verbs">Handling HTTP verbs</a></p>

<p>If an action for <code>HEAD</code> does not exist Lapis inserts the following function to
render nothing:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">layout</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">layout:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<p>If the request is a verb that is not handled then the Lua <code>error</code> function
is called and a 500 page is generated.</p>

<p>A special <code>before</code> key can be set to a function that should run before any
other action. If <span class="for_moon"><code>@write</code></span><span
class="for_lua"><code>self.write</code></span> is called inside the before function then
the regular handler will not be called.</p>

<h3><a name="application-helpers/capture_errors" href="#application-helpers/capture_errors"><code>capture_errors(fn_or_tbl)</code></a></h3>

<p>Wraps a function to catch errors sent by <code>yield_error</code> or <code>assert_error</code>. See
<a href="exception_handling.html">Exception Handling</a> for more information.</p>

<p>If the first argument is a function then that function is called on request and
the following default error handler is used:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<p>If a table is the first argument then the <code>1</code>st element of the table is used as
the action and value of <code>on_error</code> is used as the error handler.</p>

<p>When an error is yielded then the <span class="for_moon"><code>@errors</code></span><span
class="for_lua"><code>self.errors</code></span> variable is set on the current request and
the error handler is called.</p>

<h3><a name="application-helpers/capture_errors_json" href="#application-helpers/capture_errors_json"><code>capture_errors_json(fn)</code></a></h3>

<p>A wrapper for <code>capture_errors</code> that passes in the following error handler:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">json</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">json:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">errors:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<h3><a name="application-helpers/yield_error" href="#application-helpers/yield_error"><code>yield_error(error_message)</code></a></h3>

<p>Yields a single error message to be captured by <code>capture_errors</code></p>

<h3><a name="application-helpers/obj" href="#application-helpers/obj"><code>obj, msg, ... = assert_error(obj, msg, ...)</code></a></h3>

<p>Works like Lua&rsquo;s <code>assert</code> but instead of triggering a Lua error it triggers an
error to be captured by <code>capture_errors</code></p>

<h3><a name="application-helpers/json_params" href="#application-helpers/json_params"><code>json_params(fn)</code></a></h3>

<p>Return a new function that will parse the body of the request as JSON and
inject it into <code class="for_moon">@params</code><code class="for_lua">self.params</code> if the <code>content-type</code> is set to
<code>application/json</code>. Suitable for wrapping an action handler to make it aware of
JSON encoded requests.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">json_params</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">json_params</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/json&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">json_params</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">value</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">json_params</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">JsonApp</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/json&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">json_params</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">value</span></code>
</pre>


<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">curl</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_default">\</span><span class="sh_bash_whitespace sh_whitespace">
  </span><span class="sh_operator">-</span><span class="sh_identifier">H</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Content-type: application/json&quot;</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_default">\</span><span class="sh_bash_whitespace sh_whitespace">
  </span><span class="sh_keyword">-d</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_string">&#x27;{&quot;value&quot;: &quot;hello&quot;}&#x27;</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_default">\</span><span class="sh_bash_whitespace sh_whitespace">
  </span><span class="sh_string">&#x27;https://localhost:8080/json&#x27;</span></code>
</pre>


<p>The unmerged parameters can also be accessed from <code class="for_moon">@json</code><code class="for_lua">self.json</code>. If there
was an error parsing the JSON then <code class="for_moon">@json</code><code class="for_lua">self.json</code> will be <code>nil</code> and the
request will continue without error.</p>

<h2><a name="utf8" href="#utf8">UTF8</a></h2>

<p>This module includes a collection of LPeg patterns for working with UTF8 text.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_library sh_type">utf8</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">requrie</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util.utf8&quot;</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_library sh_type">utf8</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">requrie</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;lapis.util.utf8&quot;</span><span class="sh_symbol sh_embedded">)</span></code>
</pre>
</div>

</p>

<h3><a name="utf8/utf8.trim" href="#utf8/utf8.trim"><code>utf8.trim</code></a></h3>

<p>A pattern that will trim all invisible characters from either side of the
matched string. (Utilizes the <code>whitespace</code> pattern described below)</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_library sh_type">utf8</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util.utf8&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">original_string</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;    Hello, World!    &quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">trimmed_string</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">utf8</span><span class="sh_operator">.</span><span class="sh_identifier">trim</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_identifier">original_string</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">trimmed_string</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_library sh_type">utf8</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util.utf8&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">original_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;    Hello, World!    &quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">trimmed_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">utf8</span><span class="sh_operator">.</span><span class="sh_identifier">trim</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">original_string</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">trimmed_string</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: &quot;Hello, World!&quot;</span></code>
</pre>
</div>

</p>

<h3><a name="utf8/utf8.printable_character" href="#utf8/utf8.printable_character"><code>utf8.printable_character</code></a></h3>

<p>A pattern that matches a single printable character. Note that printable
characters include whitepace, but don&rsquo;t include invalid unicode codepoints or
control characters.</p>

<h3><a name="utf8/utf8.whitepace" href="#utf8/utf8.whitepace"><code>utf8.whitepace</code></a></h3>

<p>An optimal pattern that matches any unicode codepoints that are classified as
whitespace.</p>

<h3><a name="utf8/utf8.string_length" href="#utf8/utf8.string_length"><code>utf8.string_length</code></a></h3>

<p>Calculates the length of a string, counting each printable character. It takes
a string as an argument and returns the number of printable characters in the
string. This is aware of multi-byte characters:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_library sh_type">utf8</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util.utf8&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">multi_byte_string</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">string_length</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">utf8</span><span class="sh_operator">.</span><span class="sh_identifier">string_length</span><span class="sh_operator">(</span><span class="sh_identifier">multi_byte_string</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">print</span><span class="sh_operator">(</span><span class="sh_identifier">string_length</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_library sh_type">utf8</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util.utf8&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">multi_byte_string</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">string_length</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">utf8</span><span class="sh_operator">.</span><span class="sh_identifier">string_length</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">multi_byte_string</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_function">print</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">string_length</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">  </span><span class="sh_comment">-- Output: 7</span></code>
</pre>
</div>

</p>

      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Mar  8 20:35:45 2024"></script>
  <script type="text/javascript" src="../reference.js?Fri Mar  8 20:35:45 2024"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
