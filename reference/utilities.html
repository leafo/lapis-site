<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Utilities - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Mon Jan  9 21:25:16 2023" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.12.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Utilities</h2>
            <ul><li><a href="#functions">Functions <span stat-keyword="util"></span></a></li>
<ul><li><a href="#functions/unescape"><code>unescape(str)</code></a></li>
<li><a href="#functions/escape"><code>escape(str)</code></a></li>
<li><a href="#functions/escape_pattern"><code>escape_pattern(str)</code></a></li>
<li><a href="#functions/parse_query_string"><code>parse_query_string(str)</code></a></li>
<li><a href="#functions/encode_query_string"><code>encode_query_string(tbl)</code></a></li>
<li><a href="#functions/underscore"><code>underscore(str)</code></a></li>
<li><a href="#functions/slugify"><code>slugify(str)</code></a></li>
<li><a href="#functions/uniquify"><code>uniquify(tbl)</code></a></li>
<li><a href="#functions/trim"><code>trim(str)</code></a></li>
<li><a href="#functions/trim_all"><code>trim_all(tbl)</code></a></li>
<li><a href="#functions/trim_filter"><code>trim_filter(tbl, [{keys ...}], [empty_val=nil])</code></a></li>
<li><a href="#functions/to_json"><code>to_json(obj)</code></a></li>
<li><a href="#functions/from_json"><code>from_json(str)</code></a></li>
<li><a href="#functions/time_ago_in_words"><code>time_ago_in_words(date, [parts=1], [suffix="ago"])</code></a></li></ul>
<li><a href="#encoding-methods">Encoding Methods</a></li>
<ul><li><a href="#encoding-methods/encode_base64"><code>encode_base64(str)</code></a></li>
<li><a href="#encoding-methods/decode_base64"><code>decode_base64(str)</code></a></li>
<li><a href="#encoding-methods/hmac_sha1"><code>hmac_sha1(secret, str)</code></a></li>
<li><a href="#encoding-methods/encode_with_secret"><code>encode_with_secret(object, secret=config.secret)</code></a></li>
<li><a href="#encoding-methods/decode_with_secret"><code>decode_with_secret(msg_and_sig, secret=config.secret)</code></a></li>
<li><a href="#encoding-methods/autoload"><code>autoload(prefix, tbl={})</code></a></li></ul>
<li><a href="#csrf-protection">CSRF Protection</a></li>
<ul><li><a href="#csrf-protection/csrf.generate_token"><code>csrf.generate_token(req, data=nil)</code></a></li>
<li><a href="#csrf-protection/csrf.validate_token"><code>csrf.validate_token(req, callback=nil)</code></a></li>
<li><a href="#csrf-protection/csrf.assert_token"><code>csrf.assert_token(...)</code></a></li></ul>
<li><a href="#making-http-requests">Making HTTP Requests</a></li>
<ul><li><a href="#making-http-requests/http.simple"><code>http.simple(req, body)</code></a></li>
<li><a href="#making-http-requests/http.request"><code>http.request(url_or_table, body)</code></a></li></ul>
<li><a href="#caching">Caching</a></li>
<ul><li><a href="#caching/cache.cached"><code>cache.cached(fn_or_tbl)</code></a></li>
<li><a href="#caching/cache.delete"><code>cache.delete(key, [dict_name="page_cache"])</code></a></li>
<li><a href="#caching/cache.delete_all"><code>cache.delete_all([dict_name="page_cache"])</code></a></li>
<li><a href="#caching/cache.delete_path"><code>cache.delete_path(path, [dict_name="page_cache"])</code></a></li></ul>
<li><a href="#file-uploads">File Uploads</a></li>
<li><a href="#application-helpers">Application Helpers</a></li>
<ul><li><a href="#application-helpers/respond_to"><code>respond_to(verbs_to_fn={})</code></a></li>
<li><a href="#application-helpers/capture_errors"><code>capture_errors(fn_or_tbl)</code></a></li>
<li><a href="#application-helpers/capture_errors_json"><code>capture_errors_json(fn)</code></a></li>
<li><a href="#application-helpers/yield_error"><code>yield_error(error_message)</code></a></li>
<li><a href="#application-helpers/obj"><code>obj, msg, ... = assert_error(obj, msg, ...)</code></a></li>
<li><a href="#application-helpers/json_params"><code>json_params(fn)</code></a></li></ul>
<li><a href="#utf8">UTF8</a></li>
<ul><li><a href="#utf8/utf8.trim"><code>utf8.trim</code></a></li>
<li><a href="#utf8/utf8.printable_character"><code>utf8.printable_character</code></a></li>
<li><a href="#utf8/utf8.whitepace"><code>utf8.whitepace</code></a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Utilities</h1>

<h2><a name="functions" href="#functions">Functions <span stat-keyword="util"></span></a></h2>

<p>Utility functions are found in:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">util</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">util</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span></code>
</pre>


<h3><a name="functions/unescape" href="#functions/unescape"><code>unescape(str)</code></a></h3>

<p>URL unescapes string</p>

<h3><a name="functions/escape" href="#functions/escape"><code>escape(str)</code></a></h3>

<p>URL escapes string</p>

<h3><a name="functions/escape_pattern" href="#functions/escape_pattern"><code>escape_pattern(str)</code></a></h3>

<p>Escapes string for use in Lua pattern</p>

<h3><a name="functions/parse_query_string" href="#functions/parse_query_string"><code>parse_query_string(str)</code></a></h3>

<p>Parses query string into a table</p>

<h3><a name="functions/encode_query_string" href="#functions/encode_query_string"><code>encode_query_string(tbl)</code></a></h3>

<p>Converts a key,value table into a query string</p>

<h3><a name="functions/underscore" href="#functions/underscore"><code>underscore(str)</code></a></h3>

<p>Convert CamelCase to camel_case.</p>

<h3><a name="functions/slugify" href="#functions/slugify"><code>slugify(str)</code></a></h3>

<p>Converts a string to a slug suitable for a URL. Removes all whitespace and
symbols and replaces them with <code>-</code>.</p>

<h3><a name="functions/uniquify" href="#functions/uniquify"><code>uniquify(tbl)</code></a></h3>

<p>Iterates over array table <code>tbl</code> appending all unique values into a new array
table, then returns the new one.</p>

<h3><a name="functions/trim" href="#functions/trim"><code>trim(str)</code></a></h3>

<p>Trims the whitespace off of both sides of a string. Note that this function is
only aware of ASCII whitepsace characters, such as space, newline, tab, etc.
For full Unicode/UTF8 support see the <code>lapis.util.utf8</code> module</p>

<h3><a name="functions/trim_all" href="#functions/trim_all"><code>trim_all(tbl)</code></a></h3>

<p>Trims the whitespace off of all values in a table. Uses <code>pairs</code> to traverse
every key in the table.</p>

<p>The table is modified in place.</p>

<h3><a name="functions/trim_filter" href="#functions/trim_filter"><code>trim_filter(tbl, [{keys ...}], [empty_val=nil])</code></a></h3>

<p>Trims the whitespace off of all values in a table. The entry is removed from
the table if the result is an empty string.</p>

<p>If an array table <code>keys</code> is supplied then any other keys not in that list are
removed (with <code>nil</code>, not the <code>empty_val</code>)</p>

<p>If <code>empty_val</code> is provided then the whitespace only values are replaced with
that value instead of <code>nil</code></p>

<p>The table is modified in place.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">trim_filter</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">trim_filter</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">unknown_input</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">username</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;     hello    &quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">level</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;admin&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">description</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot; &quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">trim_filter</span><span class="sh_operator">(</span><span class="sh_identifier">unknown_input</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;description&quot;</span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_identifier">NULL</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- unknown input is now:</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">-- {</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">--   username = &quot;hello&quot;,</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">--   description = db.NULL</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_comment">-- }</span><span class="sh_lua_whitespace sh_whitespace">
</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">db</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">trim_filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">unknown_input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">username:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;  hello  &quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">level:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;admin&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">description:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot; &quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">trim_filter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">unknown_input</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_string">&quot;username&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;description&quot;</span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">db</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">NULL</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- unknown input is now:</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">-- {</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">--   username: &quot;hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">--   description: db.NULL</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_comment">-- }</span></code>
</pre>


<h3><a name="functions/to_json" href="#functions/to_json"><code>to_json(obj)</code></a></h3>

<p>Converts <code>obj</code> to JSON. Will strip recursion and things that can not be encoded.</p>

<h3><a name="functions/from_json" href="#functions/from_json"><code>from_json(str)</code></a></h3>

<p>Converts JSON to table, a direct wrapper around Lua CJSON&rsquo;s <code>decode</code>.</p>

<h3><a name="functions/time_ago_in_words" href="#functions/time_ago_in_words"><code>time_ago_in_words(date, [parts=1], [suffix="ago"])</code></a></h3>

<p>Returns a string in the format &ldquo;1 day ago&rdquo;.</p>

<p><code>parts</code> allows you to add more words. With <code>parts=2</code>, the string
returned would be in the format <code>1 day, 4 hours ago</code>.</p>

<h2><a name="encoding-methods" href="#encoding-methods">Encoding Methods</a></h2>

<p>Encoding functions are found in:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">encoding</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util.encoding&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">encoding</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.util.encoding&quot;</span></code>
</pre>


<h3><a name="encoding-methods/encode_base64" href="#encoding-methods/encode_base64"><code>encode_base64(str)</code></a></h3>

<p>Base64 encodes a string.</p>

<h3><a name="encoding-methods/decode_base64" href="#encoding-methods/decode_base64"><code>decode_base64(str)</code></a></h3>

<p>Base64 decodes a string.</p>

<h3><a name="encoding-methods/hmac_sha1" href="#encoding-methods/hmac_sha1"><code>hmac_sha1(secret, str)</code></a></h3>

<p>Calculates the hmac-sha1 digest of <code>str</code> using <code>secret</code>. Returns a binary
string.</p>

<h3><a name="encoding-methods/encode_with_secret" href="#encoding-methods/encode_with_secret"><code>encode_with_secret(object, secret=config.secret)</code></a></h3>

<p>Encodes a Lua object and generates a signature for it. Returns a single string
that contains the encoded object and signature.</p>

<h3><a name="encoding-methods/decode_with_secret" href="#encoding-methods/decode_with_secret"><code>decode_with_secret(msg_and_sig, secret=config.secret)</code></a></h3>

<p>Decodes a string created by <code>encode_with_secret</code>. The decoded object is only
returned if the signature is correct. Otherwise returns <code>nil</code> and an error
message. The secret must match what was used with <code>encode_with_secret</code>.</p>

<h3><a name="encoding-methods/autoload" href="#encoding-methods/autoload"><code>autoload(prefix, tbl={})</code></a></h3>

<p>Makes it so accessing an unset value in <code>tbl</code> will run a <code>require</code> to search
for the value. Useful for autoloading components split across many files.
Overwrites <code>__index</code> metamethod. The result of the require is stored in the
table.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">models</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">autoload</span><span class="sh_operator">(</span><span class="sh_string">&quot;models&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">_</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">models</span><span class="sh_operator">.</span><span class="sh_identifier">HelloWorld</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; will require &quot;models.hello_world&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">_</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">models</span><span class="sh_operator">.</span><span class="sh_identifier">foo_bar</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; will require &quot;models.foo_bar&quot;</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">models</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">autoload</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;models&quot;</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">models</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">HelloWorld</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; will require &quot;models.hello_world&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">models</span><span class="sh_operator">.</span><span class="sh_identifier">foo_bar</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_comment">--&gt; will require &quot;models.foo_bar&quot;</span></code>
</pre>


<h2><a name="csrf-protection" href="#csrf-protection">CSRF Protection</a></h2>

<p>CSRF protection provides a way to prevent unauthorized requests that originate
from other sites that are not your application. The common approach is to
generate a special token that is placed on pages that make need to make calls
with HTTP methods that are not <em>safe</em> (POST, PUT, DELETE, etc.). This token
must be sent back to the server on the requests to verify the request came from
a page generated by your application.</p>

<p>The default CSRF implementation generates a random string on the server and
stores it in the cookie. (The cookie&rsquo;s name is your session name followed by
<code>_token</code>.) The CSRF token is a cryptographically signed string that contains
the random string. You can optionally attach data to the CSRF token to control
how it can expire.</p>

<p>Before using any of the cryptographic functions it&rsquo;s important to set your
application&rsquo;s secret. This is a string that only the application knows about.
If your application is open source it&rsquo;s worthwhile to not commit this secret.
The secret is set in <a href="#configuration-and-environments">your configuration</a> like so:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">config</span><span class="sh_operator">(</span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">secret</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;this is my secret string 123456&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;development&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">secret</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;this is my secret string 123456&quot;</span></code>
</pre>


<p>Now that you have the secret configured, we might create a CSRF protected form
like so:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">get</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf_token</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">generate_token</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">html</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">form</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">method</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">action</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">:</span><span class="sh_identifier">url_for</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">input</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">type</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hidden&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;csrf_token&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">value</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf_token</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">input</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">type</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;submit&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">post</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">assert_token</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;The form is valid!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">csrf</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">form:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">GET:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">csrf_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">generate_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_self_ref sh_label">@html</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_identifier">form</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">method:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">action:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@url_for</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_symbol sh_embedded">)</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
          </span><span class="sh_identifier">input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hidden&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;csrf_token&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">value:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf_token</span><span class="sh_moonscript_whitespace sh_whitespace">
          </span><span class="sh_identifier">input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;submit&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_tbl_key sh_regex">POST:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">assert_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_string">&quot;The form is valid!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<blockquote><p>If you're using CSRF protection in a lot of actions then it might be helpful
to create a before filter that generates the token automatically.</p></blockquote>

<p>The following functions are part of the CSRF module:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">csrf</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.csrf&quot;</span></code>
</pre>


<h3><a name="csrf-protection/csrf.generate_token" href="#csrf-protection/csrf.generate_token"><code>csrf.generate_token(req, data=nil)</code></a></h3>

<p>Generates a token for the current session. If a random string has not been set
in the cookie yet, then it will be generated. You can optionally pass in data
to have it encoded into the token. You can then use the <code>callback</code> parameter of
<code>validate_token</code> to verify data&rsquo;s value.</p>

<p>The random string is stored in a cookie named as your session name with
<code>_token</code> appended to the end.</p>

<h3><a name="csrf-protection/csrf.validate_token" href="#csrf-protection/csrf.validate_token"><code>csrf.validate_token(req, callback=nil)</code></a></h3>

<p>Validates the CSRF token located in <code>req.params.csrf_token</code>. For any endpoints
you validation the token on you must pass the query or form parameter
<code>csrf_token</code> with the value of the token returned by <code>generate_token</code>.</p>

<p>If the validation fails then <code>nil</code> and an error message are returned. A
callback function can be provided as the second argument. It&rsquo;s a function that
will be called with the data payload stored in the token. You can specify the
data with the second argument of <code>generate_token</code>.</p>

<p>Here&rsquo;s an example of adding an expiration date using the token data:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">capture_errors</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">get</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf_token</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">generate_token</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_comment">-- expire in 4 hours</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">expires</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_library sh_type">os.time</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">+</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">60</span><span class="sh_operator">*</span><span class="sh_number">60</span><span class="sh_operator">*</span><span class="sh_number">4</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- render a form using csrf_token...</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">post</span><span class="sh_operator">(</span><span class="sh_string">&quot;form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">assert_token</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">data</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_library sh_type">os.time</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">&gt;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">(</span><span class="sh_identifier">data</span><span class="sh_operator">.</span><span class="sh_identifier">expires</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">or</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">0</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">nil</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;token is expired&quot;</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">

    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;The request is valid!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">csrf</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.csrf&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">form:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/form&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">respond_to</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">GET:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">csrf_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">generate_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_comment">-- expire in 4 hours</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_tbl_key sh_regex">expires:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_library sh_type">os.time</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">+</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">60</span><span class="sh_operator">*</span><span class="sh_number">60</span><span class="sh_operator">*</span><span class="sh_number">4</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_comment">-- render a form using csrf_token...</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_tbl_key sh_regex">POST:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">csrf</span><span class="sh_operator">.</span><span class="sh_identifier">assert_token</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">d</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_library sh_type">os.time</span><span class="sh_symbol sh_embedded">()</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">d</span><span class="sh_operator">.</span><span class="sh_identifier">expires</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">or</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">0</span><span class="sh_symbol sh_embedded">)</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_moonscript_whitespace sh_whitespace">
          </span><span class="sh_keyword">return</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">nil</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;token is expired&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace">

      </span><span class="sh_string">&quot;The form is valid!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<h3><a name="csrf-protection/csrf.assert_token" href="#csrf-protection/csrf.assert_token"><code>csrf.assert_token(...)</code></a></h3>

<p>First calls <code>validate_token</code> with same arguments, then calls <code>assert_error</code> if
validation fails.</p>

<h2><a name="making-http-requests" href="#making-http-requests">Making HTTP Requests</a></h2>

<p>Lapis comes with a built-in module for making asynchronous HTTP requests. The
way it works is by using the Nginx <code>proxy_pass</code> directive on an internal
action. Because of this, before you can make any requests you need to modify
your Nginx configuration.</p>

<p>Add the following to your server block:</p>

<pre class="highlight lang_nginx"><code><span class="sh_keyword">location</span><span class="sh_string"> /proxy</span><span class="sh_default"> {
    internal;
    </span><span class="sh_function">rewrite_by_lua</span><span class="sh_default"> </span><span class="sh_string">&quot;
      local req = ngx.req

      for k,v in pairs(req.get_headers()) do
        if k ~= &#x27;content-length&#x27; then
          req.clear_header(k)
        end
      end

      if ngx.ctx.headers then
        for k,v in pairs(ngx.ctx.headers) do
          req.set_header(k, v)
        end
      end
    &quot;</span><span class="sh_default">;

    resolver </span><span class="sh_number">8.8.8.8</span><span class="sh_default">;
    proxy_http_versi</span><span class="sh_keyword">on</span><span class="sh_default"> </span><span class="sh_number">1.1</span><span class="sh_default">;
    </span><span class="sh_function">proxy_pass</span><span class="sh_default"> </span><span class="sh_variable sh_label">$_url;</span><span class="sh_default">
}</span></code>
</pre>


<blockquote><p>This code ensures that the correct headers are set for the new request. The
<code>$_url</code> variable is used to store the target URL. It must be defined using
<code>set $_url ""</code> directive in your default location.</p></blockquote>

<p>Now we can use the <code>lapis.nginx.http</code> module. There are two methods. <code>request</code>
and <code>simple</code>. <code>request</code> implements the Lua Socket HTTP request API (complete
with LTN12).</p>

<p><code>simple</code> is a simplified API with no LTN12:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.nginx.http&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">get</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- a simple GET request</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status_code</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">simple</span><span class="sh_operator">(</span><span class="sh_string">&quot;http://leafo.net&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_comment">-- a post request, data table is form encoded and content-type is set to</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- application/x-www-form-urlencoded</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">simple</span><span class="sh_operator">(</span><span class="sh_string">&quot;http://leafo.net/&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_comment">-- manual invocation of the above request</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">simple</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">url</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;http://leafo.net&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">method</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_operator">[</span><span class="sh_string">&quot;content-type&quot;</span><span class="sh_operator">]</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;application/x-www-form-urlencoded&quot;</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">},</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">body</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
      </span><span class="sh_identifier">name</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">http</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.nginx.http&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_comment">-- a simple GET request</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">status_code</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">simple</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;http://leafo.net&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_comment">-- a post request, data table is form encoded and content-type is set to</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_comment">-- application/x-www-form-urlencoded</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">simple</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;http://leafo.net/&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_comment">-- manual invocation of the above request</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">http</span><span class="sh_operator">.</span><span class="sh_identifier">simple</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">url:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;http://leafo.net&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">method:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">headers:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_string">&quot;content-type&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;application/x-www-form-urlencoded&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">body:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;leafo&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<h3><a name="making-http-requests/http.simple" href="#making-http-requests/http.simple"><code>http.simple(req, body)</code></a></h3>

<p>Performs an HTTP request using the internal <code>/proxy</code> location.</p>

<p>Returns 3 values, the string result of the request, http status code, and a
table of headers.</p>

<p>If there is only one argument and it is a string then that argument is treated
as a URL for a GET request.</p>

<p>If there is a second argument it is set as the body of a POST request. If
the body is a table it is encoded with <code>encode_query_string</code> and the
<code>Content-type</code> header is set to <code>application/x-www-form-urlencoded</code></p>

<p>If the first argument is a table then it is used to manually set request
parameters. It takes the following keys:</p>

<ul>
<li><code>url</code> &mdash; the URL to request</li>
<li><code>method</code> &mdash; <code>"GET"</code>, <code>"POST"</code>, <code>"PUT"</code>, etc&hellip;</li>
<li><code>body</code> &mdash; string or table which is encoded</li>
<li><code>headers</code> &mdash; a table of request headers to set</li>
</ul>


<h3><a name="making-http-requests/http.request" href="#making-http-requests/http.request"><code>http.request(url_or_table, body)</code></a></h3>

<p>Implements a subset of <a href="http://w3.impa.br/%7Ediego/software/luasocket/http.html#request">Lua Socket&rsquo;s
<code>http.request</code></a>.</p>

<p>Does not support <code>proxy</code>, <code>create</code>, <code>step</code>, or <code>redirect</code>.</p>

<h2><a name="caching" href="#caching">Caching</a></h2>

<p>Lapis comes with a simple memory cache for caching the entire result of an
action keyed on the parameters it receives. This is useful for speeding up the
rendering of rarely changing pages because all database calls and HTML methods
can be skipped.</p>

<p>The Lapis cache uses the <a href="http://wiki.nginx.org/HttpLuaModule#lua_shared_dict">shared dictionary
API</a> from HttpLuaModule.
The first thing you'll need to do is create a shared dictionary in your Nginx
configuration.</p>

<p>Add the following to your <code>http</code> block to create a 15mb cache:</p>

<pre class="highlight lang_nginx"><code><span class="sh_function">lua_shared_dict</span><span class="sh_default"> page_cache </span><span class="sh_number">15</span><span class="sh_default">m;</span></code>
</pre>


<p>Now we are ready to start using the caching module, <code>lapis.cache</code>.</p>

<h3><a name="caching/cache.cached" href="#caching/cache.cached"><code>cache.cached(fn_or_tbl)</code></a></h3>

<p>Wraps an action to use the cache.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">cached</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;my_page&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello/world&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello world!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">[</span><span class="sh_tbl_key sh_regex">my_page:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello/world&quot;</span><span class="sh_symbol sh_embedded">]</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_string">&quot;hello world!&quot;</span></code>
</pre>


<p>The first request to <code>/hello/world</code> will run the action and store the result in
the cache, all subsequent requests will skip the action and return the text
stored in the cache.</p>

<p>The cache will remember not only the raw text output, but also the content
type and status code.</p>

<p>The cache key also takes into account any GET parameters, so a request to
<code>/hello/world?one=two</code> is stored in a separate cache slot. Multiple parameters
are sorted so they can come in any order and still match the same cache key.</p>

<p>When the cache is hit, a special response header is set to 1,
<code>x-memory-cache-hit</code>. This is useful for debugging your application to make
sure the cache is working.</p>

<p>Instead of passing a function as the action of the cache you can also pass in a
table. When passing in a table the function must be the first numerically
indexed item in the table.</p>

<p>The table supports the following options:</p>

<ul>
<li><code>dict_name</code> &mdash; override the name of the shared dictionary used (defaults to <code>"page_cache"</code>)</li>
<li><code>exptime</code> &mdash; how long in seconds the cache should stay alive, 0 is forever (defaults to <code>0</code>)</li>
<li><code>cache_key</code> &mdash; set a custom function for generating the cache key (default is described above)</li>
<li><code>when</code> &mdash; a function that should return truthy a value if the page should be cached. Receives the request object as first argument (defaults to <code>nil</code>)</li>
</ul>


<p>For example, you could implement microcaching, where the page is cached for a
short period of time, like so:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">cached</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/microcached&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">exptime</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello world!&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">}))</span><span class="sh_lua_whitespace sh_whitespace">
</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/microcached&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">cached</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">exptime:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;hello world!&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<h3><a name="caching/cache.delete" href="#caching/cache.delete"><code>cache.delete(key, [dict_name="page_cache"])</code></a></h3>

<p>Deletes an entry from the cache. Key can either be a plain string, or a tuple
of <code>{path, params}</code> that will be encoded as the key.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cache</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">cache</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_operator">({</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">thing</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world&quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">cache</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">cache</span><span class="sh_operator">.</span><span class="sh_identifier">delete</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">thing:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;world&quot;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<h3><a name="caching/cache.delete_all" href="#caching/cache.delete_all"><code>cache.delete_all([dict_name="page_cache"])</code></a></h3>

<p>Deletes all entries from the cache.</p>

<h3><a name="caching/cache.delete_path" href="#caching/cache.delete_path"><code>cache.delete_path(path, [dict_name="page_cache"])</code></a></h3>

<p>Deletes all entries for a specific path.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">cache</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_identifier">cache</span><span class="sh_operator">.</span><span class="sh_identifier">delete_path</span><span class="sh_operator">(</span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">cache</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.cache&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">cache</span><span class="sh_operator">.</span><span class="sh_identifier">delete_path</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello&quot;</span></code>
</pre>


<h2><a name="file-uploads" href="#file-uploads">File Uploads</a></h2>

<p>File uploads can be handled with a multipart form and accessing the file from
the <span class="for_moon"><code>@params</code></span><span
class="for_lua"><code>self.params</code></span> of the request.</p>

<p>For example, let&rsquo;s create the following form:</p>

<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Widget</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.html&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">MyForm</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Widget</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_tbl_key sh_regex">content:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">form</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">action:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">method:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;POST&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_tbl_key sh_regex">enctype:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;multipart/form-data&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;file&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">name:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;uploaded_file&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">input</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">type:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;submit&quot;</span></code>
</pre>


<p>When the form is submitted, the file is stored as a table with <code>filename</code> and
<code>content</code> properties in <span class="for_moon"><code>@params</code></span><span
class="for_lua"><code>self.params</code></span> under the name of the form input:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">post</span><span class="sh_operator">(</span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">file</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">uploaded_file</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">if</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">file</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">then</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Uploaded: &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">file</span><span class="sh_operator">.</span><span class="sh_identifier">filename</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;, &quot;</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">#</span><span class="sh_identifier">file</span><span class="sh_operator">.</span><span class="sh_identifier">content</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">..</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;bytes&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_keyword">if</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">file</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">uploaded_file</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_string">&quot;Uploaded #{file.filename}, #{#file.content}bytes&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span></code>
</pre>


<p>A validation exists for ensuring that a param is an uploaded file, it&rsquo;s called
<code>is_file</code>:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">post</span><span class="sh_operator">(</span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">assert_valid</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;uploaded_file&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">is_file</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_comment">-- file is ready to be used</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/my_action&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">capture_errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">assert_valid</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;uploaded_file&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">is_file:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_comment">-- file is ready to be used...</span></code>
</pre>


<p>An uploaded file is loaded entirely into memory, so you should be careful about
the memory requirements of your application. Nginx limits the size of uploads
through the
<a href="http://wiki.nginx.org/HttpCoreModule#client_max_body_size"><code>client_max_body_size</code></a>
directive. It&rsquo;s only 1 megabyte by default, so if you plan to allow uploads
greater than that you should set a new value in your Nginx configuration.</p>

<h2><a name="application-helpers" href="#application-helpers">Application Helpers</a></h2>

<p>The following functions are part of the <code>lapis.application</code> module:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app_helpers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">application</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span></code>
</pre>


<h3><a name="application-helpers/respond_to" href="#application-helpers/respond_to"><code>respond_to(verbs_to_fn={})</code></a></h3>

<p><code>verbs_to_fn</code> is a table of functions that maps a HTTP verb to a corresponding
function. Returns a new function that dispatches to the correct function in the
table based on the verb of the request. See
<a href="actions.html#handling-http-verbs">Handling HTTP verbs</a></p>

<p>If an action for <code>HEAD</code> does not exist Lapis inserts the following function to
render nothing:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">layout</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">layout:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">false</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<p>If the request is a verb that is not handled then the Lua <code>error</code> function
is called and a 500 page is generated.</p>

<p>A special <code>before</code> key can be set to a function that should run before any
other action. If <span class="for_moon"><code>@write</code></span><span
class="for_lua"><code>self.write</code></span> is called inside the before function then
the regular handler will not be called.</p>

<h3><a name="application-helpers/capture_errors" href="#application-helpers/capture_errors"><code>capture_errors(fn_or_tbl)</code></a></h3>

<p>Wraps a function to catch errors sent by <code>yield_error</code> or <code>assert_error</code>. See
<a href="exception_handling.html">Exception Handling</a> for more information.</p>

<p>If the first argument is a function then that function is called on request and
the following default error handler is used:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">render</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">render:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">true</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<p>If a table is the first argument then the <code>1</code>st element of the table is used as
the action and value of <code>on_error</code> is used as the error handler.</p>

<p>When an error is yielded then the <span class="for_moon"><code>@errors</code></span><span
class="for_lua"><code>self.errors</code></span> variable is set on the current request and
the error handler is called.</p>

<h3><a name="application-helpers/capture_errors_json" href="#application-helpers/capture_errors_json"><code>capture_errors_json(fn)</code></a></h3>

<p>A wrapper for <code>capture_errors</code> that passes in the following error handler:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">json</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">errors</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">json:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">errors:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_self_ref sh_label">@errors</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<h3><a name="application-helpers/yield_error" href="#application-helpers/yield_error"><code>yield_error(error_message)</code></a></h3>

<p>Yields a single error message to be captured by <code>capture_errors</code></p>

<h3><a name="application-helpers/obj" href="#application-helpers/obj"><code>obj, msg, ... = assert_error(obj, msg, ...)</code></a></h3>

<p>Works like Lua&rsquo;s <code>assert</code> but instead of triggering a Lua error it triggers an
error to be captured by <code>capture_errors</code></p>

<h3><a name="application-helpers/json_params" href="#application-helpers/json_params"><code>json_params(fn)</code></a></h3>

<p>Return a new function that will parse the body of the request as JSON and
inject it into <code class="for_moon">@params</code><code class="for_lua">self.params</code> if the <code>content-type</code> is set to
<code>application/json</code>. Suitable for wrapping an action handler to make it aware of
JSON encoded requests.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">json_params</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">json_params</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/json&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">json_params</span><span class="sh_operator">(</span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">self</span><span class="sh_operator">.</span><span class="sh_identifier">params</span><span class="sh_operator">.</span><span class="sh_identifier">value</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">json_params</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">JsonApp</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/json&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">json_params</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_self_ref sh_label">@params</span><span class="sh_operator">.</span><span class="sh_identifier">value</span></code>
</pre>


<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">curl</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_default">\</span><span class="sh_bash_whitespace sh_whitespace">
  </span><span class="sh_operator">-</span><span class="sh_identifier">H</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_string">&quot;Content-type: application/json&quot;</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_default">\</span><span class="sh_bash_whitespace sh_whitespace">
  </span><span class="sh_keyword">-d</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_string">&#x27;{&quot;value&quot;: &quot;hello&quot;}&#x27;</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_default">\</span><span class="sh_bash_whitespace sh_whitespace">
  </span><span class="sh_string">&#x27;https://localhost:8080/json&#x27;</span></code>
</pre>


<p>The unmerged parameters can also be accessed from <code class="for_moon">@json</code><code class="for_lua">self.json</code>. If there
was an error parsing the JSON then <code class="for_moon">@json</code><code class="for_lua">self.json</code> will be <code>nil</code> and the
request will continue without error.</p>

<h2><a name="utf8" href="#utf8">UTF8</a></h2>

<p>This module includes a collection of LPeg patterns for working with UTF8 text.</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_library sh_type">utf8</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">requrie</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.util.utf8&quot;</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_library sh_type">utf8</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">requrie</span><span class="sh_symbol sh_embedded">(</span><span class="sh_string">&quot;lapis.util.utf8&quot;</span><span class="sh_symbol sh_embedded">)</span></code>
</pre>
</div>

</p>

<h3><a name="utf8/utf8.trim" href="#utf8/utf8.trim"><code>utf8.trim</code></a></h3>

<p>A pattern that will trim all invisible characters from either side of the
matched string. (Utilizes the <code>whitespace</code> pattern described below)</p>

<h3><a name="utf8/utf8.printable_character" href="#utf8/utf8.printable_character"><code>utf8.printable_character</code></a></h3>

<p>A pattern that matches a single printable character. Note that printable
characters include whitepace, but don&rsquo;t include invalid unicode codepoints or
control characters.</p>

<h3><a name="utf8/utf8.whitepace" href="#utf8/utf8.whitepace"><code>utf8.whitepace</code></a></h3>

<p>An optimal pattern that matches any unicode codepoints that are classified as
whitespace.</p>

      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Mon Jan  9 21:25:16 2023"></script>
  <script type="text/javascript" src="../reference.js?Mon Jan  9 21:25:16 2023"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
