<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Testing - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Oct  6 22:56:41 2023" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.15.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Testing</h2>
            <ul><li><a href="#mocking-a-request">Mocking a Request</a></li>
<ul><li><a href="#mocking-a-request/using-the-test-environment">Using the <code>test</code> Environment</a></li></ul>
<li><a href="#using-the-test-server">Using the Test Server</a></li>
<ul><li><a href="#using-the-test-server/request"><code>request(path, options={})</code></a></li>
<li><a href="#using-the-test-server/get_current_server"><code>get_current_server()</code></a></li></ul>
<li><a href="#test-strategies">Test Strategies</a></li>
<ul><li><a href="#test-strategies/working-with-models">Working with Models</a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Testing <span data-keywords="spec"></span></h1>

<p>Lapis comes with modes of executing tests:</p>

<p><strong>Request mocking:</strong> Mocking a request simulates a HTTP request
to your application, bypassing any real HTTP requests and Nginx. The advantage
of this method is that it&rsquo;s faster and errors happen within the test process.</p>

<p><strong>Test Server:</strong> A temporary Nginx server is spawned for the duration of your
tests that allows you to issue full HTTP requests. The advantage of this method
is you can perform full integration tests across both your Nginx configuration
and your application code. Your application code also has full access to the
<code>ngx.*</code> Lua API. It very closely resembles how your application will run in
production.</p>

<p>Both modes support using a separate database connection via the <code>test</code>
environment for writing tests for your models.</p>

<p>You are free to use any testing framework you like, but in these examples we'll
be using <a href="http://olivinelabs.com/busted/">Busted</a>.</p>

<blockquote><p>Lapis will detect when it is running in Busted and enable the test
environment accordingly. If you are using any other test library it is your
responsibility to ensure you have enabled the test environment or you may
risk data loss in you development database.</p></blockquote>

<h2><a name="mocking-a-request" href="#mocking-a-request">Mocking a Request</a></h2>

<p>In order to test your application it should be a Lua module that can be
<code>require</code>d without any side effects. Ideally you'll have a separate file for
each application and you can get the application class just by loading the
module.</p>

<p>In these examples we'll define the application in the same file as the tests
for simplicity.</p>

<p>A request can be mocked using the <code>mock_request</code> function defined in
<code>lapis.spec.request</code>:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.spec.request&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">mock_request</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_operator">(</span><span class="sh_identifier">app</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">url</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">options</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.spec.request&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">status</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_symbol sh_embedded">(</span><span class="sh_identifier">app</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">url</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">options</span><span class="sh_symbol sh_embedded">)</span></code>
</pre>


<p>For example, to test a basic application with <a href="http://olivinelabs.com/busted/">Busted</a> we could do:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.application&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.spec.request&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">mock_request</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">app</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_identifier">Application</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">app</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">(</span><span class="sh_identifier">self</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;welcome to my page&quot;</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">describe</span><span class="sh_operator">(</span><span class="sh_string">&quot;my application&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">it</span><span class="sh_operator">(</span><span class="sh_string">&quot;should make a request&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_operator">(</span><span class="sh_identifier">app</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

    </span><span class="sh_function">assert</span><span class="sh_operator">.</span><span class="sh_identifier">same</span><span class="sh_operator">(</span><span class="sh_number">200</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_function">assert</span><span class="sh_operator">.</span><span class="sh_identifier">truthy</span><span class="sh_operator">(</span><span class="sh_identifier">body</span><span class="sh_operator">:</span><span class="sh_identifier">match</span><span class="sh_operator">(</span><span class="sh_string">&quot;welcome&quot;</span><span class="sh_operator">))</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">lapis</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.spec.request&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_keyword">class</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">extends</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_operator">.</span><span class="sh_proper_ident sh_class">Application</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_operator">:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">=&gt;</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;welcome to my page&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">describe</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my application&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">it</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;should make a request&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">status</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">App</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/hello&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_function">assert</span><span class="sh_operator">.</span><span class="sh_identifier">same</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">200</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_function">assert</span><span class="sh_operator">.</span><span class="sh_identifier">truthy</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_operator">\</span><span class="sh_identifier">match</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;welcome&quot;</span></code>
</pre>


<p><code>mock_request</code> simulates an <code>ngx</code> variable from the Lua Nginx module and
executes the application. The <code>options</code> argument of <code>mock_request</code> can be used
to control the kind of request that is simulated. It takes the following
options in a table:</p>

<ul>
<li><code>get</code> &mdash;  A table of GET parameters to add to the url</li>
<li><code>post</code> &mdash; A table of POST parameters (sets default method to <code>"POST"</code>)</li>
<li><code>method</code> &mdash; The HTTP method to use (defaults to <code>"GET"</code>)</li>
<li><code>headers</code> &mdash; Additional HTTP request headers</li>
<li><code>cookies</code> &mdash; A table of cookies to insert into headers</li>
<li><code>session</code> &mdash; A session table to encode into the cookies</li>
<li><code>host</code> &mdash; The host the mocked server (defaults to <code>"localhost"</code>)</li>
<li><code>port</code> &mdash; The port of the mocked server (defaults to <code>80</code>)</li>
<li><code>scheme</code> &mdash; The scheme of the mocked server (defaults to <code>"http"</code>)</li>
<li><code>prev</code> &mdash; A table of the response headers from a previous <code>mock_request</code></li>
<li><code>allow_error</code> &mdash; Don&rsquo;t automatically convert 500 server errors into Lua errors (defaults to <code>false</code>)</li>
</ul>


<p>If you want to simulate a series of requests that use persistant data like
cookies or sessions you can use the <code>prev</code> option in the table. It takes the
headers returned from a previous request.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">r1_status</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">r1_res</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">r1_headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_operator">(</span><span class="sh_identifier">my_app</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/first_url&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">r2_status</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">r2_res</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_operator">(</span><span class="sh_identifier">my_app</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/second_url&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">prev</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">r1_headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_identifier">r1_status</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">r1_res</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">r1_headers</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">MyApp</span><span class="sh_operator">!,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/first_url&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">r2_status</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">r2_res</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">mock_request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">MyApp</span><span class="sh_operator">!,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/second_url&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_tbl_key sh_regex">prev:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">r1_headers</span></code>
</pre>


<h3><a name="mocking-a-request/using-the-test-environment" href="#mocking-a-request/using-the-test-environment">Using the <code>test</code> Environment</a></h3>

<p>When using a supported testing tool, like <a href="http://olivinelabs.com/busted/">Busted</a>, Lapis will automatically
detect that it is running within a test runner and change the default
environment to one called <em><code>test</code></em>.</p>

<p>The <code>test</code> environment will allow you to write a distinct configuration to be
used when tests are running. It is highly recommended to set up a distinct
database for your test suite to ensure that none of your working data is reset
when running tests, as a copy pattern is to truncate all data from a table
before running any tests that use that table.</p>

<p>You can add a configuration environment with separate database rules by editing
your <span class="for_moon"><code>config.moon</code></span><span
class="for_lua"><code>config.lua</code></span>:</p>

<blockquote><p>Read more about configurations on the <a href="../reference/configuration.html">Configuration and
Environments guide</a>, and more about
setting up a database on the <a href="../reference/configuration.html">Database guide</a>.</p></blockquote>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">config</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_comment">-- other configuration ...</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">config</span><span class="sh_operator">(</span><span class="sh_string">&quot;test&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">postgres</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">{</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">backend</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;pgmoon&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">database</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;myapp_test&quot;</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_operator">}</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_operator">})</span><span class="sh_lua_whitespace sh_whitespace">
</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_comment">-- config.moon</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.config&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_comment">-- other configuration ...</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">config</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;test&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">postgres</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">backend:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;pgmoon&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_tbl_key sh_regex">database:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;myapp_test&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_symbol sh_embedded">}</span></code>
</pre>


<blockquote><p>Don&rsquo;t forget to initialize your test database by creating it and its schema
before running the tests.</p></blockquote>

<h2><a name="using-the-test-server" href="#using-the-test-server">Using the Test Server</a></h2>

<p>While mocking a request is useful, it doesn&rsquo;t give you access to the entire
stack that your application uses. For that reason you can spawn up a <em>test</em>
server which you can issue real HTTP requests to.</p>

<p>It&rsquo;s important to realize that when using the test server there are actually
<em>at least two</em> Lua runtimes executing your code:</p>

<ol>
<li>The foreground process running the test suite</li>
<li>The <code>nginx</code> server&rsquo;s Lua runtime &mdash; If you have multiple workers enabled, then there can be multiple concurrent Lua runtimes. It&rsquo;s recommended to set <code>worker_processes</code> to <code>1</code> in the test environment.</li>
</ol>


<p>This is an important distinction to pay attention to because any changes you
make to in-memory data in one runtime will not be seen in the other. Changes
you make to the database would be accessible to both though, as they would both
use the same configuration to connect to the same database.</p>

<p>Any <code>stub</code> or similar functions provided by your test suite will be unable to
change any code running in the server.</p>

<blockquote><p>Both runtimes have their Lapis environment set to<code>test</code>  to ensure that they
each load the same configuration.</p>

<p>There can only be one test server running at any time, meaning you can not
parallelize your tests if you attempt to spawn multiple processes.</p></blockquote>

<p>The <code>use_test_server</code> function will ensure that the test server is running for
the duration of the specs within the block:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">use_test_server</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.spec&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">use_test_server</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">describe</span><span class="sh_operator">(</span><span class="sh_string">&quot;my site&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">use_test_server</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_comment">-- write some tests that use the server here</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">use_test_server</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.spec&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">describe</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_site&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">use_test_server</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_comment">-- write some tests that use the server here</span></code>
</pre>


<p>The test server will either spawn a new Nginx if one isn&rsquo;t running, or it will
take over your development server until <code>close_test_server</code> is called 
(<code>use_test_server</code> automatically calls that for you, but you can call it manually
if you wish). Taking over the development server can be useful because the same 
stdout is used, so any output from the server is written to a terminal you might 
already have open.</p>

<h3><a name="using-the-test-server/request" href="#using-the-test-server/request"><code>request(path, options={})</code></a></h3>

<p>To make HTTP request to the test server you can use the helper function
<code>request</code> found in <code>"lapis.spec.server"</code>. For example we might write a test to
make sure <code>/</code> loads without errors:</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">request</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.spec.server&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">request</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">use_test_server</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.spec&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">use_test_server</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">describe</span><span class="sh_operator">(</span><span class="sh_string">&quot;my site&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">use_test_server</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_identifier">it</span><span class="sh_operator">(</span><span class="sh_string">&quot;should load /&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">request</span><span class="sh_operator">(</span><span class="sh_string">&quot;/&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_function">assert</span><span class="sh_operator">.</span><span class="sh_identifier">same</span><span class="sh_operator">(</span><span class="sh_number">200</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">use_test_server</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.spec&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.spec.server&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">describe</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_site&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">use_test_server</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_identifier">it</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;should load /&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">status</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">body</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">headers</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">request</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;/&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_function">assert</span><span class="sh_operator">.</span><span class="sh_identifier">same</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">200</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">status</span><span class="sh_moonscript_whitespace sh_whitespace">
</span></code>
</pre>


<p><code>path</code> is either a path or a full URL to request against the test server. If it
is a full URL then the hostname of the URL is extracted and inserted as the
<code>Host</code> header.</p>

<p>The <code>options</code> argument can be used to further configure the request. It
supports the following options in the table:</p>

<ul>
<li><code>post</code> &mdash; A table of POST parameters. Sets default method to <code>"POST"</code>,
encodes the table as the body of the request and sets the <code>Content-type</code>
header to <code>application/x-www-form-urlencoded</code></li>
<li><code>data</code> &mdash; The body of the HTTP request as a string. The <code>Content-length</code> header is automatically set to the length of the string</li>
<li><code>method</code> &mdash; The HTTP method to use (defaults to <code>"GET"</code>)</li>
<li><code>headers</code> &mdash; Additional HTTP request headers</li>
<li><code>expect</code> &mdash; What type of response to expect, currently only supports
<code>"json"</code>. It will parse the body automatically into a Lua table or throw an
error if the body is not valid JSON.</li>
<li><code>port</code> &mdash; The port of the server, defaults to the randomly assigned port defined automatically when running tests</li>
</ul>


<p>The function has three return values: the status code as a number, the body of
the response and any response headers in a table.</p>

<h3><a name="using-the-test-server/get_current_server" href="#using-the-test-server/get_current_server"><code>get_current_server()</code></a></h3>

<p>Returns the currently attached test server. This will provide a handle to the
server that enables you to execute code within that process.</p>

<p>The <code>exec</code> method will execute Lua code on the server.</p>

<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">get_current_server</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.spec.server&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">get_current_server</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">use_test_server</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.spec&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">use_test_server</span><span class="sh_lua_whitespace sh_whitespace">

</span><span class="sh_identifier">describe</span><span class="sh_operator">(</span><span class="sh_string">&quot;my site&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_identifier">use_test_server</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">

  </span><span class="sh_identifier">it</span><span class="sh_operator">(</span><span class="sh_string">&quot;runs code on server&quot;</span><span class="sh_operator">,</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_keyword">function</span><span class="sh_operator">()</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">server</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">assert</span><span class="sh_operator">(</span><span class="sh_identifier">get_current_server</span><span class="sh_operator">())</span><span class="sh_lua_whitespace sh_whitespace">
    </span><span class="sh_identifier">server</span><span class="sh_operator">:</span><span class="sh_identifier">exec</span><span class="sh_operator">(</span><span class="sh_longstring sh_string">[[
      require(&quot;myapp&quot;).some_variable = 100
    ]]</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
  </span><span class="sh_keyword">end</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">end</span><span class="sh_operator">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">use_test_server</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.spec&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">get_current_server</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.spec.server&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">describe</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;my_site&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_identifier">use_test_server</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_identifier">it</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;runs code on server&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">server</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">assert</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">get_current_server</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">server</span><span class="sh_operator">\</span><span class="sh_identifier">exec</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_longstring sh_string">[[
      require(&quot;myapp&quot;).some_variable = 100
    ]]</span></code>
</pre>


<h2><a name="test-strategies" href="#test-strategies">Test Strategies</a></h2>

<h3><a name="test-strategies/working-with-models" href="#test-strategies/working-with-models">Working with Models</a></h3>

<p>When writing tests that work with your models it&rsquo;s useful to have a separate
test database where data can reset and generated to unit test model
functionality. By having a functioning database connection you can perform full
integration testing across your application code and the database, ensuring
that it works as intended.</p>

<p>The typical strategy is:</p>

<ul>
<li>Before every test, truncate the tables of the models that are accessed by the code that will run in the test</li>
<li>Within your test suite:

<ul>
<li>Use a <em>factory</em> function to create any rows that may be needed for an initial state</li>
<li>Perform your tests using the models as you would in your application</li>
</ul>
</li>
</ul>


<p>Because truncating tables is a common operation, Lapis provides a
<code>truncate_tables</code> function:</p>

<blockquote><p>Truncate tables will <strong>delete</strong> all the data in the respective
table, with no way to get it back. Because this is a dangerous operation it
will only run when the current environment is named <code>test</code></p></blockquote>

<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">truncate_tables</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.spec.db&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

</span><span class="sh_identifier">describe</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;User profiles&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
  </span><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Profiles</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;models&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_identifier">before_each</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">truncate_tables</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_proper_ident sh_class">Profiles</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_identifier">user_factory</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">do</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">user_counter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">0</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_identifier">user_counter</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">+=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_number">1</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_proper_ident sh_class">Users</span><span class="sh_operator">\</span><span class="sh_identifier">create</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_symbol sh_embedded">{</span><span class="sh_moonscript_whitespace sh_whitespace">
        </span><span class="sh_tbl_key sh_regex">login:</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user-#{user_counter}&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
      </span><span class="sh_symbol sh_embedded">}</span><span class="sh_moonscript_whitespace sh_whitespace">

  </span><span class="sh_identifier">it</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;fetches or creates the user&#x27;s profile&quot;</span><span class="sh_operator">,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_fndef sh_preprocessor">-&gt;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">user1</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">user_factory</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_identifier">user2</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">user_factory</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_identifier">user1</span><span class="sh_operator">\</span><span class="sh_identifier">create_profile_if_necessary</span><span class="sh_operator">!</span><span class="sh_moonscript_whitespace sh_whitespace">

    </span><span class="sh_function">assert</span><span class="sh_operator">.</span><span class="sh_identifier">truthy</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">user1</span><span class="sh_operator">\</span><span class="sh_identifier">get_profile</span><span class="sh_operator">!,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user1 should have a profile&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
    </span><span class="sh_function">assert</span><span class="sh_operator">.</span><span class="sh_keyword">nil</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">user2</span><span class="sh_operator">\</span><span class="sh_identifier">get_profile</span><span class="sh_operator">!,</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;user2 should not have a profile&quot;</span></code>
</pre>


<p>Because some models might have <em>unique indexes</em> on certain fields, like <code>login</code>
on the User model above, we can use the <em>counter</em> pattern to ensure that our
factory function generates a new User row without conflict.</p>

<p>If you have many factories that you re-use across different test files, it can
be helpful to put it into a separate module that you can <code>require</code> into your
tests as needed.</p>

      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Oct  6 22:56:41 2023"></script>
  <script type="text/javascript" src="../reference.js?Fri Oct  6 22:56:41 2023"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
